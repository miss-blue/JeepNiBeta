<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi â€“ Watch Ads</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --bg: rgba(255,255,255,.86); --blue:#39b5f6; --blue2:#2fa2eb; --muted:#7b8a9b; --shadow: 0 20px 40px rgba(0,0,0,.18); }
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: url('icons/Background1.png') center bottom / cover no-repeat, linear-gradient(180deg,#cfefff,#f6fbff); }
    .safe{ padding: 16px; max-width: 480px; margin: 0 auto; }
    .back{ position: fixed; top: 14px; left: 14px; z-index: 2; width:42px; height:42px; border-radius:10px; border:none; background: var(--bg); box-shadow: var(--shadow); display:grid; place-items:center }
    .wallet{ position: fixed; top: 14px; right: 14px; z-index: 2; background: var(--bg); padding: 8px 12px; border-radius: 12px; box-shadow: var(--shadow); display:flex; align-items:center; gap:10px }
    .wallet .count{ font-weight: 800; font-size: 18px }
    .timer{ font-weight:700; color:#2b4c7e; background: var(--bg); padding:8px 10px; border-radius:10px; margin-left:6px; box-shadow: var(--shadow) }
    .panel{ margin-top:84px; padding-bottom:18px }
    .cardx{ background: rgba(255,255,255,.96); border-radius: 16px; box-shadow: var(--shadow); padding: 14px; margin-bottom: 14px }
    .cardx .title{ font-family: "Trebuchet MS", system-ui; font-weight: 900; font-size: 22px; letter-spacing: 1px; text-transform: uppercase; text-align:center; margin: 4px 0 8px }
    .pill{ display:inline-flex; align-items:center; gap:8px; background: #eef6ff; border-radius:10px; padding:8px 10px; color:#234 }
    .btn-watch{ background: linear-gradient(180deg,#8be3ff,#35a8f0); border:none; color:#fff; font-weight:800; border-radius: 10px; padding: 10px 14px }
    .btn-buy{ background: linear-gradient(180deg,#7bdf9a,#22c55e); border:none; color:#fff; font-weight:800; border-radius: 10px; padding: 10px 14px; width: 160px }
    .btn-locked{ background:#9aa4ad; color:#fff; border:none; border-radius:10px; padding:10px 14px; cursor:not-allowed }
    .rowx{ display:flex; align-items:center; justify-content:space-between; gap:12px }
    .left{ display:flex; align-items:center; gap:12px }
    .coin{ width:42px; height:42px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffe082, #f3b300); display:grid; place-items:center; color:#7b4d0f; font-weight:900 }
    .subtitle{ color: var(--muted); font-size: 12px; margin-top: 2px }
    /* bottom nav shared with wallet/dashboard */
    .app-nav{ position:fixed; left:0; right:0; bottom:0; height:84px; z-index:10; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.95)); backdrop-filter:blur(8px); border-top:1px solid rgba(0,0,0,.06); display:grid; grid-template-columns:1fr 1fr 72px 1fr 1fr; align-items:center; }
    .app-nav a{ text-decoration:none; color:#6b7b8a; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0 }
    .app-nav a .bi{ font-size:20px }
    .home-fab{ position:absolute; left:50%; transform:translateX(-50%); bottom:22px; width:64px; height:64px; border-radius:50%; background:linear-gradient(180deg,#8be3ff,#35a8f0); color:#fff; display:grid; place-items:center; box-shadow:0 16px 32px rgba(0,0,0,.25); border:4px solid #fff }
    .active{ color:#2a476a !important; font-weight:800 }
    .app-nav .center-slot{ width:72px; height:1px }
  </style>
</head>
<body>
  <a class="back" href="passenger-dashboard.html" aria-label="Back"><i class="bi bi-chevron-left fs-5"></i></a>
  <div class="wallet">
    <div class="coin"><i class="bi bi-coin"></i></div>
    <div class="count" id="coinCount">0</div>
    <div class="timer" id="cooldown">23:00:05</div>
  </div>

  <main class="safe" style="padding-bottom:110px">
    <section class="panel">
      <div class="cardx">
        <div class="title">Special Pack</div>
        <div class="rowx mb-2">
          <span class="pill"><i class="bi bi-coin"></i> +2000</span>
          <span class="pill"><i class="bi bi-ticket-perforated"></i> 10</span>
        </div>
        <div class="text-center"><button class="btn-buy" id="btnBuy">Use</button></div>
      </div>

      <!-- Repeated rows with Watch buttons -->
      <div class="cardx">
        <div class="rowx">
          <div class="left"><div class="coin"><i class="bi bi-coin"></i></div><div><div class="fw-bold">+5</div><div class="subtitle">Watch an ad to earn</div></div></div>
          <button class="btn-watch" data-watch>Watch</button>
        </div>
      </div>
      <div class="cardx">
        <div class="rowx">
          <div class="left"><div class="coin"><i class="bi bi-coin"></i></div><div><div class="fw-bold">+5</div><div class="subtitle">Watch an ad to earn</div></div></div>
          <button class="btn-watch" data-watch>Watch</button>
        </div>
      </div>
      <!-- Locked examples -->
      <div class="cardx"><div class="rowx"><div class="left"><div class="coin"><i class="bi bi-coin"></i></div><div><div class="fw-bold">+10</div><div class="subtitle">Locked</div></div></div><button class="btn-locked" disabled><i class="bi bi-lock"></i></button></div></div>
      <div class="cardx"><div class="rowx"><div class="left"><div class="coin"><i class="bi bi-coin"></i></div><div><div class="fw-bold">+10</div><div class="subtitle">Locked</div></div></div><button class="btn-locked" disabled><i class="bi bi-lock"></i></button></div></div>
      <div class="cardx"><div class="rowx"><div class="left"><div class="coin"><i class="bi bi-coin"></i></div><div><div class="fw-bold">+50</div><div class="subtitle">Locked</div></div></div><button class="btn-locked" disabled><i class="bi bi-lock"></i></button></div></div>
    </section>
  </main>
  <!-- Bottom navigation bar -->
  <nav class="app-nav">
    <a href="destination.html" aria-label="Destination" style="grid-column:1"><i class="bi bi-geo-alt"></i><span>Destination</span></a>
    <a href="watch-ads.html" aria-label="Watch Ads" class="active" style="grid-column:2"><i class="bi bi-camera-reels"></i><span>Watch Ads</span></a>
    <span class="center-slot" aria-hidden="true" style="grid-column:3"></span>
    <a href="wallet.html" aria-label="Wallet" style="grid-column:4"><i class="bi bi-wallet2"></i><span>Wallet</span></a>
    <a href="my-profile.html" aria-label="Profile" style="grid-column:5"><i class="bi bi-person"></i><span>Profile</span></a>
    <a href="passenger-dashboard.html" class="home-fab" aria-label="Home"><i class="bi bi-house-door fs-3"></i></a>
  </nav>

  <!-- Modal for no ads available -->
  <div class="modal fade" id="adsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">No Ads Available</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
          <p>There are currently no ads to watch. Please check back later.</p>
        </div>
        <div class="modal-footer"><button class="btn btn-primary" data-bs-dismiss="modal">Okay</button></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { auth, db, ref, runTransaction, onValue, requireLogin } from './js/authentication.js';
    const user = await requireLogin('login.html');
    const uid = user.uid;
    // Store wallet under the user's profile to satisfy RTDB rules
    const balRef = ref(db, `all_users/${uid}/wallet`);

    const coinEl = document.getElementById('coinCount');
    const useBtn = document.getElementById('btnBuy');
    const PACK_COINS = 2000; // Special Pack value
    onValue(balRef, (snap)=>{ const v = snap.exists()? snap.val():0; coinEl.textContent = String(v); if (useBtn) useBtn.textContent = `Use ${v} coins`; });

    // Credit the pack amount to user wallet
    useBtn?.addEventListener('click', async ()=>{
        await runTransaction(balRef, (curr)=> {
          const n = (Number(curr)||0) + PACK_COINS;
          return n < 0 ? 0 : n;
        });
      try { alert('+2000 coins added to your balance.'); } catch {}
    });

    // Bind all watch buttons to show the modal for now
    const modal = new bootstrap.Modal(document.getElementById('adsModal'));
    document.querySelectorAll('[data-watch]')?.forEach(btn=>{
      btn.addEventListener('click', async ()=> {
        // In a real app, verify ad view completion server-side before crediting
        await runTransaction(balRef, (curr)=> {
          const n = (Number(curr)||0) + 5;
          return n < 0 ? 0 : n;
        });
        modal.show();
      });
    });

    // Fake cooldown timer starting at 23h 00m 05s
    const cd = document.getElementById('cooldown');
    let seconds = 23*3600 + 5;
    setInterval(()=>{
      seconds = Math.max(0, seconds-1);
      const h = String(Math.floor(seconds/3600)).padStart(2,'0');
      const m = String(Math.floor((seconds%3600)/60)).padStart(2,'0');
      const s = String(seconds%60).padStart(2,'0');
      cd.textContent = `${h}:${m}:${s}`;
    },1000);
  </script>
</body>
</html>
