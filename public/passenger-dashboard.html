<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi - Passenger Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
  <link rel="stylesheet" href="/css/passenger-dashboard.css">
  <link rel="icon" href="/icons/JEEPNi.png" type="image/png">
</head>
<body>
<nav class="navbar navbar-light py-3">
  <div class="container d-flex align-items-center gap-3 flex-wrap">
    <span class="navbar-brand d-flex align-items-center gap-2">
      <i class="bi bi-geo-alt-fill"></i>
      JeepNi - Passenger Dashboard
    </span>
    <div class="ms-auto d-flex align-items-center gap-3 flex-wrap">
      <span class="small text-light">Signed in as <span id="whoami" class="fw-semibold text-light">Loading...</span></span>
      <a href="my-profile.html" class="btn btn-outline-light btn-sm">My Profile</a>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<main class="dashboard-shell" aria-label="Passenger map">
  <div id="map" role="presentation"></div>
  <div id="arrivalNotice" class="arrival-notice" role="status" aria-live="polite" hidden>
    <div class="arrival-notice__icon" aria-hidden="true"><i class="bi bi-check-circle-fill"></i></div>
    <div class="arrival-notice__message">You are in the perimeter of your destination.</div>
    <button type="button" class="arrival-notice__close" id="arrivalNoticeClose" aria-label="Dismiss arrival message"><i class="bi bi-x-lg"></i></button>
  </div>
  <aside class="control-panel" aria-label="Passenger controls">
    <div class="control-panel__inner">
      <div id="waitingCard" class="control-block control-block--passengers" role="group" aria-label="Passengers with you">
        <span class="control-eyebrow">Passengers With You</span>
        <div class="passenger-counter">
          <button type="button" class="counter-button" id="btnWaitingMinus" aria-label="Decrease passenger count"><i class="bi bi-dash-lg"></i></button>
          <input type="number" min="1" max="99" inputmode="numeric" pattern="[0-9]*" class="counter-input" id="waitingCountInput" aria-label="Passenger count">
          <button type="button" class="counter-button" id="btnWaitingPlus" aria-label="Increase passenger count"><i class="bi bi-plus-lg"></i></button>
        </div>
        <button type="button" class="ghost-button" id="btnWaitingJustMe">Just me</button>
      </div>
      <div class="control-block control-block--actions">
        <span class="control-eyebrow">Trip Controls</span>
        <button id="btnPassengerStart" class="panel-button panel-button--start">
          <i class="bi bi-play-fill"></i>
          <span>Start Tracking</span>
        </button>
        <button id="btnPassengerStop" class="panel-button panel-button--stop">
          <i class="bi bi-stop-fill"></i>
          <span>Stop Tracking</span>
        </button>
      </div>
      <div class="control-block control-block--destinations">
        <span class="control-eyebrow">Suggested Stops</span>
        <div class="destination-list" role="list">
          <button type="button" class="destination-item" data-destination="Saint Gabriel The Archangel Parish" data-lat="16.0754843" data-lng="120.3546182">
            <i class="bi bi-geo-alt-fill" aria-hidden="true"></i>
            <span>
              <strong>Saint Gabriel The Archangel Parish</strong>
              <small>Religious stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Alip, Boquig Waiting Shed" data-lat="16.073742" data-lng="120.351614">
            <i class="bi bi-people-fill" aria-hidden="true"></i>
            <span>
              <strong>Alip, Boquig Waiting Shed</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Bonuan Boquig, Baranggay Hall" data-lat="16.076286" data-lng="120.3557308">
            <i class="bi bi-building" aria-hidden="true"></i>
            <span>
              <strong>Bonuan Boquig, Baranggay Hall</strong>
              <small>Government stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Sagor, Longos" data-lat="16.066106" data-lng="120.353298">
            <i class="bi bi-pin-map-fill" aria-hidden="true"></i>
            <span>
              <strong>Sagor, Longos</strong>
              <small>Mixed area</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Centro, Longos" data-lat="16.070591" data-lng="120.359635">
            <i class="bi bi-pin-map-fill" aria-hidden="true"></i>
            <span>
              <strong>Centro, Longos</strong>
              <small>Mixed area</small>
             </span>
          </button>
          <button type="button" class="destination-item" data-destination="Don Leon Francisco Maramba Elementary School, Longos" data-lat="16.0710835" data-lng="120.3591833">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>
              <strong>Don Leon Francisco Maramba Elementary School, Longos</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Bonuan Boquig - Biazon Waiting Shed" data-lat="16.0756322" data-lng="120.3656381">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>
              <strong>Bonuan Boquig - Biazon Waiting Shed</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Bonuan Buquig National Highschool" data-lat="16.078721" data-lng="120.360024">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>
              <strong>Bonuan Buquig National Highschool</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="7 Eleven Bonuan" data-lat="16.075331" data-lng="120.342945">
            <i class="bi bi-shop-window" aria-hidden="true"></i>
            <span>
              <strong>7 Eleven Bonuan</strong>
              <small>Commercial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="North Central, Don Marcelo Elementary School" data-lat="16.073780" data-lng="120.340295">
            <i class="bi bi-mortarboard-fill" aria-hidden="true"></i>
            <span>
              <strong>North Central, Don Marcelo Elementary School</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="MCDo Bonuan" data-lat="16.0722655" data-lng="120.3386216">
            <i class="bi bi-shop-window" aria-hidden="true"></i>
            <span>
              <strong>MCDo Bonuan</strong>
              <small>Commercial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Nepo Mall" data-lat="16.0511218" data-lng="120.3408555">
            <i class="bi bi-cart-fill" aria-hidden="true"></i>
            <span>
              <strong>Nepo Mall</strong>
              <small>Commercial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Universidad De Dagupan" data-lat="16.0511218" data-lng="120.3408555">
            <i class="bi bi-building-fill" aria-hidden="true"></i>
            <span>
              <strong>Universidad De Dagupan</strong>
              <small>University stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Junction" data-lat="16.046392" data-lng="120.343012">
            <i class="bi bi-signpost-2-fill" aria-hidden="true"></i>
            <span>
              <strong>Junction</strong>
              <small>Transport hub</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Region 1 Medical Center" data-lat="16.048645" data-lng="120.341774">
            <i class="bi bi-hospital-fill" aria-hidden="true"></i>
            <span>
              <strong>Region 1 Medical Center</strong>
              <small>Medical stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Phinma-University of Pangasinan" data-lat="16.046392" data-lng="120.343012">
            <i class="bi bi-building-fill" aria-hidden="true"></i>
            <span>
              <strong>Phinma-University of Pangasinan</strong>
              <small>University stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="CSI City Mall" data-lat="16.043989" data-lng="120.335708">
            <i class="bi bi-cart-fill" aria-hidden="true"></i>
            <span>
              <strong>CSI City Mall</strong>
              <small>Commercial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Hererro-Perez Waiting Shed" data-lat="16.042155" data-lng="120.342460">
            <i class="bi bi-people-fill" aria-hidden="true"></i>
            <span>
              <strong>Hererro-Perez Waiting Shed</strong>
              <small>Student stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Victory, Five Star" data-lat="16.042842" data-lng="120.344109">
            <i class="bi bi-bus-front-fill" aria-hidden="true"></i>
            <span>
              <strong>Victory, Five Star</strong>
              <small>Transport hub</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="SM Center Dagupan" data-lat="16.0444626" data-lng="120.3425649">
            <i class="bi bi-cart-fill" aria-hidden="true"></i>
            <span>
              <strong>SM Center Dagupan</strong>
              <small>Commercial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="DBP" data-lat="16.043786" data-lng="120.344272">
            <i class="bi bi-bank2" aria-hidden="true"></i>
            <span>
              <strong>DBP</strong>
              <small>Financial stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Tondaligan Centro" data-lat="16.084194" data-lng="120.348134">
            <i class="bi bi-tree-fill" aria-hidden="true"></i>
            <span>
              <strong>Tondaligan Centro</strong>
              <small>Recreational stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Region 1 MC Annex" data-lat="16.090689" data-lng="120.3622115">
            <i class="bi bi-bandaid-fill" aria-hidden="true"></i>
            <span>
              <strong>Region 1 MC Annex</strong>
              <small>Medical stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Bliss Waiting Shed, Binloc" data-lat="16.0935083" data-lng="120.3675867">
            <i class="bi bi-house-door-fill" aria-hidden="true"></i>
            <span>
              <strong>Bliss Waiting Shed, Binloc</strong>
              <small>Residential stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Leisure Coast Resort" data-lat="16.0959466" data-lng="120.3724469">
            <i class="bi bi-tropical-storm" aria-hidden="true"></i>
            <span>
              <strong>Leisure Coast Resort</strong>
              <small>Recreational stop</small>
            </span>
          </button>
          <button type="button" class="destination-item" data-destination="Binloc Barangay Hall" data-lat="16.1002609" data-lng="120.3778482">
            <i class="bi bi-building-fill-gear" aria-hidden="true"></i>
            <span>
              <strong>Binloc Barangay Hall</strong>
              <small>Government stop</small>
            </span>
          </button>
        </div>
      </div>
      <div class="control-block control-block--legend">
        <span class="control-eyebrow">Map Legend</span>
        <ul class="legend-list">
          <li><img src="icons/Gueset.png" alt="Gueset jeepney icon"><span>Gueset Jeepney</span></li>
          <li><img src="icons/Boquig.png" alt="Boquig jeepney icon"><span>Boquig Jeepney</span></li>
          <li><img src="icons/Longos.png" alt="Longos jeepney icon"><span>Longos Jeepney</span></li>
          <li><img src="icons/Binloc.png" alt="Binloc jeepney icon"><span>Binloc Jeepney</span></li>
          <li><img src="icons/Tondaligan.png" alt="Tondaligan jeepney icon"><span>Tondaligan Jeepney</span></li>
          <li><img src="icons/passenger.png" alt="Passenger icon"><span>Passenger</span></li>
        </ul>
      </div>
    </div>
  </aside>
</main>

<script type="module">
  import { auth, onAuthStateChanged, requireRole, signOutAndRedirect, db, ref, get, query, orderByChild, equalTo, set, update, runTransaction } from "./js/authentication.js";
  import { startTrip } from "./js/create-trip.js";
  import { beginPassengerTracking, stopPassengerTracking, setPassengerWaitingCount, setDestination } from "./js/map-tracker.js";
  import { getActiveTrip } from "./js/get-active-trip.js";

  onAuthStateChanged(auth, (currentUser) => {
    if (!currentUser) {
      location.replace("login.html");
    }
  });

  const { user } = await requireRole(['passenger']);
  const WAITING_COUNT_KEY = 'passenger_waiting_count';
  let storedWaiting = Number(localStorage.getItem(WAITING_COUNT_KEY) || '1');
  if (!Number.isFinite(storedWaiting) || storedWaiting <= 0) storedWaiting = 1;
  setPassengerWaitingCount(storedWaiting);

  const waitingInput = document.getElementById('waitingCountInput');
  const btnWaitingMinus = document.getElementById('btnWaitingMinus');
  const btnWaitingPlus = document.getElementById('btnWaitingPlus');
  const btnWaitingJustMe = document.getElementById('btnWaitingJustMe');
  const btnPassengerStart = document.getElementById('btnPassengerStart');
  const btnPassengerStop = document.getElementById('btnPassengerStop');
  const arrivalNotice = document.getElementById('arrivalNotice');
  const arrivalNoticeClose = document.getElementById('arrivalNoticeClose');
  let arrivalNoticeTimer = null;
  let arrivalAudioCtx = null;

  function hideArrivalNotice() {
    if (!arrivalNotice) return;
    if (arrivalNoticeTimer) {
      clearTimeout(arrivalNoticeTimer);
      arrivalNoticeTimer = null;
    }
    arrivalNotice.classList.remove('show');
    arrivalNotice.setAttribute('aria-hidden', 'true');
    arrivalNotice.hidden = true;
  }

  function showArrivalNotice() {
    if (!arrivalNotice) return;
    if (arrivalNoticeTimer) {
      clearTimeout(arrivalNoticeTimer);
    }
    arrivalNotice.hidden = false;
    arrivalNotice.classList.add('show');
    arrivalNotice.setAttribute('aria-hidden', 'false');
    arrivalNoticeTimer = window.setTimeout(() => {
      hideArrivalNotice();
    }, 8000);
  }

  async function playArrivalChime() {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    try {
      if (!arrivalAudioCtx) {
        arrivalAudioCtx = new AudioContext();
      }
      if (arrivalAudioCtx.state === 'suspended') {
        await arrivalAudioCtx.resume();
      }
      const now = arrivalAudioCtx.currentTime;
      const duration = 0.6;
      const oscillator = arrivalAudioCtx.createOscillator();
      const gain = arrivalAudioCtx.createGain();
      oscillator.type = 'sine';
      oscillator.frequency.setValueAtTime(880, now);
      oscillator.frequency.exponentialRampToValueAtTime(1320, now + duration);
      gain.gain.setValueAtTime(0.0001, now);
      gain.gain.exponentialRampToValueAtTime(0.25, now + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      oscillator.connect(gain).connect(arrivalAudioCtx.destination);
      oscillator.start(now);
      oscillator.stop(now + duration);
    } catch (err) {
      console.warn('Failed to play arrival chime', err);
    }
  }

  if (arrivalNoticeClose) {
    arrivalNoticeClose.addEventListener('click', () => {
      hideArrivalNotice();
    });
  }

  window.addEventListener('jeepni:passenger-arrived', () => {
    showArrivalNotice();
    playArrivalChime().catch(() => {});
  });

  window.addEventListener('jeepni:passenger-tracking-stopped', (evt) => {
    // Find the tracking message element
    const trackingMsg = document.querySelector('.tracking-message');
    if (trackingMsg) {
        // Update the message text and style
        trackingMsg.textContent = 'Tracking stopped';
        trackingMsg.style.background = 'rgba(108, 117, 125, 0.95)'; // grey background
        
        // Optionally remove the message after a delay
        setTimeout(() => {
            trackingMsg.remove();
        }, 2000);
    }
});

  function clampWaitingValue(value) {
    if (typeof value === 'string') {
      const trimmed = value.trim();
      if (!trimmed) return storedWaiting;
      const lowered = trimmed.toLowerCase();
      if (lowered === 'just me' || lowered === 'me') return 1;
      const direct = Number(trimmed);
      if (Number.isFinite(direct)) return direct;
      const digits = trimmed.replace(/[^0-9]/g, '');
      if (digits) {
        const parsed = Number(digits);
        if (Number.isFinite(parsed)) return parsed;
      }
      return storedWaiting;
    }
    return Number(value);
  }

  function applyWaitingValue(raw) {
    const base = clampWaitingValue(raw);
    // Allow zero value
    const waiting = Math.max(Math.round(Number.isFinite(base) ? base : 0), 0);
    storedWaiting = waiting;
    if (waitingInput && waitingInput.value !== String(waiting)) {
        waitingInput.value = String(waiting);
    }
    localStorage.setItem(WAITING_COUNT_KEY, String(waiting));
    setPassengerWaitingCount(waiting);
    return waiting;
  }

  function commitWaitingFromInput() {
    if (!waitingInput) return applyWaitingValue(storedWaiting);
    const raw = waitingInput.value;
    if (!raw) {
      waitingInput.value = String(storedWaiting);
      return storedWaiting;
    }
    return applyWaitingValue(raw);
  }

  if (waitingInput) {
    waitingInput.value = String(storedWaiting);
    waitingInput.addEventListener('input', () => {
      const sanitized = waitingInput.value.replace(/[^0-9]/g, '');
      if (sanitized !== waitingInput.value) waitingInput.value = sanitized;
    });
    waitingInput.addEventListener('change', commitWaitingFromInput);
    waitingInput.addEventListener('blur', commitWaitingFromInput);
  }
  if (btnWaitingMinus) {
    btnWaitingMinus.addEventListener('click', () => {
      applyWaitingValue(storedWaiting - 1);
      waitingInput?.focus();
    });
  }
  if (btnWaitingPlus) {
    btnWaitingPlus.addEventListener('click', () => {
      applyWaitingValue(storedWaiting + 1);
      waitingInput?.focus();
    });
  }
  if (btnWaitingJustMe) {
    btnWaitingJustMe.addEventListener('click', () => {
        // Set value to 0 instead of 1
        applyWaitingValue(0);
        if (waitingInput) {
            waitingInput.value = "0";
            waitingInput.focus();
        }
        // Update companion count to 0
        setPassengerWaitingCount(0);
    });
  }
  if (btnPassengerStart) {
    btnPassengerStart.addEventListener('click', async () => {
      const waiting = commitWaitingFromInput();
      
      // Show tracking message immediately
      const trackingMsg = document.createElement('div');
      trackingMsg.className = 'arrival-notice show';
      trackingMsg.style.background = 'rgba(78, 215, 241, 0.95)';
      trackingMsg.style.color = '#fff';
      trackingMsg.innerHTML = `
        <div class="arrival-notice__icon"><i class="bi bi-geo-alt-fill"></i></div>
        <div class="arrival-notice__message">Tracking ongoing</div>
      `;
      document.querySelector('main.dashboard-shell').appendChild(trackingMsg);
      
      try {
        await beginPassengerTracking(Number(waiting || 0));
      } catch (err) {
        console.error('Failed to start passenger tracking', err);
        trackingMsg.remove();
      }
    });
  }
  if (btnPassengerStop) {
    btnPassengerStop.addEventListener('click', async () => {
        try {
            // First, remove any existing tracking message
            const existingTrackingMsg = document.querySelector('.arrival-notice.show');
            if (existingTrackingMsg) {
                existingTrackingMsg.remove();
            }

            // Then create and show the "Tracking stopped" message
            const stoppedMsg = document.createElement('div');
            stoppedMsg.className = 'arrival-notice show';
            stoppedMsg.style.background = 'rgba(108, 117, 125, 0.95)';
            stoppedMsg.innerHTML = `
                <div class="arrival-notice__icon"><i class="bi bi-geo-alt-fill"></i></div>
                <div class="arrival-notice__message">Tracking stopped</div>
            `;
            document.querySelector('main.dashboard-shell').appendChild(stoppedMsg);
            
            // Remove the stopped message after 2 seconds
            setTimeout(() => {
                stoppedMsg.remove();
            }, 2000);
            
            // Stop the tracking
            await stopPassengerTracking({ reason: 'manual' });
        } catch (err) {
            console.error('Failed to stop passenger tracking', err);
        }
    });
  }
  const destinationButtons = document.querySelectorAll('.destination-item');
  destinationButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const destName = (btn.dataset.destination || 'Destination').trim();
      const lat = Number(btn.dataset.lat);
      const lng = Number(btn.dataset.lng);
      if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
        console.warn('Destination coordinates missing for', destName);
        return;
      }
      destinationButtons.forEach((item) => item.classList.toggle('is-active', item === btn));
      try {
        setDestination(lat, lng, destName || 'Destination');
      } catch (err) {
        console.error('Failed to set destination marker', err);
      }
    });
  });

  // Friendly name
  const applyPassengerName = (name) => {
    document.getElementById("whoami").textContent = name;
    const whoamiPanel = document.getElementById("whoamiPanel");
    if (whoamiPanel) whoamiPanel.textContent = name;
  };
  try{
    const p = await get(ref(db, `all_users/${user.uid}/name`));
    const resolvedName = (p.exists() && p.val()) ? p.val() : (user.displayName || user.email);
    applyPassengerName(resolvedName);
  }catch{
    applyPassengerName(user.displayName || user.email);
  }

  function fmt(ts){
    if(!ts) return "";
    const d = typeof ts === 'number' ? new Date(ts) : ts?.seconds ? new Date(ts.seconds*1000) : null;
    return d ? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
  }

    const tripsTableBody = document.getElementById("rows");
  const btnReload = document.getElementById("btnReload");
  const btnExport = document.getElementById("btnExport");

  if (tripsTableBody && btnReload && btnExport) {
    async function loadTrips(){
      tripsTableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>`;

      const trips=[];
      let s1 = null; 
      try { s1 = await get(ref(db,`user_trips/${user.uid}`)); } catch(_){ }
      if(s1 && s1.exists()){
        const byDate = s1.val()||{};
        for(const date of Object.keys(byDate)){
          const items = byDate[date]||{};
          for(const id of Object.keys(items)){
            const t = items[id]||{};
            const start = t.start?.ts; const end = t.end?.ts;
            const durMin = (start && end) ? Math.max(0, Math.round(((typeof end==='number'?end:end?.seconds*1000) - (typeof start==='number'?start:start?.seconds*1000))/60000)) : '';
            trips.push({ date: t.date || date, route: t.route || '', start: fmt(start), end: fmt(end), duration: durMin!==''? `${durMin}m` : '' });
          }
        }
      } else {
        try {
          const q = query(ref(db,'trip_logs'), orderByChild('driver_uid'), equalTo(user.uid));
          const s2 = await get(q);
          if (s2.exists()) {
            const byId = s2.val() || {};
            for (const id of Object.keys(byId)) {
              const t = byId[id] || {};
              const start = t.start?.ts; const end = t.end?.ts;
              const d = start ? new Date(typeof start==='number'?start:start?.seconds*1000).toISOString().slice(0,10) : '';
              const durMin = (start && end) ? Math.max(0, Math.round(((typeof end==='number'?end:end?.seconds*1000) - (typeof start==='number'?start:start?.seconds*1000))/60000)) : '';
              trips.push({ date: t.date || d, route: t.route || '', start: fmt(start), end: fmt(end), duration: durMin!==''? `${durMin}m` : '' });
            }
          }
        } catch(_) { }
      }

      if(!trips.length){ tripsTableBody.innerHTML=`<tr><td colspan="5" class="text-center text-muted">No trips yet</td></tr>`; return; }
      trips.sort((a,b)=> a.date<b.date?1:-1);
      tripsTableBody.innerHTML = trips.map(t=>`
        <tr>
          <td>${t.date||""}</td>
          <td>${t.route||""}</td>
          <td>${t.start||""}</td>
          <td>${t.end||""}</td>
          <td>${t.duration||""}</td>
        </tr>`).join("");
    }

    btnReload.addEventListener("click", loadTrips);
    btnExport.addEventListener("click", async ()=>{
      const rows=[["Date","Route","Start","End","Duration"]];
      let s1=null; try{ s1=await get(ref(db,`user_trips/${user.uid}`)); }catch(_){ }
      if(s1 && s1.exists()){
        const byDate=s1.val()||{};
        for(const date of Object.keys(byDate)){
          for(const id of Object.keys(byDate[date]||{})){
            const t = byDate[date][id]||{};
            rows.push([t.date||date, t.route||"", fmt(t.start?.ts), fmt(t.end?.ts), ""]);
          }
        }
      }else{
        try {
          const q = query(ref(db,'trip_logs'), orderByChild('driver_uid'), equalTo(user.uid));
          const s2 = await get(q);
          if(!s2.exists()) return;
          const byId = s2.val()||{};
          for(const id of Object.keys(byId)){
            const t = byId[id]||{}; const start=t.start?.ts; const end=t.end?.ts;
            const d = start ? new Date(typeof start==='number'?start:start?.seconds*1000).toISOString().slice(0,10) : '';
            rows.push([t.date||d, t.route||"", fmt(start), fmt(end), ""]);
          }
        } catch(_) { return; }
      }
      const csv=rows.map(r=>r.join(",")).join("\n");
      const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
      const a=document.createElement("a"); a.href=url; a.download="my_trips.csv"; a.click(); URL.revokeObjectURL(url);
    });

    await loadTrips();
  }

  document.getElementById("btnLogout").addEventListener("click",()=>signOutAndRedirect("login.html"));
  // ---- In-app notifications (unchanged) ----
  try{
    const toastHost = document.createElement('div');
    toastHost.className = 'position-fixed';
    toastHost.style.right = '12px';
    toastHost.style.bottom = '96px';
    toastHost.style.zIndex = '1060';
    document.body.appendChild(toastHost);

    const lastSeenKey = 'notif_last_seen';
    const getTs = v => typeof v === 'number' ? v : v?.seconds ? v.seconds*1000 : Date.now();
    let lastSeen = Number(localStorage.getItem(lastSeenKey) || '0');

    const bell = document.querySelector('.icon-btn .notif-dot');
    const bump = ()=>{ if(bell){ const n = Number(bell.textContent||'0')+1; bell.textContent=String(n); bell.style.display='grid'; } };

    const showToast = (html)=>{
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-bg-primary border-0 show';
      el.role='status'; el.ariaLive='polite'; el.ariaAtomic='true';
      el.style.minWidth='260px'; el.style.boxShadow='0 12px 28px rgba(0,0,0,.18)'; el.style.marginTop='8px';
      el.innerHTML = `<div class="d-flex"><div class="toast-body">${html}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      toastHost.appendChild(el);
      setTimeout(()=> el.remove(), 6000);
    };

    const notifRef = ref(db, 'prediction_notifications');
    const check = async ()=>{
      try{
        const s = await get(notifRef);
        if(!s.exists()) return;
        const items = s.val()||{};
        let newest = lastSeen;
        Object.values(items).forEach(batch=>{
          const sentAt = getTs(batch.sent_at);
          if(sentAt <= lastSeen) return;
          const arr = batch.notifications||[];
          arr.forEach(n=>{
            if(n.driver_uid === user.uid){
              newest = Math.max(newest, sentAt);
              bump();
              const hour = n.peak_hour ? `Peak hour: <strong>${n.peak_hour}</strong>` : '';
              showToast(`Demand alert for <strong>${n.route||'your route'}</strong>. ${hour}`);
            }
          });
        });
        if(newest>lastSeen){ lastSeen=newest; localStorage.setItem(lastSeenKey, String(lastSeen)); }
      }catch{ }
    };
    setInterval(check, 10000);
    check();
  }catch{}

  /* =========================
     WATCH ADS + GAMES (UID-tied)
     ========================= */

  const $adsPanel = document.getElementById('adsPanel');
  const $adsBackdrop = document.getElementById('adsBackdrop');
  const $btnCloseAds = document.getElementById('btnCloseAds');
  const $btnWatchAd = document.getElementById('btnWatchAd');
  const $noAdsBadge = document.getElementById('noAdsBadge');
  const $coinCount = document.getElementById('coinCount');
  const $lvlCount = document.getElementById('lvlCount');
  const $adsStatus = document.getElementById('adsStatus');

  if ($adsPanel && $adsBackdrop && $btnCloseAds && $btnWatchAd && $noAdsBadge && $coinCount && $lvlCount && $adsStatus) {

    const coinsRef = ref(db, `wallets/${user.uid}/coins`);
    const engageRef = ref(db, `engagement/${user.uid}`);

    async function ensureDefaults(){
      const s = await get(engageRef);
      if(!s.exists()){
        await set(engageRef, { levels_completed: 0, ads_available: 1 });
      }
      const c = await get(coinsRef);
      if(!c.exists()){
        await set(coinsRef, 0);
      }
    }
    await ensureDefaults();

    async function readState(){
      const [c, e] = await Promise.all([get(coinsRef), get(engageRef)]);
      const coins = c.exists()? c.val() : 0;
      const levels = e.exists()? (e.val().levels_completed||0) : 0;
      const adsAvail = e.exists()? (e.val().ads_available||0) : 0;
      $coinCount.textContent = coins;
      $lvlCount.textContent = levels;
      $adsStatus.textContent = adsAvail? 'Available' : 'Not available';
      $adsStatus.className = `badge rounded-pill ${adsAvail? 'text-bg-success':'text-bg-secondary'}`;
      $btnWatchAd.disabled = !adsAvail;
      $noAdsBadge.style.display = adsAvail ? 'none' : '';
    }
    await readState();

    async function incrementCoins(by=1){
      await runTransaction(coinsRef, (val)=> (Number(val||0)+by));
      await readState();
    }

    async function addLevelAndMaybeUnlock(){
      await runTransaction(engageRef, (val)=>{
        const cur = val||{levels_completed:0, ads_available:1};
        const nextLvl = Number(cur.levels_completed||0)+1;
        const unlock = nextLvl % 5 === 0 ? 1 : cur.ads_available||0;
        return { levels_completed: nextLvl, ads_available: unlock };
      });
      await readState();
    }

    async function consumeAdAvailabilityAndReward(){
      // Simulate a watched ad and add coin
      await runTransaction(engageRef, (val)=>{
        const cur = val||{levels_completed:0, ads_available:1};
        return { ...cur, ads_available: 0 };
      });
      await incrementCoins(1);
    }

    // Open the in-page panel when the bottom nav "Watch Ads" is clicked
    document.querySelectorAll('.app-nav a[href="watch-ads.html"]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault(); // keep original link intact if opened directly elsewhere
        openAdsPanel();
      });
    });

    function openAdsPanel(){
      $adsBackdrop.style.display='block';
      $adsPanel.style.display='block';
    }
    function closeAdsPanel(){
      $adsBackdrop.style.display='none';
      $adsPanel.style.display='none';
    }
    $adsBackdrop.addEventListener('click', closeAdsPanel);
    $btnCloseAds.addEventListener('click', closeAdsPanel);

    $btnWatchAd.addEventListener('click', async ()=>{
      $btnWatchAd.disabled = true;
      $btnWatchAd.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Playingâ€¦`;
      // Simulate a 5s ad
      setTimeout(async ()=>{
        await consumeAdAvailabilityAndReward();
        $btnWatchAd.innerHTML = `<i class="bi bi-play-fill me-1"></i> Watch Ad (+1 coin)`;
      }, 5000);
    });

    /* ===== Memory Match ===== */
    const memIcons = ['bi-bus-front','bi-geo-alt-fill','bi-wallet2','bi-lightning','bi-wifi','bi-joystick','bi-battery-full','bi-bell'];
    let memPairs = 4; // grows with resets for variety
    const $mem = document.getElementById('memoryGrid');
    function setupMemory(){
      const pick = memIcons.slice(0, Math.min(memPairs, memIcons.length));
      const deck = [...pick, ...pick].sort(()=>Math.random()-0.5);
      $mem.innerHTML = '';
      deck.forEach((cls, idx)=>{
        const el = document.createElement('button');
        el.type='button';
        el.className='card-tile';
        el.dataset.icon=cls;
        el.dataset.idx=String(idx);
        el.innerHTML = `<i class="bi"></i>`;
        $mem.appendChild(el);
      });
      bindMemory();
    }
    let first=null, lockMem=false, matched=0;
    function bindMemory(){
      $mem.querySelectorAll('.card-tile').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          if(lockMem || btn.classList.contains('matched') || btn.classList.contains('flipped')) return;
          btn.classList.add('flipped');
          btn.querySelector('.bi').className = `bi ${btn.dataset.icon}`;
          if(!first){ first=btn; return; }
          // compare
          lockMem=true;
          setTimeout(()=>{
            if(first.dataset.icon===btn.dataset.icon){
              first.classList.add('matched'); btn.classList.add('matched'); matched+=2;
            }else{
              first.classList.remove('flipped'); btn.classList.remove('flipped');
              first.querySelector('.bi').className='bi'; btn.querySelector('.bi').className='bi';
            }
            first=null; lockMem=false;
            if(matched === $mem.children.length){
              matched = 0;
              addLevelAndMaybeUnlock();
            }
          }, 450);
        });
      });
    }
    document.getElementById('btnMemReset').addEventListener('click', ()=>{
      matched=0; first=null; lockMem=false;
      memPairs = Math.min(memPairs+1, 8);
      setupMemory();
    });
    setupMemory();

    /* ===== Mini Sudoku 4Ã—4 ===== */
    const $sudoku = document.getElementById('sudokuGrid');
    const sudPresets = [
      // 0 = empty; rows of 4
      [1,0,0,4, 0,4,3,0, 0,3,2,0, 2,0,0,1],
      [0,0,3,0, 3,0,0,1, 0,1,0,0, 0,0,4,0],
      [0,2,0,0, 0,0,4,3, 0,3,0,0, 2,0,0,0]
    ];
    function newSudoku(){
      $sudoku.innerHTML='';
      const base = sudPresets[Math.floor(Math.random()*sudPresets.length)].slice();
      base.forEach((v,i)=>{
        const wrap = document.createElement('div'); wrap.className='sudoku-cell';
        const inp = document.createElement('input'); inp.inputMode='numeric'; inp.maxLength=1; inp.pattern='[1-4]';
        if(v){ inp.value=String(v); inp.disabled=true; inp.style.background='#f1f5ff'; }
        wrap.appendChild(inp); $sudoku.appendChild(wrap);
      });
    }
    function validSudoku(){
      const vals = [...$sudoku.querySelectorAll('input')].map(i=>Number(i.value||0));
      const get = (r,c)=> vals[r*4+c];
      const setOk = (arr)=> {
        const s = new Set(arr);
        for(const v of arr){ if(!(v>=1 && v<=4)) return false; }
        return s.size===4;
      };
      for(let r=0;r<4;r++){ if(!setOk([get(r,0),get(r,1),get(r,2),get(r,3)])) return false; }
      for(let c=0;c<4;c++){ if(!setOk([get(0,c),get(1,c),get(2,c),get(3,c)])) return false; }
      // 2x2 boxes
      for(let br=0;br<4;br+=2){
        for(let bc=0;bc<4;bc+=2){
          if(!setOk([get(br,bc),get(br,bc+1),get(br+1,bc),get(br+1,bc+1)])) return false;
        }
      }
      return true;
    }
    document.getElementById('btnSudCheck').addEventListener('click', ()=>{
      if(validSudoku()){
        addLevelAndMaybeUnlock();
        // start a new one
        newSudoku();
      }else{
        alert('Not correct yet. Use numbers 1â€“4 without repeating in rows, columns, and 2Ã—2 boxes.');
      }
    });
    document.getElementById('btnSudNew').addEventListener('click', newSudoku);
    newSudoku();

    /* ===== Connect Pairs (click-to-connect) ===== */
    const leftCol = document.getElementById('leftCol');
    const rightCol = document.getElementById('rightCol');
    const svg = document.getElementById('connectSvg');

    let leftItems=[], rightItems=[], pairs=[], selectedLeft=null, connections=0;

    function setupConnect(){
      leftCol.innerHTML=''; rightCol.innerHTML=''; svg.innerHTML='';
      const icons = ['bi-geo-alt','bi-bus-front','bi-wallet2','bi-lightning-charge','bi-shield-check'];
      const left = icons.slice(0); const right = icons.slice(0).sort(()=>Math.random()-0.5);
      pairs = icons.map((ic)=>({left:ic,right:ic}));
      leftItems = left.map((ic,idx)=>createConnItem(ic, 'L', idx));
      rightItems = right.map((ic,idx)=>createConnItem(ic, 'R', idx));
      leftItems.forEach(n=>leftCol.appendChild(n.el));
      rightItems.forEach(n=>rightCol.appendChild(n.el));
      connections=0; selectedLeft=null;
    }

    function createConnItem(icon, side, idx){
      const el = document.createElement('button');
      el.type='button';
      el.className='connect-item';
      el.innerHTML=`<i class="bi ${icon}"></i>`;
      el.dataset.icon=icon; el.dataset.side=side; el.dataset.idx=String(idx);
      el.addEventListener('click', ()=>onConnClick(el));
      return {el, side, icon, idx};
    }

    function onConnClick(el){
      const side = el.dataset.side;
      if(side==='L'){
        // select left
        if(el.disabled) return;
        leftCol.querySelectorAll('.connect-item').forEach(b=>b.classList.remove('btn-primary'));
        el.classList.add('btn-primary');
        selectedLeft = el;
      }else{
        if(!selectedLeft || el.disabled) return;
        // draw connection
        const ok = (selectedLeft.dataset.icon === el.dataset.icon);
        drawLink(selectedLeft, el, ok);
        if(ok){
          selectedLeft.disabled=true; el.disabled=true;
          selectedLeft.classList.remove('btn-primary');
          selectedLeft.style.opacity=.7; el.style.opacity=.7;
          connections++;
          if(connections===pairs.length){
            addLevelAndMaybeUnlock();
          }
        }else{
          // brief feedback
          el.classList.add('btn-danger');
          setTimeout(()=> el.classList.remove('btn-danger'), 400);
        }
        selectedLeft=null;
        leftCol.querySelectorAll('.connect-item').forEach(b=>b.classList.remove('btn-primary'));
      }
    }

    function drawLink(leftBtn, rightBtn, ok){
      const lRect = leftBtn.getBoundingClientRect();
      const rRect = rightBtn.getBoundingClientRect();
      const sRect = svg.getBoundingClientRect();
      const x1 = 10; // left edge
      const y1 = (lRect.top + lRect.height/2) - sRect.top;
      const x2 = 110; // right edge
      const y2 = (rRect.top + rRect.height/2) - sRect.top;
      const path = document.createElementNS('http://www.w3.org/2000/svg','line');
      path.setAttribute('x1', String(x1));
      path.setAttribute('y1', String(y1));
      path.setAttribute('x2', String(x2));
      path.setAttribute('y2', String(y2));
      path.setAttribute('stroke', ok? '#198754' : '#dc3545');
      path.setAttribute('stroke-width', '3');
      path.setAttribute('stroke-linecap','round');
      svg.appendChild(path);
    }

    document.getElementById('btnConnReset').addEventListener('click', setupConnect);
    setupConnect();

    // Reset panel position on resize to stay responsive
    window.addEventListener('resize', ()=>{
      if($adsPanel.style.display==='block'){ /* triggers reflow for connect lines */ setupConnect(); }
    });

  }
  window.addEventListener("beforeunload", () => {
    stopPassengerTracking({ reason: "unload" }).catch(() => {});
  });

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>