<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi - My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --brand: #4ed7f1;
      --accent: #ffd63a;
      --muted: #6b7280;
    }
    body {
      background: #f4f6fb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem 1rem;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      color: #1f2937;
    }
    .profile-wrapper {
      width: min(640px, 100%);
    }
    .card {
      border: none;
      border-radius: 24px;
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.12);
    }
    .card h1, .card h2 {
      font-weight: 700;
    }
    .form-label {
      font-weight: 600;
      color: var(--muted);
    }
    .form-control, .form-control:focus {
      border-radius: 14px;
      border: 1px solid rgba(15, 23, 42, 0.12);
      box-shadow: none;
    }
    .btn-brand {
      background: linear-gradient(90deg, var(--brand), #8cecff);
      color: #0f172a;
      font-weight: 700;
      border-radius: 999px;
      border: none;
      padding: 0.65rem 1.6rem;
    }
    .btn-muted {
      border-radius: 999px;
      font-weight: 600;
    }
    .alert-placeholder {
      min-height: 1.75rem;
    }
  </style>
</head>
<body>
  <main class="profile-wrapper">
    <div class="card mb-4">
      <div class="card-body p-4 p-md-5">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-4">
          <div>
            <h1 class="h3 mb-1">My Profile</h1>
            <p class="text-muted mb-0">Update your contact details below.</p>
          </div>
          <div class="d-flex flex-wrap gap-2">
            <a href="passenger-dashboard.html" class="btn btn-outline-secondary btn-muted">Back to Dashboard</a>
            <button id="btnLogout" class="btn btn-outline-danger btn-muted">Logout</button>
          </div>
        </div>
        <form id="profileForm" class="vstack gap-3">
          <div class="row g-3">
            <div class="col-12">
              <label for="fullName" class="form-label">Full Name</label>
              <input id="fullName" name="fullName" type="text" class="form-control" autocomplete="name" required>
            </div>
            <div class="col-12 col-md-6">
              <label for="phone" class="form-label">Phone Number</label>
              <input id="phone" name="phone" type="tel" class="form-control" autocomplete="tel">
            </div>
            <div class="col-12 col-md-6">
              <label for="email" class="form-label">Email</label>
              <input id="email" name="email" type="email" class="form-control" autocomplete="email" required>
            </div>
          </div>
          <div class="alert-placeholder">
            <div id="profileAlert" class="small text-muted"></div>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-brand">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body p-4 p-md-5">
        <h2 class="h5 mb-3">Change Password</h2>
        <p class="text-muted small">Enter a new password with at least 6 characters.</p>
        <form id="passwordForm" class="vstack gap-3">
          <div>
            <label for="newPassword" class="form-label">New Password</label>
            <input id="newPassword" name="newPassword" type="password" class="form-control" autocomplete="new-password" required>
          </div>
          <div>
            <label for="confirmPassword" class="form-label">Confirm Password</label>
            <input id="confirmPassword" name="confirmPassword" type="password" class="form-control" autocomplete="new-password" required>
          </div>
          <div class="alert-placeholder">
            <div id="passwordAlert" class="small text-muted"></div>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-brand">Update Password</button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <script type="module">
    import { requireRole, signOutAndRedirect, db, ref, get, update } from "./js/authentication.js";
    import { updateProfile, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const profileAlert = document.getElementById('profileAlert');
    const passwordAlert = document.getElementById('passwordAlert');
    const profileForm = document.getElementById('profileForm');
    const passwordForm = document.getElementById('passwordForm');
    const fullNameInput = document.getElementById('fullName');
    const phoneInput = document.getElementById('phone');
    const emailInput = document.getElementById('email');
    const logoutBtn = document.getElementById('btnLogout');

    const { user, profile } = await requireRole(['passenger']);

    const initialName = profile?.name || user.displayName || '';
    const initialPhone = profile?.phone || '';
    const initialEmail = profile?.email || user.email || '';

    fullNameInput.value = initialName;
    phoneInput.value = initialPhone;
    emailInput.value = initialEmail;

    logoutBtn.addEventListener('click', async (event) => {
      event.preventDefault();
      await signOutAndRedirect('login.html');
    });

    function showMessage(target, message, tone = 'muted') {
      if (!target) return;
      target.textContent = message;
      target.className = `small text-${tone}`;
    }

    profileForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showMessage(profileAlert, 'Saving...', 'muted');
      const fullName = fullNameInput.value.trim();
      const phone = phoneInput.value.trim();
      const email = emailInput.value.trim();

      if (!fullName) {
        showMessage(profileAlert, 'Please provide your full name.', 'danger');
        return;
      }
      if (!email) {
        showMessage(profileAlert, 'Email is required.', 'danger');
        return;
      }

      try {
        if (email !== user.email) {
          await updateEmail(user, email);
        }
        await updateProfile(user, { displayName: fullName }).catch(() => {});

        const updates = { name: fullName, phone, email, uid: user.uid, role: profile?.role || 'passenger' };
        await update(ref(db, `all_users/${user.uid}`), updates).catch(() => set(ref(db, `all_users/${user.uid}`), updates));

        const passengerSnap = await get(ref(db, `passengers/${user.uid}`));
        if (passengerSnap.exists()) {
          await update(ref(db, `passengers/${user.uid}`), { ...passengerSnap.val(), name: fullName, phone, email });
        }

        const driverSnap = await get(ref(db, `drivers/${user.uid}`));
        if (driverSnap.exists()) {
          await update(ref(db, `drivers/${user.uid}`), { ...driverSnap.val(), name: fullName, email });
        }

        showMessage(profileAlert, 'Profile updated successfully.', 'success');
      } catch (error) {
        console.error('Profile update failed', error);
        const msg = error?.message || 'Failed to update profile.';
        showMessage(profileAlert, msg, 'danger');
      }
    });

    passwordForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showMessage(passwordAlert, 'Updating password...', 'muted');
      const pass = document.getElementById('newPassword').value.trim();
      const confirm = document.getElementById('confirmPassword').value.trim();

      if (pass.length < 6) {
        showMessage(passwordAlert, 'Password must be at least 6 characters.', 'danger');
        return;
      }
      if (pass !== confirm) {
        showMessage(passwordAlert, 'Passwords do not match.', 'danger');
        return;
      }

      try {
        await updatePassword(user, pass);
        showMessage(passwordAlert, 'Password updated. You may need to sign in again on other devices.', 'success');
        passwordForm.reset();
      } catch (error) {
        console.error('Password update failed', error);
        const message = error?.code == 'auth/requires-recent-login'
          ? 'Please log out and sign in again, then try updating your password.'
          : (error?.message or 'Failed to update password.');
        showMessage(passwordAlert, message, 'danger');
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
