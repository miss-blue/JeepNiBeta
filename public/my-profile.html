<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi ï¿½ My Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --blue:#35a8f0; --muted:#6b7b8a; }
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#fff }
    header{ display:flex; align-items:center; justify-content:space-between; padding:14px 14px 4px; }
    header .title{ font-weight:900; letter-spacing:.6px }
    .back{ width:40px; height:40px; border-radius:10px; background:#eef6ff; border:none; display:grid; place-items:center }
    .gear{ width:40px; height:40px; border-radius:10px; background:#eef6ff; border:none; display:grid; place-items:center }
    .profile{ text-align:center; padding-top:10px }
    .avatar{ width:120px; height:120px; border-radius:50%; background:#e9eef5; margin:6px auto; display:grid; place-items:center; position:relative; box-shadow:0 6px 16px rgba(0,0,0,.12) }
    .avatar .cam{ position:absolute; right:6px; bottom:6px; width:26px; height:26px; border-radius:8px; background:#000; color:#fff; display:grid; place-items:center }
    .name{ font-weight:900; font-size:24px }
    .phone{ color:var(--muted); margin-top:-4px }
    .edit-btn{ background:linear-gradient(180deg,#8be3ff,#35a8f0); border:none; color:#fff; font-weight:800; padding:8px 14px; border-radius:10px; }
    .list{ margin:18px 14px; display:grid; gap:12px }
    .list a{ display:flex; align-items:center; gap:10px; padding:12px; border:2px solid #cfe8ff; border-radius:12px; text-decoration:none; color:#233b55; font-weight:700; }
    .logout{ margin:20px 14px 100px; text-align:center }
    .logout a{ display:inline-block; background:#f1f3f5; padding:12px 16px; border-radius:12px; color:#d22; text-decoration:none; font-weight:700 }
    /* bottom nav */
    .app-nav{ position:fixed; left:0; right:0; bottom:0; height:84px; z-index:10; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.95)); backdrop-filter:blur(8px); border-top:1px solid rgba(0,0,0,.06); display:grid; grid-template-columns:1fr 1fr 72px 1fr 1fr; align-items:center }
    .app-nav a{ text-decoration:none; color:#6b7b8a; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0 }
    .app-nav a .bi{ font-size:20px }
    .home-fab{ position:absolute; left:50%; transform:translateX(-50%); bottom:22px; width:64px; height:64px; border-radius:50%; background:linear-gradient(180deg,#8be3ff,#35a8f0); color:#fff; display:grid; place-items:center; box-shadow:0 16px 32px rgba(0,0,0,.25); border:4px solid #fff }
    .active{ color:#2a476a !important; font-weight:800 }
    .app-nav .center-slot{ width:72px; height:1px }
  </style>
</head>
<body>
  <header>
    <a class="back" href="passenger-dashboard.html" aria-label="Back"><i class="bi bi-chevron-left"></i></a>
    <div class="title fs-4">My Profile</div>
    <button class="gear" aria-label="Settings"><i class="bi bi-gear"></i></button>
  </header>

  <section class="profile">
    <div class="avatar" id="avatarBox">
      <img id="avatarImg" alt="Avatar" style="display:none; width:100%; height:100%; object-fit:cover; border-radius:50%" />
      <i id="avatarIcon" class="bi bi-person fs-1"></i>
      <div class="cam"><i class="bi bi-camera-fill"></i></div>
      <input id="photoInput" type="file" accept="image/*" style="position:absolute; inset:0; opacity:0; cursor:pointer" aria-label="Upload profile photo" />
    </div>
    <div class="name" id="displayName">Full Name</div>
    <div class="phone" id="displayPhone">phone number</div>
    <a href="edit-profile.html" class="btn edit-btn mt-2">Edit Profile</a>
  </section>

  <hr class="mx-3">
  <div class="list">
    <a href="#"><i class="bi bi-translate"></i><span>Language Settings</span></a>
    <a href="#"><i class="bi bi-shield-lock"></i><span>Privacy Settings</span></a>
    <a href="#"><i class="bi bi-question-circle"></i><span>Help & Support / FAQ</span></a>
    <a href="#"><i class="bi bi-exclamation-triangle"></i><span>Report a Problem</span></a>
  </div>
  <div class="logout">
    <a id="btnLogout" href="#">Log out</a>
  </div>

  <nav class="app-nav">
    <a href="destination.html" aria-label="Destination" style="grid-column:1"><i class="bi bi-geo-alt"></i><span>Destination</span></a>
    <a href="watch-ads.html" aria-label="Watch Ads" style="grid-column:2"><i class="bi bi-camera-reels"></i><span>Watch Ads</span></a>
    <span class="center-slot" aria-hidden="true" style="grid-column:3"></span>
    <a href="wallet.html" aria-label="Wallet" style="grid-column:4"><i class="bi bi-wallet2"></i><span>Wallet</span></a>
    <a href="my-profile.html" aria-label="Profile" class="active" style="grid-column:5"><i class="bi bi-person"></i><span>Profile</span></a>
    <a href="passenger-dashboard.html" class="home-fab" aria-label="Home"><i class="bi bi-house-door fs-3"></i></a>
  </nav>

  <script type="module">
    import { requireLogin, signOutAndRedirect, db, ref, get } from './js/authentication.js';

    const user = await requireLogin('login.html');
    document.getElementById('btnLogout')?.addEventListener('click', (e)=>{ e.preventDefault(); signOutAndRedirect('login.html'); });

    async function load(){
      try{
        const snap = await get(ref(db, `all_users/${user.uid}`));
        const u = snap.exists() ? snap.val() : {};
        document.getElementById('displayName').textContent = u.name || user.displayName || user.email || 'User';
        document.getElementById('displayPhone').textContent = u.phone || 'phone number';
        if (u.photoUrl){
          const img = document.getElementById('avatarImg');
          const icon = document.getElementById('avatarIcon');
          img.src = u.photoUrl; img.style.display='block'; icon.style.display='none';
        }
      }catch(e){ console.warn('profile load failed', e); }
    }
    load();

    // Handle photo upload
    const input = document.getElementById('photoInput');
    input?.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const fd = new FormData();
      fd.append('uid', user.uid);
      fd.append('photo', file);
      try{
        const res = await fetch('/api/profile/upload_photo', { method:'POST', body: fd });
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Upload failed');
        // Update UI immediately
        const img = document.getElementById('avatarImg');
        const icon = document.getElementById('avatarIcon');
        img.src = data.photoUrl + `?t=${Date.now()}`; img.style.display='block'; icon.style.display='none';
      }catch(err){
        alert('Failed to upload photo: ' + err.message);
      } finally {
        try { input.value = ''; } catch{}
      }
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
