<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi â€“ Destination</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{ --brand:#1a3c8b; --accent:#f7c843; --muted:#6b7b8a; --line:#e9eef5; }
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:#fff }
    header{ display:flex; align-items:center; gap:8px; padding:14px; }
    .back{ width:40px; height:40px; border-radius:10px; background:#eef6ff; border:none; display:grid; place-items:center }
    .title{ font-weight:900; color:#163a64; letter-spacing:.6px }
    .wrap{ padding:8px 14px 100px }
    .field{ position:relative; background:#fff; border:2px solid #f1cc38; border-radius:12px; padding:8px 12px 8px 40px; display:flex; align-items:center; margin:10px 0 }
    .field input{ border:0; outline:0; width:100%; font-weight:700; color:#1f2d3d }
    .field .icon{ position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#f1cc38 }
    .field .clear{ position:absolute; right:10px; top:50%; transform:translateY(-50%); background:transparent; border:0; color:#9aa4ad }
    .divider{ height:10px; background:#f4f6f9; margin:12px -14px 8px }
    .result{ padding:10px 2px }
    .item{ padding:10px 6px; border-bottom:1px solid var(--line); display:flex; align-items:flex-start; gap:12px; cursor:pointer }
    .item i{ color:#f1cc38; font-size:20px }
    .item .name{ font-weight:800; line-height:1 }
    .item .sub{ color:var(--muted); font-size:12px }
    .footer{ position:fixed; left:0; right:0; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.95)); backdrop-filter:blur(8px); border-top:1px solid rgba(0,0,0,.06); padding:12px 14px; display:flex; gap:10px }
    .footer .btn-primary{ flex:1; background:linear-gradient(180deg,#8be3ff,#35a8f0); border:none; font-weight:800 }
    /* bottom nav so UX stays consistent */
    .app-nav{ position:fixed; left:0; right:0; bottom:0; height:84px; z-index:10; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.95)); backdrop-filter:blur(8px); border-top:1px solid rgba(0,0,0,.06); display:grid; grid-template-columns:1fr 1fr 72px 1fr 1fr; align-items:center; }
    .app-nav a{ text-decoration:none; color:#6b7b8a; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0 }
    .app-nav a .bi{ font-size:20px }
    .home-fab{ position:absolute; left:50%; transform:translateX(-50%); bottom:22px; width:64px; height:64px; border-radius:50%; background:linear-gradient(180deg,#8be3ff,#35a8f0); color:#fff; display:grid; place-items:center; box-shadow:0 16px 32px rgba(0,0,0,.25); border:4px solid #fff }
    .app-nav .center-slot{ width:72px; height:1px }
    .active{ color:#2a476a !important; font-weight:800 }
    #map { height: 260px; border-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.08); margin-top: 8px }
    .legend-card{margin-top:8px;background:#fff;border-radius:12px;padding:8px 12px;box-shadow:0 4px 12px rgba(0,0,0,.08);}
    .legend-entry{display:flex;align-items:center;gap:8px;padding:4px 0;}
    .legend-entry img{width:24px;height:24px;}
    /* Background 2 overlay to keep focus on inputs */
    body{ position: relative; }
    body::before{ content:""; position: fixed; inset:0; background: url('icons/Background2.png') center bottom / cover no-repeat; opacity:.12; pointer-events:none; z-index:-1; }
  </style>
<script>
  (function(){
    if (window.getIconUrl) return;
    function getIconBasePath(){
      if (location.hostname.includes('web.app') || location.hostname.includes('firebaseapp.com')) {
        return `${location.origin}/icons/`;
      }
      if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
        return '/icons/';
      }
      return '/icons/';
    }
    const base = getIconBasePath();
    window.getIconUrl = function(filename){
      return `${base}${filename}`;
    };
  })();
</script>
</head>
<body>
  <header>
    <a class="back" href="passenger-dashboard.html" aria-label="Back"><i class="bi bi-chevron-left"></i></a>
    <div class="title fs-5">Set Your Destination</div>
  </header>

    <section class="wrap">
    <div class="field">
      <i class="bi bi-geo-alt icon"></i>
      <input id="from" placeholder="From" autocomplete="off" />
      <button class="clear" data-clear="from"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="field">
      <i class="bi bi-geo-alt-fill icon"></i>
      <input id="to" placeholder="To" autocomplete="off" />
      <button class="clear" data-clear="to"><i class="bi bi-x-lg"></i></button>
    </div>

    <div class="divider"></div>
    <div id="map" role="img" aria-label="Route preview map"></div>
    <div id="legend" class="legend-card small" aria-label="Route icon legend">
      <div class="fw-semibold mb-1">Route Icons</div>
      <div class="legend-entry" data-route="Gueset" data-type="modern"><img alt="Gueset modern icon"><span>Gueset (Modern)</span></div>
      <div class="legend-entry" data-route="Gueset" data-type="traditional"><img alt="Gueset traditional icon"><span>Gueset (Traditional)</span></div>
      <div class="legend-entry" data-route="Boquig" data-type="modern"><img alt="Boquig modern icon"><span>Boquig (Modern)</span></div>
      <div class="legend-entry" data-route="Boquig" data-type="traditional"><img alt="Boquig traditional icon"><span>Boquig (Traditional)</span></div>
      <div class="legend-entry" data-route="Longos" data-type="modern"><img alt="Longos modern icon"><span>Longos (Modern)</span></div>
      <div class="legend-entry" data-route="Longos" data-type="traditional"><img alt="Longos traditional icon"><span>Longos (Traditional)</span></div>
      <div class="legend-entry" data-route="Binloc" data-type="modern"><img alt="Binloc modern icon"><span>Binloc (Modern)</span></div>
      <div class="legend-entry" data-route="Binloc" data-type="traditional"><img alt="Binloc traditional icon"><span>Binloc (Traditional)</span></div>
      <div class="legend-entry" data-route="Tondaligan" data-type="modern"><img alt="Tondaligan modern icon"><span>Tondaligan (Modern)</span></div>
      <div class="legend-entry" data-route="Tondaligan" data-type="traditional"><img alt="Tondaligan traditional icon"><span>Tondaligan (Traditional)</span></div>
    </div>
    <div id="results" class="result"></div>

    <div class="card mt-3 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">My Trips</h6>
          <div class="d-flex gap-2"><button id="btnReloadTrips" class="btn btn-sm btn-outline-secondary">Reload</button><button id="btnExportTrips" class="btn btn-sm btn-outline-primary">Export</button></div>
        </div>
        <div class="table-responsive mt-2" style="max-height:180px;">
          <table class="table table-sm table-hover align-middle">
            <thead><tr><th>Date</th><th>Route</th><th>Start</th><th>End</th><th>Duration</th></tr></thead>
            <tbody id="tripRowsDest"><tr><td colspan="5" class="text-center text-muted">Loadingâ€¦</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <nav class="app-nav">
    <a href="destination.html" aria-label="Destination" class="active" style="grid-column:1"><i class="bi bi-geo-alt"></i><span>Destination</span></a>
    <a href="watch-ads.html" aria-label="Watch Ads" style="grid-column:2"><i class="bi bi-camera-reels"></i><span>Watch Ads</span></a>
    <span class="center-slot" aria-hidden="true" style="grid-column:3"></span>
    <a href="wallet.html" aria-label="Wallet" style="grid-column:4"><i class="bi bi-wallet2"></i><span>Wallet</span></a>
    <a href="my-profile.html" aria-label="Profile" style="grid-column:5"><i class="bi bi-person"></i><span>Profile</span></a>
    <a href="passenger-dashboard.html" class="home-fab" aria-label="Home"><i class="bi bi-house-door fs-3"></i></a>
  </nav>

  <!-- Leaflet JS for map rendering -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Lightweight module to compute straight-line distance using map markers -->
  <script type="module">
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    const resultsEl = document.getElementById('results');

    if (window.L && document.getElementById('map')) {
      const map = L.map('map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);

      let fromMarker=null, toMarker=null, line=null;

      // Fallback to Dagupan area
      let current=[16.0439, 120.3340];
      const setFrom = ([lat,lng])=>{
        if (fromMarker) fromMarker.setLatLng([lat,lng]);
        else fromMarker = L.marker([lat,lng], { draggable:true }).addTo(map).bindTooltip('From');
        fromMarker.on('dragend', ()=>{ const p=fromMarker.getLatLng(); fromEl.value='Pinned location'; fromEl.dataset.lat=p.lat; fromEl.dataset.lng=p.lng; draw(); });
        fromEl.dataset.lat=lat; fromEl.dataset.lng=lng;
      };
      const setTo = ([lat,lng])=>{
        if (toMarker) toMarker.setLatLng([lat,lng]);
        else toMarker = L.marker([lat,lng], { draggable:true }).addTo(map).bindTooltip('To');
        toMarker.on('dragend', ()=>{ const p=toMarker.getLatLng(); toEl.value='Pinned destination'; toEl.dataset.lat=p.lat; toEl.dataset.lng=p.lng; draw(); save(); });
        toEl.dataset.lat=lat; toEl.dataset.lng=lng;
      };
      const toRad = d=> d*Math.PI/180;
      const haversine = (a,b)=>{
        const R=6371; const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
        const sa=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
        return 2*R*Math.asin(Math.sqrt(sa));
      };
      function draw(){
        const a={lat:Number(fromEl.dataset.lat), lng:Number(fromEl.dataset.lng)};
        const b={lat:Number(toEl.dataset.lat), lng:Number(toEl.dataset.lng)};
        if(Number.isFinite(a.lat)&&Number.isFinite(a.lng)&&Number.isFinite(b.lat)&&Number.isFinite(b.lng)){
          setFrom([a.lat,a.lng]); setTo([b.lat,b.lng]);
          if(line) line.setLatLngs([[a.lat,a.lng],[b.lat,b.lng]]); else line=L.polyline([[a.lat,a.lng],[b.lat,b.lng]],{color:'#35a8f0'}).addTo(map);
          map.fitBounds(line.getBounds(), { padding:[20,20] });
          const km=haversine(a,b);
          resultsEl.innerHTML = `<div class=\"alert alert-info mb-2\"><strong>Distance:</strong> ${km.toFixed(2)} km (straight-line)</div>`;
        }
      }

      // Initialize center
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{ current=[pos.coords.latitude,pos.coords.longitude]; map.setView(current,14); setFrom(current); }, ()=>{ map.setView(current,13); setFrom(current); });
      } else { map.setView(current,13); setFrom(current); }

      // Load stops from backend so users can click markers to set destination
      (async ()=>{
        try{
          const r=await fetch('/api/stops'); if(!r.ok) return; const stops=await r.json();
          const g=L.layerGroup().addTo(map);
          stops.forEach(s=>{ const m=L.marker([s.latitude,s.longitude]).addTo(g).bindPopup(`<strong>${s.name}</strong>`);
            m.on('click', ()=>{ toEl.value=s.name; toEl.dataset.lat=s.latitude; toEl.dataset.lng=s.longitude; draw(); });
          });
        }catch{}
      })();

      // If user types exact stop name, snap to it
      toEl.addEventListener('change', async ()=>{
        try{
          const r=await fetch('/api/stops'); if(!r.ok) return; const stops=await r.json();
          const name=(toEl.value||'').trim().toLowerCase();
          const s=stops.find(x=> (x.name||'').toLowerCase()===name);
          if(s){ toEl.dataset.lat=s.latitude; toEl.dataset.lng=s.longitude; draw(); }
        }catch{}
      });
    }
  </script>

    <script type="module">
    import { requireRole, db, ref, get, query, orderByChild, equalTo } from './js/authentication.js';

    const { user } = await requireRole(['passenger']);
    const fromEl = document.getElementById('from');
    const toEl = document.getElementById('to');
    const results = document.getElementById('results');

    const PLACES = [
      {name:'Saint Gabriel The Archangel Parish', sub:'Religious stop', lat:16.0754843, lng:120.3546182},
      {name:'Alip, Boquig Waiting Shed', sub:'Student stop', lat:16.073742, lng:120.351614},
      {name:'Bonuan Boquig, Baranggay Hall', sub:'Government stop', lat:16.076286, lng:120.3557308},
      {name:'Sagor, Longos', sub:'Mixed area', lat:16.066106, lng:120.353298},
      {name:'Centro, Longos', sub:'Mixed area', lat:16.070591, lng:120.359635},
      {name:'Don Leon Francisco Maramba Elementary School, Longos', sub:'Student stop', lat:16.0710835, lng:120.3591833},
      {name:'Bonuan Boquig - Biazon Waiting Shed', sub:'Student stop', lat:16.0756322, lng:120.3656381},
      {name:'Bonuan Buquig National Highschool', sub:'Student stop', lat:16.078721, lng:120.360024},
      {name:'7 Eleven Bonuan', sub:'Commercial', lat:16.075331, lng:120.342945},
      {name:'North Central, Don Marcelo Elementary School', sub:'Student stop', lat:16.073780, lng:120.340295},
      {name:'MCDo Bonuan', sub:'Commercial', lat:16.0722655, lng:120.3386216},
      {name:'Nepo Mall', sub:'Commercial', lat:16.0511218, lng:120.3408555},
      {name:'Universidad de Dagupan', sub:'University', lat:16.0511218, lng:120.3408555},
      {name:'Junction', sub:'Transport hub', lat:16.046392, lng:120.343012},
      {name:'Region 1 Medical Center', sub:'Medical', lat:16.048645, lng:120.341774},
      {name:'CSI City Mall', sub:'Commercial', lat:16.043989, lng:120.335708},
      {name:'Hererro-Perez Waiting Shed', sub:'Student stop', lat:16.042155, lng:120.342460},
      {name:'Victory, Five Star', sub:'Transport hub', lat:16.042842, lng:120.344109},
      {name:'SM Center Dagupan', sub:'Commercial', lat:16.0444626, lng:120.3425649},
      {name:'DBP', sub:'Financial', lat:16.043786, lng:120.344272},
      {name:'Tondaligan Centro', sub:'Recreational', lat:16.084194, lng:120.348134},
      {name:'Region 1 MC Annex', sub:'Medical', lat:16.090689, lng:120.3622115},
      {name:'Bliss Waiting Shed, Binloc', sub:'Residential', lat:16.0935083, lng:120.3675867},
      {name:'Leisure Coast Resort', sub:'Recreational', lat:16.0959466, lng:120.3724469},
      {name:'Binloc Barangay Hall', sub:'Government', lat:16.1002609, lng:120.3778482}
    ];

    function render(list){
      results.innerHTML = list.map(p=>`<div class="item" data-name="${p.name}" data-sub="${p.sub}" data-lat="${p.lat}" data-lng="${p.lng}"><i class="bi bi-geo-alt-fill"></i><div><div class="name">${p.name}</div><div class="sub">${p.sub}</div></div></div>`).join('');
    }
    function filter(q){
      q = (q||'').toLowerCase();
      if(!q) return PLACES;
      return PLACES.filter(p=> p.name.toLowerCase().includes(q) || p.sub.toLowerCase().includes(q));
    }
    function sync(){ render(filter(toEl.value)); }

    results.addEventListener('click', (e)=>{
      const el = e.target.closest('.item'); if(!el) return;
      toEl.value = el.dataset.name;
      if (el.dataset.lat) toEl.dataset.lat = el.dataset.lat;
      if (el.dataset.lng) toEl.dataset.lng = el.dataset.lng;
      save();
    });
    document.querySelectorAll('.clear').forEach(btn=> btn.addEventListener('click', ()=>{
      const t = btn.getAttribute('data-clear');
      if (t === 'from') {
        fromEl.value='';
        delete fromEl.dataset.lat;
        delete fromEl.dataset.lng;
      } else {
        toEl.value='';
        delete toEl.dataset.lat;
        delete toEl.dataset.lng;
      }
      sync();
    }));
    toEl.addEventListener('input', sync);

    function save(){
      const data = { from: fromEl.value.trim(), to: toEl.value.trim(), ts: Date.now() };
      const lat = Number.parseFloat(toEl.dataset.lat || '');
      const lng = Number.parseFloat(toEl.dataset.lng || '');
      if (Number.isFinite(lat) && Number.isFinite(lng)) {
        data.lat = lat;
        data.lng = lng;
        data.radius = 40;
      }
      localStorage.setItem('dest_choice', JSON.stringify(data));
      if (Number.isFinite(lat) && Number.isFinite(lng) && window.JeepNiTracker && typeof window.JeepNiTracker.setPassengerDestination === 'function') {
        window.JeepNiTracker.setPassengerDestination({ lat, lng, name: data.to, radius: 40 });
      }
    }

    // Prefill and initial render
    if('geolocation' in navigator){ navigator.geolocation.getCurrentPosition(()=>{ fromEl.value = 'Your Location'; }, ()=>{}); }
    try{
      const prev = JSON.parse(localStorage.getItem('dest_choice')||'null');
      if(prev){
        fromEl.value = prev.from || fromEl.value;
        toEl.value = prev.to || '';
        if (Number.isFinite(prev.lat)) toEl.dataset.lat = prev.lat;
        if (Number.isFinite(prev.lng)) toEl.dataset.lng = prev.lng;
        if (window.JeepNiTracker && typeof window.JeepNiTracker.setPassengerDestination === 'function' && Number.isFinite(prev.lat) && Number.isFinite(prev.lng)) {
          window.JeepNiTracker.setPassengerDestination({ lat: prev.lat, lng: prev.lng, name: prev.to || '', radius: Number.isFinite(prev.radius) ? prev.radius : 40 });
        }
      }
    }catch(err){
      console.warn('Failed to restore destination preference', err);
    }
    sync();

    // ---- My Trips (same logic as dashboard) ----
    const tbody=document.getElementById('tripRowsDest');
    function fmt(ts){ if(!ts) return ''; const d= typeof ts==='number'?new Date(ts): ts?.seconds? new Date(ts.seconds*1000): null; return d? d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}):''; }
    async function loadTrips(){
      if(!tbody) return; tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Loadingâ€¦</td></tr>';
      const trips=[];
      try{
        const s1 = await get(ref(db,`user_trips/${user.uid}`));
        if(s1.exists()){
          const byDate=s1.val()||{};
          for(const date of Object.keys(byDate)){
            for(const id of Object.keys(byDate[date]||{})){
              const t=byDate[date][id]||{}; const start=t.start?.ts; const end=t.end?.ts;
              const dur=(start&&end)? Math.max(0, Math.round(((typeof end==='number'?end:end?.seconds*1000)-(typeof start==='number'?start:start?.seconds*1000))/60000)):'';
              trips.push({date: t.date||date, route:t.route||'', start:fmt(start), end:fmt(end), duration: dur!==''? dur+'m':''});
            }
          }
        } else {
          const q = query(ref(db,'trip_logs'), orderByChild('driver_uid'), equalTo(user.uid));
          const s2 = await get(q);
          if(s2.exists()){
            const byId=s2.val()||{};
            for(const id of Object.keys(byId)){
              const t=byId[id]||{}; const start=t.start?.ts; const end=t.end?.ts; const d = start? new Date(typeof start==='number'?start:start?.seconds*1000).toISOString().slice(0,10):'';
              const dur=(start&&end)? Math.max(0, Math.round(((typeof end==='number'?end:end?.seconds*1000)-(typeof start==='number'?start:start?.seconds*1000))/60000)):'';
              trips.push({date: t.date||d, route:t.route||'', start:fmt(start), end:fmt(end), duration: dur!==''? dur+'m':''});
            }
          }
        }
      }catch{}
      if(!trips.length){ tbody.innerHTML='<tr><td colspan="5" class="text-center text-muted">No trips yet</td></tr>'; return; }
      trips.sort((a,b)=> a.date<b.date?1:-1);
      tbody.innerHTML= trips.map(t=>`<tr><td>${t.date}</td><td>${t.route}</td><td>${t.start}</td><td>${t.end}</td><td>${t.duration}</td></tr>`).join('');
    }
    async function exportTrips(){
      const rows=[["Date","Route","Start","End","Duration"]];
      try{
        const s1 = await get(ref(db,`user_trips/${user.uid}`));
        if(s1.exists()){
          const byDate=s1.val()||{};
          for(const date of Object.keys(byDate)) for(const id of Object.keys(byDate[date]||{})){
            const t=byDate[date][id]||{}; rows.push([t.date||date, t.route||'', fmt(t.start?.ts), fmt(t.end?.ts), '']);
          }
        } else {
          const q = query(ref(db,'trip_logs'), orderByChild('driver_uid'), equalTo(user.uid));
          const s2 = await get(q); if(s2.exists()){
            const byId=s2.val()||{}; for(const id of Object.keys(byId)){
              const t=byId[id]||{}; const start=t.start?.ts; const end=t.end?.ts; const d = start? new Date(typeof start==='number'?start:start?.seconds*1000).toISOString().slice(0,10):'';
              rows.push([t.date||d, t.route||'', fmt(start), fmt(end), '']);
            }
          }
        }
      }catch{}
      const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='my_trips.csv'; a.click(); URL.revokeObjectURL(url);
    }
    document.getElementById('btnReloadTrips')?.addEventListener('click', loadTrips);
    document.getElementById('btnExportTrips')?.addEventListener('click', exportTrips);
    const legendEl = document.getElementById('legend');
    if (legendEl && typeof window.getIconUrl === 'function') {
      legendEl.querySelectorAll('.legend-entry').forEach((entry) => {
        const route = entry.dataset.route;
        const type = entry.dataset.type;
        const img = entry.querySelector('img');
        if (!route || !type || !img) return;
        const prefix = type === 'traditional' ? 'old' : '';
        img.src = window.getIconUrl(`${prefix}${route}.png`);
      });
    }
    loadTrips();
  </script>
</body>
</html>


