<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi — Driver Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="css/driver-dashboard.css" />

  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
<nav class="navbar border-bottom">
  <div class="container">
    <span class="navbar-brand fw-semibold">JeepNi — Driver Dashboard</span>
    <div class="ms-auto d-flex align-items-center gap-2">
      <span id="driverInfo" class="small text-muted">Checking session…</span>
      <div class="ms-auto d-flex align-items-center gap-2">
          <a href="my-profile.html" class="btn btn-outline-secondary btn-sm">My Profile</a>
          <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div id="alerts"></div>
    <!-- NEW: Driver assignment -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title d-flex align-items-center justify-content-between">
        Today’s Assignment
        <div class="d-flex gap-2">
          <button id="btnAccept"   class="btn btn-sm btn-outline-primary">Accept</button>
          <button id="btnEnroute"  class="btn btn-sm btn-outline-success">Start (En-route)</button>
          <button id="btnComplete" class="btn btn-sm btn-outline-secondary">Complete</button>
        </div>
      </h5>
      <div id="assignBox" class="small text-muted">Loading…</div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Profile</h5>
          <div id="profileBox">Loading…</div>
          <hr>
          <button id="btnEdit" class="btn btn-outline-primary btn-sm">Edit Profile</button>
        </div>
      </div>

      <div class="card shadow-sm mt-3">
        <div class="card-body">
          <h5 class="card-title">Trip Logs</h5>
          <button id="btnExportTrips" class="btn btn-sm btn-outline-secondary">Export My Trips</button>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card shadow-sm mt-3">
            <div class="card-body">
              <h5 class="card-title d-flex justify-content-between align-items-center">
                Live Map
                <div class="d-flex align-items-center gap-2">
                  <span id="capBadge" class="badge bg-success">Available</span>
                  <button id="btnToggleFull" class="btn btn-sm btn-outline-danger">Mark FULL</button>
                  <button id="btnStopTracking" class="btn btn-sm btn-outline-warning d-none">Stop Sharing</button>
                </div>
              </h5>
              <div id="map"></div>
            </div>
          </div>
        <div class="card-body">
          <h5 class="card-title d-flex justify-content-between align-items-center mb-0">
            My Recent Trips
            <button id="btnReload" class="btn btn-sm btn-outline-secondary">Reload</button>
          </h5>
          <div class="table-responsive mt-3">
            <table class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Route</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody id="tripRows">
                <tr><td colspan="5" class="text-center text-muted py-4">Loading…</td></tr>
              </tbody>
            </table>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</main>
<script type="module">
  /* Imports */
  import { requireRole, signOutAndRedirect, auth, db, ref, get, update, onValue, serverTimestamp } from "./js/authentication.js";
  import { query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";
  import { startTrip } from "./js/create-trip.js";
  import { updateLocation, endTrip } from "./js/trip-tracking.js";
  import { myAssignments, setStatus } from "./js/scheduling.js";
  // Use tracker helpers to begin/stop sharing tied to trips
  import { beginSharing, stopSharing, isSharing, setMyFull } from "./js/map-tracker.js";

const alertBox = document.getElementById("alerts");
  function showAlert(msg, type = "warning") {
    alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
      ${msg}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>`;
  }

  /* Auth */
  const { user } = await requireRole(['driver'], { onDeny: () => alert('Access denied. Drivers only.') });
  document.getElementById("driverInfo").textContent = user.email;

  /* Profile */
  async function loadProfile() {
    const snap = await get(ref(db, `drivers/${user.uid}`));
    if (!snap.exists()) { showAlert("Profile not found.", "danger"); return; }
    const d = snap.val();
    document.getElementById("profileBox").innerHTML = `
      <div><strong>Name:</strong> ${d.name || ""}</div>
      <div><strong>Email:</strong> ${d.email || ""}</div>
    `;
  }

  /* Trips (query by driver_uid to satisfy your rules) */
  async function fetchMyTrips() {
    const q = query(ref(db, "trip_logs"), orderByChild("driver_uid"), equalTo(auth.currentUser.uid));
    const snap = await get(q);
    if (!snap.exists()) return [];
    // trip_logs/<tripId> => { ...fields }
    return Object.entries(snap.val() || {}).map(([id, t]) => ({ id, ...t }));
  }

  async function loadTrips() {
    const tbody = document.getElementById("tripRows");
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Loading…</td></tr>`;

    const trips = await fetchMyTrips();
    if (trips.length === 0) {
      tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No trips yet</td></tr>`;
      return;
    }

    tbody.innerHTML = trips.map(t => `
      <tr>
        <td>${t.date || ""}</td>
        <td>${t.route || ""}</td>
        <td>${t.start?.ts ? new Date(t.start.ts).toLocaleString() : ""}</td>
        <td>${t.end?.ts ? new Date(t.end.ts).toLocaleString() : ""}</td>
        <td>${t.duration || ""}</td>
      </tr>
    `).join("");
  }

  /* Export trips as CSV using same query */
  async function exportTripsCsv() {
    const trips = await fetchMyTrips();
    if (trips.length === 0) { showAlert("No trips to export.", "info"); return; }
    const rows = [["Date", "Route", "Start", "End", "Duration"]];
    for (const t of trips) {
      rows.push([
        t.date || "",
        t.route || "",
        t.start?.ts ? new Date(t.start.ts).toISOString() : "",
        t.end?.ts ? new Date(t.end.ts).toISOString() : "",
        t.duration || ""
      ]);
    }
    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "my_trips.csv"; a.click();
    URL.revokeObjectURL(url);
  }

  /* Button references */
  const btnAccept = document.getElementById('btnAccept');
  const btnEnroute = document.getElementById('btnEnroute');
  const btnComplete = document.getElementById('btnComplete');
  const btnStopTracking = document.getElementById('btnStopTracking');

  /* Status update function */
  async function updateDriverStatus(newStatus) {
    try {
      // Make sure we have a current dispatch before proceeding
      if (!currentDispatch) {
        showAlert('No active assignment found', 'warning');
        return;
      }

      await setStatus({
        date: currentDispatch.date,
        dispatchId: currentDispatch.id,
        status: newStatus
      });
      
      // Show/hide stop tracking button based on status
      if (newStatus === 'enroute') {
        btnStopTracking.classList.remove('d-none');
      } else {
        btnStopTracking.classList.add('d-none');
      }

      // Update button states
      btnAccept.disabled = newStatus !== 'available';
      btnEnroute.disabled = newStatus !== 'accepted';
      btnComplete.disabled = newStatus !== 'enroute';
      
      // Handle location sharing based on status
        if (newStatus === 'enroute') {
          await beginSharing();
          btnStopTracking.classList.remove('d-none');
          showAlert('Location sharing started', 'success');
        } else if (newStatus === 'completed') {
          await stopSharing();
          btnStopTracking.classList.add('d-none');
          showAlert('Location sharing stopped', 'success');
        }
      
      await loadMyAssignment();
      
    } catch (err) {
      console.error('Failed to update status:', err);
      showAlert('Failed to update status: ' + err.message, 'danger');
    }
  }

  /* Wire buttons */
  document.getElementById("btnReload").addEventListener("click", loadTrips);
  document.getElementById("btnEdit").addEventListener("click", () => location.href = "driver-edit.html");
  document.getElementById("btnExportTrips").addEventListener("click", exportTripsCsv);
  document.getElementById("btnLogout").addEventListener("click", () => signOutAndRedirect("login.html"));

  if (btnAccept) {
    btnAccept.addEventListener('click', () => updateDriverStatus('accepted'));
  }

  if (btnEnroute) {
    btnEnroute.addEventListener('click', () => updateDriverStatus('enroute'));
  }

  if (btnComplete) {
    btnComplete.addEventListener('click', () => updateDriverStatus('completed'));
  }

// Add stop sharing button handler
btnStopTracking.addEventListener('click', async () => {
  try {
    // Stop location sharing completely
    await stopSharing();
    
    // Hide the stop button
    btnStopTracking.classList.add('d-none');
    
    // Update capacity badge to show not active
    capBadge.className = 'badge bg-secondary';
    capBadge.textContent = 'Offline';
    
    showAlert('Location sharing stopped - your marker has been removed from the map', 'success');
    
    // Optionally mark trip as completed if currently enroute
    if (currentDispatch && currentDispatch.status === 'enroute') {
      try {
        await setStatus({
          date: currentDispatch.date,
          dispatchId: currentDispatch.id,
          status: 'completed'
        });
        await loadMyAssignment();
        
        // Reset capacity UI
        fullState = false;
        renderCapUI();
      } catch (statusErr) {
        console.warn('Could not auto-complete trip:', statusErr);
      }
    }
  } catch (err) {
    console.error('Failed to stop sharing:', err);
    showAlert('Failed to stop sharing: ' + err.message, 'danger');
  }
});

  await loadProfile();
  try {
    await loadTrips();
  } catch (e) {
    console.warn('loadTrips failed but continuing UI init:', e?.message || e);
    // Keep the page functional even if trips are not readable
    const tbody = document.getElementById('tripRows');
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Trips unavailable.</td></tr>`;
  }

  /* Capacity FULL toggle (near map) */
  const capBadge = document.getElementById('capBadge');
  const btnToggleFull = document.getElementById('btnToggleFull');
  let fullState = false;

  function renderCapUI() {
    if (fullState) {
      capBadge.className = 'badge bg-danger';
      capBadge.textContent = 'FULL';
      btnToggleFull.className = 'btn btn-sm btn-danger';
      btnToggleFull.textContent = 'Set Available';
    } else {
      capBadge.className = 'badge bg-success';
      capBadge.textContent = 'Available';
      btnToggleFull.className = 'btn btn-sm btn-outline-danger';
      btnToggleFull.textContent = 'Mark FULL';
    }
  }

  onValue(ref(db, `drivers_location/${user.uid}`), (snap) => {
    const v = snap.exists() ? snap.val() : {};
    fullState = !!v.full;
    renderCapUI();
    try { window.JeepNiTracker?.setMyFull(fullState); } catch {}
  });

  btnToggleFull.addEventListener('click', async () => {
    try {
      fullState = !fullState;
      renderCapUI();
      await update(ref(db, `drivers_location/${user.uid}`), { full: fullState, last_update: serverTimestamp() });
      // Update my marker badge immediately if tracker is loaded
      try { window.JeepNiTracker?.setMyFull(fullState); } catch {}
      showAlert(fullState ? 'You are now marked FULL.' : 'You are now Available.', 'success');
    } catch (e) {
      showAlert('Failed to update capacity: ' + e.message, 'danger');
    }
  });

  /* Dispatch (assignments) */
  const assignBox = document.getElementById("assignBox");
  let currentDispatch = null;

  function fmtAssign(a) {
    if (!a) return "No assignment yet.";
    return `Time: <strong>${a.dep_time || ""}</strong> — Route: <strong>${a.route || ""}</strong> — Jeep: <strong>${a.jeep_id || ""}</strong> — Status: <strong>${a.status || ""}</strong>`;
  }

  async function loadMyAssignment() {
    const today = new Date().toISOString().slice(0, 10);
    const mine = await myAssignments(today);
    currentDispatch = mine[0] || null; // pick earliest if multiple
    assignBox.innerHTML = fmtAssign(currentDispatch);

    const has = !!currentDispatch;
    document.getElementById("btnAccept").disabled   = !has || currentDispatch.status !== "assigned";
    document.getElementById("btnEnroute").disabled  = !has || !["assigned", "accepted"].includes(currentDispatch.status);
    document.getElementById("btnComplete").disabled = !has || currentDispatch.status !== "enroute";
  }

  async function changeStatus(next) {
    if (!currentDispatch) return;
    
    try {
      await setStatus({ date: currentDispatch.date, dispatchId: currentDispatch.id, status: next });

      if (next === "enroute") {
        if (!isSharing()) {
          // Create trip first
          const tripId = await startTrip({
            driver_uid: user.uid,
            route: currentDispatch.route,
            date: currentDispatch.date
          });
          
          // Start sharing with trip ID AND assigned route
          await beginSharing(tripId, currentDispatch.route);
          window.JeepNiTracker?.setActiveTripId(tripId);
          
          // Show stop button
          btnStopTracking.classList.remove('d-none');
          
          showAlert("Trip started and location sharing active.", "success");
        }
      } else if (next === "completed") {
        await stopSharing();
        
        // Hide stop button
        btnStopTracking.classList.add('d-none');
        
        showAlert("Trip completed and location sharing stopped.", "success");
      }
    } catch (err) {
      console.error("Status change error:", err);
      showAlert("Failed to change status: " + err.message, "danger");
    }

    await loadMyAssignment();
    await loadTrips();
  }

  document.getElementById("btnAccept").addEventListener("click", () => changeStatus("accepted"));
  document.getElementById("btnEnroute").addEventListener("click", () => changeStatus("enroute"));
  document.getElementById("btnComplete").addEventListener("click", () => changeStatus("completed"));

  await loadMyAssignment();

  /* Initial button state setup */
  async function initializeButtonStates() {
    try {
      const driverRef = ref(db, `drivers/${user.uid}`);
      const snapshot = await get(driverRef);
      
      if (snapshot.exists()) {
        const currentStatus = snapshot.val().status || 'available';
        
        // Set initial button states
        btnAccept.disabled = currentStatus !== 'available';
        btnEnroute.disabled = currentStatus !== 'accepted';
        btnComplete.disabled = currentStatus !== 'enroute';
      }
    } catch (err) {
      console.error('Failed to initialize button states:', err);
    }
  }

  // Call this after user authentication
  await initializeButtonStates();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

  (function(){
    const em = String.fromCharCode(8212);
    try {
      document.title = `JeepNi ${em} Driver Dashboard`;
      const brand = document.querySelector('.navbar .navbar-brand');
      if (brand) brand.textContent = `JeepNi ${em} Driver Dashboard`;
    } catch (_) {}
  })();
</script>
<script type="module">
  import './js/map-tracker.js';
</script>
</body>
</html>