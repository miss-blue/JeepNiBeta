<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi! — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { background:#f6f7fb; }
    .card { border-radius: 16px; }
    .table-sm td, .table-sm th { padding:.45rem .5rem; }
  </style>
  <style>
    /* Subtle scenic background 2 with low opacity */
    body{ position: relative; }
    body::before{
      content:""; position: fixed; inset:0;
      background: url('icons/Background2.png') center bottom / cover no-repeat;
      opacity:.15; pointer-events:none; z-index:-1;
    }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-light border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">JeepNi! Dashboard</a>
    <div class="ms-auto">
      <button id="btnExportMyTrips" class="btn btn-outline-primary btn-sm">Export My Trips (CSV)</button>
      <button id="btnLogout" class="btn btn-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div id="alerts"></div>

  <div class="row g-3">
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">Profile</h5>
          <div id="profileBox">
            <div class="placeholder-glow">
              <span class="placeholder col-6"></span>
              <span class="placeholder col-7"></span>
              <span class="placeholder col-4"></span>
            </div>
          </div>
          <hr>
          <div id="statsBox" class="small text-muted"></div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <h5 class="card-title mb-0">Recent Trips</h5>
            <input id="dateFilter" type="date" class="form-control form-control-sm" style="width:auto">
          </div>
          <div class="table-responsive mt-3">
            <table class="table table-striped table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Route</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Duration</th>
                </tr>
              </thead>
              <tbody id="tripRows">
                <tr><td colspan="6" class="text-center text-muted py-4">Loading…</td></tr>
              </tbody>
            </table>
          </div>
          <div class="text-end">
            <button id="btnReloadTrips" class="btn btn-outline-secondary btn-sm">Reload</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script type="module">
import { auth, db, ref, get, query, orderByChild, equalTo, requireRole, signOutAndRedirect, getRole } from "./js/authentication.js";

function showAlert(html, type="warning") {
  const box = document.getElementById("alerts");
  box.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    ${html}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
}

function fmtTime(ts) {
  if (!ts) return "";
  const d = new Date(typeof ts === "number" ? ts : ts.seconds ? ts.seconds * 1000 : 0);
  return d.toLocaleTimeString();
}

function fmtDate(dateStr) {
  if (!dateStr) return "";
  return dateStr;
}

function fmtLatLng(obj) { 
  if (obj && typeof obj.lat === "number" && typeof obj.lng === "number") {
    return `${obj.lat.toFixed(5)}, ${obj.lng.toFixed(5)}`;
  }
  return "";
}

function fmtDur(startTs, endTs) {
  if (!startTs || !endTs) return "";
  const start = typeof startTs === "number" ? startTs : startTs.seconds ? startTs.seconds * 1000 : 0;
  const end = typeof endTs === "number" ? endTs : endTs.seconds ? endTs.seconds * 1000 : 0;
  const mins = Math.round((end - start) / 60000);
  return mins > 0 ? mins + " min" : "";
}

const { user: currentUser } = await requireRole(['driver', 'passenger'], {
  onDeny: () => alert('Access denied. Drivers or passengers only.')
});

await loadProfile();
await loadTrips();

async function loadProfile() {
  if (!currentUser) return;
  
  try {
    const userSnap = await get(ref(db, `all_users/${currentUser.uid}`));
    const userData = userSnap.exists() ? userSnap.val() : {};
    
    const role = await getRole(currentUser.uid);
    
    document.getElementById("profileBox").innerHTML = `
      <div><span class="text-muted">Name:</span> <strong>${userData.name || currentUser.displayName || ""}</strong></div>
      <div><span class="text-muted">Email:</span> ${currentUser.email || ""}</div>
      <div><span class="text-muted">Role:</span> <span class="badge bg-primary">${role}</span></div>
      <div class="mt-2 small text-muted">UID: ${currentUser.uid.slice(0,6)}…</div>
    `;

    // Get trip count stats
    const tripStats = await getMyTripStats();
    document.getElementById("statsBox").innerHTML = `
      <div>Total trips: <strong>${tripStats.total}</strong></div>
      <div class="text-muted">This month: ${tripStats.thisMonth}</div>
    `;
  } catch (e) {
    showAlert("Failed to load profile. " + e.message, "danger");
  }
}

async function getMyTripStats() {
  if (!currentUser) return { total: 0, thisMonth: 0 };
  
  try {
    // Query trips by driver_uid or passenger_uid
    const role = await getRole(currentUser.uid);
    let tripSnap;
    
    if (role === "driver") {
      // For drivers, look in trip_logs with driver_uid
      const q = query(ref(db, "trip_logs"), orderByChild("driver_uid"), equalTo(currentUser.uid));
      tripSnap = await get(q);
    } else {
      // For passengers, look in their personal trip log
      tripSnap = await get(ref(db, `trip_logs/${currentUser.uid}`));
    }
    
    if (!tripSnap.exists()) return { total: 0, thisMonth: 0 };
    
    const trips = tripSnap.val();
    const tripArray = role === "driver" ? Object.values(trips) : 
      Object.entries(trips).map(([date, trip]) => ({ ...trip, date }));
    
    const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
    const thisMonth = tripArray.filter(trip => 
      trip.date && trip.date.startsWith(currentMonth)
    ).length;
    
    return {
      total: tripArray.length,
      thisMonth
    };
  } catch (e) {
    console.warn("Failed to get trip stats:", e);
    return { total: 0, thisMonth: 0 };
  }
}

async function loadTrips() {
  if (!currentUser) return;
  
  const tbody = document.getElementById("tripRows");
  tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">Loading…</td></tr>`;

  try {
    const role = await getRole(currentUser.uid);
    let tripSnap;
    
    if (role === "driver") {
      // For drivers, query by driver_uid
      const q = query(ref(db, "trip_logs"), orderByChild("driver_uid"), equalTo(currentUser.uid));
      tripSnap = await get(q);
    } else {
      // For passengers, get from their personal log
      tripSnap = await get(ref(db, `trip_logs/${currentUser.uid}`));
    }

    if (!tripSnap.exists()) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No trips found.</td></tr>`;
      return;
    }

    const trips = tripSnap.val();
    let tripArray;
    
    if (role === "driver") {
      tripArray = Object.values(trips);
    } else {
      // Convert date-keyed trips to array
      tripArray = Object.entries(trips).map(([date, trip]) => ({
        ...trip,
        date: date
      }));
    }

    // Filter by date if specified
    const dateFilter = document.getElementById("dateFilter").value;
    if (dateFilter) {
      tripArray = tripArray.filter(trip => trip.date === dateFilter);
    }

    // Sort by date descending
    tripArray.sort((a, b) => (b.date || "").localeCompare(a.date || ""));

    if (tripArray.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">No trips found for selected date.</td></tr>`;
      return;
    }

    tbody.innerHTML = tripArray.slice(0, 10).map(trip => `
      <tr>
        <td>${fmtDate(trip.date)}</td>
        <td>${fmtTime(trip.start?.ts)} — ${fmtTime(trip.end?.ts)}</td>
        <td>${trip.route || ""}</td>
        <td>${fmtLatLng(trip.start)}</td>
        <td>${fmtLatLng(trip.end)}</td>
        <td>${fmtDur(trip.start?.ts, trip.end?.ts)}</td>
      </tr>
    `).join("");
  } catch (e) {
    showAlert("Failed to load trips. " + e.message, "danger");
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error loading trips</td></tr>`;
  }
}

// Event listeners
document.getElementById("btnReloadTrips").addEventListener("click", loadTrips);
document.getElementById("dateFilter").addEventListener("change", loadTrips);

document.getElementById("btnExportMyTrips").addEventListener("click", async () => {
  if (!currentUser) return;
  
  try {
    const role = await getRole(currentUser.uid);
    let tripSnap;
    
    if (role === "driver") {
      const q = query(ref(db, "trip_logs"), orderByChild("driver_uid"), equalTo(currentUser.uid));
      tripSnap = await get(q);
    } else {
      tripSnap = await get(ref(db, `trip_logs/${currentUser.uid}`));
    }

    if (!tripSnap.exists()) {
      showAlert("No trips to export.", "info");
      return;
    }

    const trips = tripSnap.val();
    let tripArray;
    
    if (role === "driver") {
      tripArray = Object.values(trips);
    } else {
      tripArray = Object.entries(trips).map(([date, trip]) => ({ ...trip, date }));
    }

    // Create CSV
    const headers = ["Date", "Route", "Start Time", "End Time", "Start Location", "End Location", "Duration"];
    const csvRows = [headers.join(",")];
    
    tripArray.forEach(trip => {
      const row = [
        trip.date || "",
        trip.route || "",
        fmtTime(trip.start?.ts),
        fmtTime(trip.end?.ts),
        fmtLatLng(trip.start),
        fmtLatLng(trip.end),
        fmtDur(trip.start?.ts, trip.end?.ts)
      ].map(field => `"${String(field).replace(/"/g, '""')}"`);
      csvRows.push(row.join(","));
    });
    
    const csvContent = csvRows.join("\n");
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `my_trips_${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (e) {
    showAlert("Failed to export trips. " + e.message, "danger");
  }
});

document.getElementById("btnLogout").addEventListener("click", () => {
  signOutAndRedirect("login.html");
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
