<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Driver Codes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f7fb; }
    .container { max-width: 960px; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg bg-light shadow-sm">
  <div class="container">
    <a class="navbar-brand fw-bold" href="secure-admin-dashboard.html">JeepNi — Admin</a>
    <div class="ms-auto small text-muted" id="adminInfo">Checking session…</div>
  </div>
</nav>

<main class="container py-4">
  <h3 class="mb-3">Driver Invite Codes</h3>
  <div id="alert"></div>

  <form id="formCode" class="row g-2 mb-4">
    <div class="col-md-4">
      <input id="code" class="form-control" placeholder="Code (e.g. BOQUIG2025)" required>
    </div>
    <div class="col-md-2">
      <input id="uses" type="number" class="form-control" placeholder="Uses Left" value="10" min="0">
    </div>
    <div class="col-md-3">
      <input id="expires" type="date" class="form-control">
    </div>
    <div class="col-md-3 d-grid">
      <button class="btn btn-primary" type="submit">Create / Update</button>
    </div>
  </form>

  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle">
      <thead>
        <tr><th>Code</th><th>Uses Left</th><th>Expires</th><th>Status</th><th style="width:180px">Actions</th></tr>
      </thead>
      <tbody id="codeTable">
        <tr><td colspan="5" class="text-center text-muted">Loading…</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script type="module">
import { db, ref, set, onValue, update } from "./js/authentication.js";
import { requireAdmin, attachAdminBadge } from "./js/admin_auth.js";

await requireAdmin("login.html");
attachAdminBadge("#adminInfo");

const form = document.getElementById("formCode");
const table = document.getElementById("codeTable");
const alertBox = document.getElementById("alert");

function show(msg,type="success"){
  alertBox.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
    ${msg}<button class="btn-close" data-bs-dismiss="alert"></button>
  </div>`;
}

form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const code = document.getElementById("code").value.trim().toUpperCase();
  const uses = parseInt(document.getElementById("uses").value||"0",10);
  const exp  = document.getElementById("expires").value;

  if(!code){ show("Enter a code","danger"); return; }

  const data = { is_active: true };
  if (!Number.isNaN(uses) && uses >= 0) data.uses_left = uses;
  if (exp) data.expires_at = new Date(exp).getTime();

  await set(ref(db, "driver_invite_codes/"+code), data);
  show(`Code <strong>${code}</strong> created/updated.`, "success");
  form.reset();
});

function renderRow(code, c) {
  const uses = (c.uses_left ?? "∞");
  const expires = c.expires_at ? new Date(c.expires_at).toLocaleDateString() : "—";
  const status = c.is_active ? "Active" : "Disabled";
  return `<tr data-code="${code}">
    <td><code>${code}</code></td>
    <td>${uses}</td>
    <td>${expires}</td>
    <td><span class="badge ${c.is_active?'bg-success':'bg-secondary'}">${status}</span></td>
    <td class="d-flex gap-2">
      <button class="btn btn-sm btn-outline-secondary toggleBtn">${c.is_active?'Disable':'Enable'}</button>
      <button class="btn btn-sm btn-outline-danger zeroBtn">Zero Uses</button>
    </td>
  </tr>`;
}

// Live table
onValue(ref(db,"driver_invite_codes"), snap=>{
  if(!snap.exists()){ table.innerHTML="<tr><td colspan='5' class='text-center text-muted'>No codes yet</td></tr>"; return; }
  const obj=snap.val();
  table.innerHTML = Object.keys(obj).sort().map(code => renderRow(code, obj[code] || {})).join("");

  // Wire actions
  table.querySelectorAll(".toggleBtn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const tr   = btn.closest("tr");
      const code = tr.getAttribute("data-code");
      const badge= tr.querySelector(".badge");
      const active = badge?.textContent === "Active";
      await update(ref(db, "driver_invite_codes/"+code), { is_active: !active });
      show(`Code ${code} is now ${!active ? 'Active' : 'Disabled'}.`, "success");
    });
  });
  table.querySelectorAll(".zeroBtn").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const tr   = btn.closest("tr");
      const code = tr.getAttribute("data-code");
      await update(ref(db, "driver_invite_codes/"+code), { uses_left: 0 });
      show(`Code ${code} uses set to 0.`, "success");
    });
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
