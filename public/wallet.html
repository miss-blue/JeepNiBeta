<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi â€“ Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root{ --blue:#35a8f0; --blue2:#2fa2eb; --bg:#eef5fb; --text:#0d2742; --muted:#6b7b8a; }
    html,body{height:100%}
    body{ margin:0; background: url('icons/Background1.png') center bottom / cover no-repeat, linear-gradient(180deg,#cfefff,#f6fbff); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .hero{ padding: 16px 16px 6px; color: #fff; background: linear-gradient(180deg, rgba(53,168,240,.9), rgba(53,168,240,.65)); position: relative; }
    .hero .row1{ display:flex; justify-content:space-between; align-items:center }
    .avatar{ width:54px; height:54px; border-radius:50%; background: rgba(255,255,255,.85); display:grid; place-items:center; color:#658; box-shadow:0 8px 24px rgba(0,0,0,.18) }
    .hello{ font-weight:800; letter-spacing:.4px; text-transform:uppercase }
    .bell{ width:40px; height:40px; border-radius:50%; background: rgba(255,255,255,.95); display:grid; place-items:center; color:#345; box-shadow:0 8px 24px rgba(0,0,0,.18) }
    .bal{ display:flex; align-items:center; gap:10px; margin:10px 0 }
    .bal .coin{ width:48px; height:48px; border-radius:50%; background: radial-gradient(circle at 30% 30%, #ffe082, #f3b300); display:grid; place-items:center; color:#7b4d0f; font-size:24px }
    .bal .amount{ font-size:40px; font-weight:900; line-height:1 }
    .addr{ display:inline-flex; align-items:center; gap:8px; background: rgba(255,255,255,.85); color:#173a66; padding:6px 10px; border-radius:10px; font-weight:700 }
    .tiles{ display:flex; gap:14px; justify-content:center; padding:14px 12px }
    .tile{ width:112px; height:102px; border-radius:16px; background:#e6f3fd; color:#203a55; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-weight:800; box-shadow:0 10px 24px rgba(0,0,0,.12); transition: transform 0.2s; }
    .tile:hover { transform: translateY(-3px); }
    .tile i{ font-size:28px; margin-bottom:8px }
    .sheet{ background: rgba(255,255,255,.88); backdrop-filter: blur(6px); border-radius:22px; box-shadow:0 20px 40px rgba(0,0,0,.18); padding:14px; margin: 8px 12px 100px }
    .section-title{ color:#2a476a; font-weight:800; margin-bottom:8px }

    /* QR Code Styles */
    .qr-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .qr-code { width: 200px; height: 200px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .qr-instructions { text-align: center; color: var(--muted); font-size: 14px; max-width: 300px; }
    .payment-actions { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    
    /* Scanner Styles */
    .scanner-container { display: flex; flex-direction: column; align-items: center; gap: 15px; }
    .scanner-placeholder { width: 250px; height: 250px; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 12px; display: grid; place-items: center; }
    .scanner-instructions { text-align: center; color: var(--muted); font-size: 14px; max-width: 300px; }
    
    /* Payment History */
    .transaction-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
    .transaction-details { flex: 1; }
    .transaction-amount { font-weight: 700; }
    .transaction-date { font-size: 12px; color: var(--muted); }
    .transaction-positive { color: #28a745; }
    .transaction-negative { color: #dc3545; }

    /* Tabs for QR display/scan */
    .qr-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .qr-tab { flex: 1; text-align: center; padding: 10px; border-radius: 8px; background: #e6f3fd; cursor: pointer; font-weight: 600; }
    .qr-tab.active { background: var(--blue); color: white; }

    /* Bottom nav */
    .app-nav{ position:fixed; left:0; right:0; bottom:0; height:84px; z-index:10; background:linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.95)); backdrop-filter:blur(8px); border-top:1px solid rgba(0,0,0,.06); display:grid; grid-template-columns:1fr 1fr 72px 1fr 1fr; align-items:center; }
    .app-nav a{ text-decoration:none; color:#6b7b8a; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; min-width:0 }
    .app-nav a .bi{ font-size:20px }
    .home-fab{ position:absolute; left:50%; transform:translateX(-50%); bottom:22px; width:64px; height:64px; border-radius:50%; background:linear-gradient(180deg,#8be3ff,#35a8f0); color:#fff; display:grid; place-items:center; box-shadow:0 16px 32px rgba(0,0,0,.25); border:4px solid #fff }
    .app-nav .center-slot{ width:72px; height:1px }
    .active{ color:#2a476a !important; font-weight:800 }

    .form-pill{ border-radius:12px; border:2px solid #cae4fb; padding:10px 12px; display:flex; align-items:center; gap:10px; background:#fff }
    .btn-primary{ background:linear-gradient(180deg,#8be3ff,#35a8f0); border:none; font-weight:800 }
    .result-card{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 10px 24px rgba(0,0,0,.06); }
  </style>
</head>
<body>
  <header class="hero">
    <div class="row1">
      <div class="d-flex align-items-center gap-2">
        <div class="avatar"><i class="bi bi-person"></i></div>
        <div>
          <div class="hello">Hello,</div>
          <div id="helloName" class="fw-bold">User</div>
        </div>
      </div>
      <div class="bell"><i class="bi bi-bell"></i></div>
    </div>
    <div class="bal">
      <div class="coin"><i class="bi bi-coin"></i></div>
      <div class="amount" id="amount">0</div>
    </div>
    <div class="addr"><span id="walletAddr">0x1234...abcd</span> <button id="copyAddr" class="btn btn-sm btn-outline-secondary py-0">Copy</button></div>
  </header>

  <section class="tiles">
    <a href="#" id="btnTxn" class="tile"><i class="bi bi-clock-history"></i><div>Transaction<br>History</div></a>
    <a href="#" id="btnFare" class="tile"><i class="bi bi-cash-coin"></i><div>Fare<br>Information</div></a>
    <a href="#" id="btnPay" class="tile"><i class="bi bi-qr-code"></i><div>Pay<br>Driver</div></a>
  </section>

  <main id="panel" class="sheet">
    <div class="section-title">Recent Transaction History <a href="#" class="float-end small">See all</a></div>
    <div id="historyEmpty" class="text-muted">No transactions yet. Earn by <a href="watch-ads.html">watching ads</a>.</div>
  </main>

  <!-- Bottom navigation bar -->
  <nav class="app-nav">
    <a href="destination.html" aria-label="Destination" style="grid-column:1"><i class="bi bi-geo-alt"></i><span>Destination</span></a>
    <a href="watch-ads.html" aria-label="Watch Ads" style="grid-column:2"><i class="bi bi-camera-reels"></i><span>Watch Ads</span></a>
    <span class="center-slot" aria-hidden="true" style="grid-column:3"></span>
    <a href="wallet.html" aria-label="Wallet" class="active" style="grid-column:4"><i class="bi bi-wallet2"></i><span>Wallet</span></a>
    <a href="my-profile.html" aria-label="Profile" style="grid-column:5"><i class="bi bi-person"></i><span>Profile</span></a>
    <a href="passenger-dashboard.html" class="home-fab" aria-label="Home"><i class="bi bi-house-door fs-3"></i></a>
  </nav>

  <script type="module">
    import { auth, db, ref, get, set, runTransaction, onValue, requireRole, push } from './js/authentication.js';
    // Require login; passengers share same auth
    const { user } = await requireRole(['passenger']);
    const uid = user.uid;

    const amountEl = document.getElementById('amount');
    const nameEl = document.getElementById('helloName');
    const addrEl = document.getElementById('walletAddr');

    // Ensure wallet node exists per user
    // Wallet stored under all_users to match RTDB rules for per-user writes
    const balRef = ref(db, `all_users/${uid}/wallet`);
    await runTransaction(balRef, (curr)=> (typeof curr === 'number' ? curr : 0));
    onValue(balRef, (snap)=> { amountEl.textContent = String(snap.exists()? snap.val(): 0); });

    // Load name and an address-like id
    try {
      const u = await get(ref(db, `all_users/${uid}`));
      const v = u.exists()? u.val() : {};
      if (v?.name) nameEl.textContent = v.name;
    } catch {}
    // Address placeholder deterministic per uid
    addrEl.textContent = `JEEP-${uid.slice(0,8)}-${uid.slice(-4)}`;

    // Copy wallet address
    document.getElementById('copyAddr')?.addEventListener('click', ()=>{
      const a = addrEl.textContent || '';
      navigator.clipboard?.writeText(a);
    });

    // Simple panel router between History / Fare / Pay Driver
    const panel = document.getElementById('panel');
    const bind = (id, fn) => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('click', (e)=>{ e.preventDefault(); try { fn(); } catch(err){ console.error(err); } });
    };
    bind('btnTxn', showHistory);
    bind('btnFare', showFare);
    bind('btnPay', showPayDriver);

    // Get transaction history from Firebase
    async function getTransactionHistory() {
      try {
        const transactionsRef = ref(db, `transactions/${uid}`);
        const snapshot = await get(transactionsRef);
        
        if (snapshot.exists()) {
          const transactions = snapshot.val();
          // Convert to array and sort by timestamp (newest first)
          return Object.entries(transactions)
            .map(([id, transaction]) => ({ id, ...transaction }))
            .sort((a, b) => b.timestamp - a.timestamp);
        }
        return [];
      } catch (error) {
        console.error("Error fetching transactions:", error);
        return [];
      }
    }

    // Add a transaction to Firebase
    async function addTransaction(transaction) {
      try {
        const transactionsRef = ref(db, `transactions/${uid}`);
        const newTransactionRef = push(transactionsRef);
        await set(newTransactionRef, {
          ...transaction,
          timestamp: Date.now()
        });
        return true;
      } catch (error) {
        console.error("Error adding transaction:", error);
        return false;
      }
    }

    async function showHistory(){
      const transactions = await getTransactionHistory();
      
      panel.innerHTML = `
        <div class="section-title">Recent Transaction History <a href="#" class="float-end small">See all</a></div>
        ${transactions.length > 0 ? 
          transactions.map(t => `
            <div class="transaction-item">
              <div class="transaction-details">
                <div>${t.description}</div>
                <div class="transaction-date">${new Date(t.timestamp).toLocaleString()}</div>
              </div>
              <div class="transaction-amount ${t.type === 'earned' ? 'transaction-positive' : 'transaction-negative'}">
                ${t.type === 'earned' ? '+' : '-'}${t.amount} coins
              </div>
            </div>
          `).join('') : 
          '<div class="text-muted">No transactions yet. Earn by <a href="watch-ads.html">watching ads</a>.</div>'
        }
      `;
    }

    function showFare(){
      panel.innerHTML = `
        <div class="section-title">Fare Information</div>
        <div class="d-grid gap-2">
          <div class="form-pill"><i class="bi bi-geo-alt text-primary"></i><input id="from" class="form-control border-0 p-0" placeholder="From"/></div>
          <div class="form-pill"><i class="bi bi-geo-alt-fill text-primary"></i><input id="to" class="form-control border-0 p-0" placeholder="To"/></div>
          <div class="form-pill"><i class="bi bi-person-badge text-primary"></i>
            <select id="type" class="form-select border-0 p-0">
              <option value="regular">Regular</option>
              <option value="student">Student</option>
              <option value="senior">Senior</option>
            </select>
          </div>
          <button id="compute" class="btn btn-primary">Compute</button>
        </div>
        <hr class="my-3"/>
        <div id="result"></div>
      `;
      document.getElementById('compute')?.addEventListener('click', ()=>{
        const from = document.getElementById('from').value || 'Origin';
        const to = document.getElementById('to').value || 'Destination';
        const type = document.getElementById('type').value;
        // Simple illustrative fare: base 12 + 3 per km; student 20% off
        const km = (Math.random()*3 + 1).toFixed(2);
        let fare = 12 + 3*Number(km);
        if (type==='student') fare *= 0.8; if (type==='senior') fare *= 0.7;
        const coins = Math.ceil(fare*10);
        document.getElementById('result').innerHTML = `
          <div class="result-card">
            <div class="fw-bold">${from} - ${to}</div>
            <div class="small text-muted mb-1">${km} km</div>
            <div class="fw-bold">${coins} coins</div>
          </div>
        `;
      });
    }

    function showPayDriver(){
      panel.innerHTML = `
        <div class="section-title">Pay Driver</div>
        <div class="qr-tabs">
          <div class="qr-tab active" id="tabDisplay">Display QR</div>
          <div class="qr-tab" id="tabScan">Scan QR</div>
        </div>
        <div id="qrDisplaySection" class="qr-container">
          <div class="qr-code" id="qrCode">
            <div style="display: grid; place-items: center; height: 100%;">
              <i class="bi bi-qr-code" style="font-size: 80px;"></i>
            </div>
          </div>
          <div class="qr-instructions">
            Show this QR code to the driver for scanning. The fare amount will be deducted from your wallet.
          </div>
          <div class="payment-actions">
            <button id="simulatePayment" class="btn btn-primary">Simulate Payment</button>
          </div>
        </div>
        <div id="qrScanSection" class="scanner-container" style="display: none;">
          <div class="scanner-placeholder">
            <i class="bi bi-camera" style="font-size: 60px; color: #6b7b8a;"></i>
          </div>
          <div class="scanner-instructions">
            Point your camera at the driver's QR code to scan and pay for your fare.
          </div>
          <div class="payment-actions">
            <button id="startScanner" class="btn btn-primary">Start Scanner</button>
            <button id="simulateScan" class="btn btn-outline-primary">Simulate Scan</button>
          </div>
        </div>
      `;
      
      // Tab switching functionality
      document.getElementById('tabDisplay').addEventListener('click', () => {
        document.getElementById('tabDisplay').classList.add('active');
        document.getElementById('tabScan').classList.remove('active');
        document.getElementById('qrDisplaySection').style.display = 'flex';
        document.getElementById('qrScanSection').style.display = 'none';
      });
      
      document.getElementById('tabScan').addEventListener('click', () => {
        document.getElementById('tabScan').classList.add('active');
        document.getElementById('tabDisplay').classList.remove('active');
        document.getElementById('qrDisplaySection').style.display = 'none';
        document.getElementById('qrScanSection').style.display = 'flex';
      });
      
      // Simulate payment from displaying QR
      document.getElementById('simulatePayment')?.addEventListener('click', async () => {
        const currentBalance = Number(amountEl.textContent) || 0;
        const fareAmount = 25; // Example fare amount
        
        if (currentBalance < fareAmount) {
          alert(`Insufficient balance. You need ${fareAmount} coins but only have ${currentBalance}.`);
          return;
        }
        
        // Deduct fare from balance
        await runTransaction(balRef, (curr) => (curr || 0) - fareAmount);
        
        // Add to transaction history
        const transactionAdded = await addTransaction({
          type: 'spent',
          amount: fareAmount,
          description: 'Jeepney fare payment (QR displayed)'
        });
        
        if (transactionAdded) {
          alert(`Payment successful! ${fareAmount} coins deducted from your wallet.`);
          showHistory(); // Switch to history view to show the new transaction
        } else {
          alert('Payment failed. Please try again.');
        }
      });
      
      // Simulate scanning a QR code
      document.getElementById('simulateScan')?.addEventListener('click', async () => {
        const currentBalance = Number(amountEl.textContent) || 0;
        const fareAmount = 25; // Example fare amount
        
        if (currentBalance < fareAmount) {
          alert(`Insufficient balance. You need ${fareAmount} coins but only have ${currentBalance}.`);
          return;
        }
        
        // Deduct fare from balance
        await runTransaction(balRef, (curr) => (curr || 0) - fareAmount);
        
        // Add to transaction history
        const transactionAdded = await addTransaction({
          type: 'spent',
          amount: fareAmount,
          description: 'Jeepney fare payment (QR scanned)'
        });
        
        if (transactionAdded) {
          alert(`Payment successful! ${fareAmount} coins deducted from your wallet.`);
          showHistory(); // Switch to history view to show the new transaction
        } else {
          alert('Payment failed. Please try again.');
        }
      });
      
      // Start scanner button (placeholder functionality)
      document.getElementById('startScanner')?.addEventListener('click', () => {
        alert('Camera access would be requested here to scan QR codes. This is a simulation.');
      });
    }

    // Default view and ARIA focus improvement
    showHistory();
    try { document.getElementById('btnTxn')?.setAttribute('role','button'); } catch{}
  </script>
</body>
</html>