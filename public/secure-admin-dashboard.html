<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>JeepNi - Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Preconnects for faster CDN handshakes -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="dns-prefetch" href="https://unpkg.com">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- CSS / JS libs -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="/css/secure-admin-dashboard.css">
  <link rel="icon" href="/icons/JEEPNi.png" type="image/png">
</head>
<body>
<nav class="navbar bg-light border-bottom">
  <div class="container">
    <span class="navbar-brand fw-semibold d-flex align-items-center gap-2">
      JeepNi - Admin Dashboard
    </span>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button id="btnTheme" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" title="Toggle theme">
        <i class="bi bi-moon-stars"></i>
      </button>
      <span id="adminInfo" class="small text-light opacity-75">Checking session...</span>
      <button id="btnLogout" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<main class="container my-4">
  <div id="alerts"></div>

  <!-- Top-level feature tabs -->
  <ul class="nav nav-tabs mb-3" id="adminFeatureTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-dashboard-tab" data-bs-toggle="tab" data-bs-target="#tab-dashboard" type="button" role="tab" aria-controls="tab-dashboard" aria-selected="true">
        <i class="bi bi-grid-1x2"></i> Dashboard
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-scheduling-tab" data-bs-toggle="tab" data-bs-target="#tab-scheduling" type="button" role="tab" aria-controls="tab-scheduling" aria-selected="false">
        <i class="bi bi-truck"></i> Scheduling
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-sms-tab" data-bs-toggle="tab" data-bs-target="#tab-sms" type="button" role="tab" aria-controls="tab-sms" aria-selected="false">
        <i class="bi bi-chat-dots"></i> SMS Notifications
      </button>
    </li>

  <div class="tab-content">
  <!-- ===== Pane: Dashboard ===== -->
  <div class="tab-pane fade show active" id="tab-dashboard" role="tabpanel" aria-labelledby="tab-dashboard-tab" tabindex="0">
  <!-- Row: Driver Codes -->
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body text-center">
          <h5 class="card-title">Driver Codes</h5>
          <p class="card-text">Create and manage invite codes for new driver registrations.</p>
          <a href="manage-driver-codes.html" class="btn btn-primary">Manage Codes</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Row: Quick Actions + Live Map -->
  <div class="row g-3 mt-1 align-items-stretch">
    <div class="col-md-4 d-flex">
      <div class="card shadow-sm w-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-lightning-charge"></i> Quick Actions</h5>
          <div class="d-grid gap-2">
            <a class="btn btn-primary" href="add-driver.html">Add Driver</a>
            <a class="btn btn-primary" href="add-passenger.html">Add Passenger</a>
            <button id="btnAddAdmin" class="btn btn-warning">Add Admin</button>
            <button id="btnRemoveAdmin" class="btn btn-outline-danger">Remove Admin</button>
            <button id="btnExportDrivers" class="btn btn-outline-secondary">Export Drivers (CSV)</button>
            <button id="btnExportPassengers" class="btn btn-outline-secondary">Export Passengers (CSV)</button>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-8 d-flex">
      <div class="card shadow-sm h-100 w-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">Live Map</h5>
            <span class="text-muted small">Drivers & passengers</span>
          </div>
          <div id="dashboardMap" style="height: 520px;" role="region" aria-label="Live driver and passenger map"></div>
        </div>
      </div>
    </div>
  </div>

  </div><!-- /tab-dashboard -->

  <!-- ===== Pane: Scheduling ===== -->
  <div class="tab-pane fade" id="tab-scheduling" role="tabpanel" aria-labelledby="tab-scheduling-tab" tabindex="0">
  <!-- Row: Create Dispatch + Today's Dispatches -->
  <div class="row g-3 mt-1">
    <!-- Create Dispatch -->
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center gap-2"><i class="bi bi-truck"></i> Create Dispatch</h5>
          <form id="formDispatch" class="small">
            <div class="mb-2">
              <label class="form-label">Date</label>
              <input id="schDate" type="date" class="form-control form-control-sm">
            </div>
            <div class="mb-2">
              <label class="form-label">Departure Time</label>
              <input id="schTime" type="time" class="form-control form-control-sm" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Route</label>
              <select id="schRoute" class="form-select form-select-sm" required>
                <option value="gueset">Gueset</option>
                <option value="boquig">Boquig</option>
                <option value="longos">Longos</option>
                <option value="binloc">Binloc</option>
                <option value="tondaligan">Tondaligan</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Jeep / Plate</label>
              <input id="schJeep" class="form-control form-control-sm" placeholder="e.g., ABC-1234">
            </div>
            <div class="mb-2">
              <label class="form-label">Assign Driver</label>
              <select id="schDriver" class="form-select form-select-sm">
                <option value="">(Unassigned)</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes (optional)</label>
              <input id="schNotes" class="form-control form-control-sm">
            </div>
            <div class="d-grid">
              <button class="btn btn-primary btn-sm" type="submit">Create</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Today's Dispatches -->
    <div class="col-md-8">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title d-flex align-items-center justify-content-between">
            Today's Dispatches
            <div class="d-flex gap-2 align-items-center">
              <input id="listDate" type="date" class="form-control form-control-sm" style="width:auto">
              <button id="btnReloadSch" class="btn btn-outline-secondary btn-sm">Reload</button>
            </div>
          </h5>
          <div class="table-responsive mt-2">
            <table class="table table-striped table-hover table-sm align-middle">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>Route</th>
                  <th>Jeep</th>
                  <th>Driver</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="schRows">
                <tr><td colspan="6" class="text-center text-muted py-3">
                  <div class="d-flex align-items-center justify-content-center gap-2">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    Loading schedule...
                  </div>
                </td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  </div>
  </div><!-- /tab-scheduling -->

  <!-- ===== Pane: Data & Reports ===== -->
  <div class="tab-pane fade" id="tab-data" role="tabpanel" aria-labelledby="tab-data-tab" tabindex="0">
    <div class="row g-3 mt-0">
      <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-body">
          <!-- Side tabs layout -->
          <div class="row">
            <div class="col-md-3 border-end">
              <div class="nav flex-column nav-pills" id="dataSideTabs" role="tablist" aria-orientation="vertical">
                <button class="nav-link active text-start" id="drivers-tab" data-bs-toggle="tab" data-bs-target="#drivers" type="button" role="tab" aria-controls="drivers" aria-selected="true">
                  <i class="bi bi-people"></i> Drivers Online
                </button>
                <button class="nav-link text-start" id="passengers-tab" data-bs-toggle="tab" data-bs-target="#passengers" type="button" role="tab" aria-controls="passengers" aria-selected="false">
                  <i class="bi bi-person-badge"></i> All Passengers
                </button>
                <button class="nav-link text-start" id="predictions-tab" data-bs-toggle="tab" data-bs-target="#predictions" type="button" role="tab" aria-controls="predictions" aria-selected="false">
                  <i class="bi bi-graph-up"></i> Peak Hours
                </button>
                <button class="nav-link text-start" id="trips-tab" data-bs-toggle="tab" data-bs-target="#trips" type="button" role="tab" aria-controls="trips" aria-selected="false">
                  <i class="bi bi-geo-alt"></i> Trip Monitoring
                </button>
                <button class="nav-link text-start" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                  <i class="bi bi-clock-history"></i> Dispatch History
                </button>
                <div class="mt-3">
                  <button id="btnReloadDrivers" class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="tooltip" title="Reload drivers"><i class="bi bi-arrow-clockwise"></i> Reload Drivers</button>
                  <button id="btnReloadPassengers" class="btn btn-sm btn-outline-secondary w-100 mb-2" data-bs-toggle="tooltip" title="Reload passengers"><i class="bi bi-arrow-clockwise"></i> Reload Passengers</button>
                  <button id="btnReloadPredictions" class="btn btn-sm btn-outline-secondary w-100" data-bs-toggle="tooltip" title="Reload predictions"><i class="bi bi-arrow-clockwise"></i> Reload Predictions</button>
                </div>
              </div>
            </div>
            <div class="col-md-9">
              <!-- Tab content -->
              <div class="tab-content" id="myTabContent">
            <!-- Drivers Tab -->
            <div class="tab-pane fade show active" id="drivers" role="tabpanel" aria-labelledby="drivers-tab">
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="input-group input-group-sm" style="max-width:280px">
                  <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
                  <input id="searchDrivers" class="form-control" placeholder="Search drivers...">
                </div>
              </div>
              <div class="table-responsive mt-2">
                <table class="table table-striped table-hover table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Route</th>
                      <th>Status</th>
                      <th>Last Update</th>
                    </tr>
                  </thead>
                  <tbody id="rowsDrivers">
                    <tr><td colspan="4" class="text-center text-muted py-4">
                      <div class="d-flex align-items-center justify-content-center gap-2">
                        <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                        Loading drivers...
                      </div>
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Passengers Tab -->
            <div class="tab-pane fade" id="passengers" role="tabpanel" aria-labelledby="passengers-tab">
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="input-group input-group-sm" style="max-width:280px">
                  <span class="input-group-text bg-transparent"><i class="bi bi-search"></i></span>
                  <input id="searchPassengers" class="form-control" placeholder="Search passengers...">
                </div>
              </div>
              <div class="table-responsive mt-2">
                <table class="table table-striped table-hover table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Email</th>
                      <th>Phone</th>
                      <th>Joined</th>
                    </tr>
                  </thead>
                  <tbody id="rowsPassengers">
                    <tr><td colspan="4" class="text-center text-muted py-4">
                      <div class="d-flex align-items-center justify-content-center gap-2">
                        <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                        Loading passengers...
                      </div>
                    </td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Predictions Tab -->
            <div class="tab-pane fade" id="predictions" role="tabpanel" aria-labelledby="predictions-tab">
              <div class="row mt-3">
                <!-- Controls -->
                <div class="col-12 mb-3">
                  <div class="d-flex gap-2 align-items-center">
                    <label class="form-label mb-0">Date:</label>
                    <input id="predictionDate" type="date" class="form-control form-control-sm" style="width: auto;">
                    <button id="btnGeneratePredictions" class="btn btn-primary btn-sm">Generate</button>
                    <button id="btnSendPredictions" class="btn btn-success btn-sm">Send to Drivers</button>
                    <div class="ms-auto">
                      <span class="badge bg-info" id="predictionStatus">No predictions</span>
                    </div>
                  </div>
                </div>

                <!-- Summary Cards -->
                <div class="col-md-3">
                  <div class="card bg-primary">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h6 class="card-title text-white">Today's Predictions</h6>
                          <h3 class="text-white mb-0" id="ph_count">0</h3>
                        </div>
                        <i class="bi bi-graph-up text-white" style="font-size:1.6rem; opacity:.7"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-success">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h6 class="card-title text-white">Registered Users</h6>
                          <h3 class="text-white mb-0" id="ph_users">-</h3>
                        </div>
                        <i class="bi bi-people text-white" style="font-size:1.6rem; opacity:.7"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-info">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h6 class="card-title text-white">Messages Sent</h6>
                          <h3 class="text-white mb-0" id="ph_sent">0</h3>
                        </div>
                        <i class="bi bi-send text-white" style="font-size:1.6rem; opacity:.7"></i>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="card bg-warning">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center">
                        <div>
                          <h6 class="card-title text-white">Total Stops</h6>
                          <h3 class="text-white mb-0" id="ph_stops">-</h3>
                        </div>
                        <i class="bi bi-geo-alt text-white" style="font-size:1.6rem; opacity:.7"></i>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Preview Cards -->
                <div class="col-12 mt-3">
                  <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                      <h6 class="mb-0"><i class="bi bi-eye me-2"></i>Today's Peak Hours Preview</h6>
                      <div>
                        <span class="badge bg-primary me-2" id="ph_date_badge">-</span>
                        <button class="btn btn-success btn-sm" id="btnSendAllPH"><i class="bi bi-send me-1"></i>Send All</button>
                      </div>
                    </div>
                    <div class="card-body">
                      <div id="predictionsCards" class="row g-3">
                        <div class="text-center text-muted py-3">No predictions available</div>
                      </div>
                    </div>
                  </div>
                </div>

              </div><!-- /row -->
            </div><!-- /tab-pane predictions -->

            <!-- Trip Monitoring Tab (Viewer) -->
            <div class="tab-pane fade" id="trips" role="tabpanel" aria-labelledby="trips-tab">
              <div class="row g-2 mt-3">
                <div class="col-md-3">
                  <label class="form-label">Date</label>
                  <input id="tripDate" type="date" class="form-control form-control-sm">
                </div>
                <div class="col-md-5">
                  <label class="form-label">Driver</label>
                  <select id="tripDriver" class="form-select form-select-sm">
                    <option value="">Select a driver…</option>
                  </select>
                </div>
                <div class="col-md-4 d-flex align-items-end gap-2">
                  <button id="btnLoadTrips" class="btn btn-outline-secondary btn-sm">Load Trips</button>
                  <button id="btnExportTripCSV" class="btn btn-outline-primary btn-sm" disabled>Export CSV</button>
                  <button id="btnExportTripAll" class="btn btn-outline-success btn-sm" disabled>Export All</button>
                </div>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-striped table-hover table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Trip ID</th>
                      <th>Start</th>
                      <th>End</th>
                      <th>Duration</th>
                      <th>Samples</th>
                    </tr>
                  </thead>
                  <tbody id="tripRows">
                    <tr><td colspan="5" class="text-center text-muted py-3">No trips loaded.</td></tr>
                  </tbody>
                </table>
              </div>
            </div><!-- /tab-pane trips -->

            <!-- Dispatch History Tab -->
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
              <div class="row g-2 mt-3 align-items-end">
                <div class="col-sm-4">
                  <label class="form-label">Start Date</label>
                  <input id="histStart" type="date" class="form-control form-control-sm">
                </div>
                <div class="col-sm-4">
                  <label class="form-label">End Date</label>
                  <input id="histEnd" type="date" class="form-control form-control-sm">
                </div>
                <div class="col-sm-4 d-flex gap-2">
                  <div class="flex-grow-1">
                    <label class="form-label">Sort</label>
                    <select id="histSort" class="form-select form-select-sm">
                      <option value="desc">Newest first</option>
                      <option value="asc">Oldest first</option>
                    </select>
                  </div>
                  <div class="d-flex align-items-end gap-2">
                    <button id="btnLoadHistory" class="btn btn-outline-secondary btn-sm">Load</button>
                    <button id="btnExportHistory" class="btn btn-outline-primary btn-sm" disabled>Export CSV</button>
                  </div>
                </div>
                <div class="col-12">
                  <div class="btn-group btn-group-sm" role="group" aria-label="Quick ranges">
                    <button type="button" class="btn btn-outline-secondary" data-range="today">Today</button>
                    <button type="button" class="btn btn-outline-secondary" data-range="7">Last 7 days</button>
                    <button type="button" class="btn btn-outline-secondary" data-range="30">Last 30 days</button>
                    <button type="button" class="btn btn-outline-secondary" data-range="month">This month</button>
                  </div>
                </div>
              </div>

              <div class="table-responsive mt-3">
                <table class="table table-striped table-hover table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Route</th>
                      <th>Jeep</th>
                      <th>Driver</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="historyRows">
                    <tr><td colspan="6" class="text-center text-muted py-3">Choose a range and click Load</td></tr>
                  </tbody>
                </table>
                <div class="small text-muted mt-1" id="histSummary"></div>
              </div>
            </div><!-- /tab-pane history -->

          </div><!-- /tab-content -->
            </div><!-- /col-md-9 -->
          </div><!-- /row (side tabs + content) -->
        </div>
      </div>
    </div>
</div><!-- /tab-data -->

  <!-- ===== Pane: SMS Notifications ===== -->
  <div class="tab-pane fade" id="tab-sms" role="tabpanel" aria-labelledby="tab-sms-tab" tabindex="0">
    <div class="row g-3 mt-1">
      
      <!-- SMS Balance Card -->
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="card-title mb-1"><i class="bi bi-wallet2 me-2"></i>SMS Balance</h5>
                <p class="text-muted small mb-0">Semaphore API Account Status</p>
              </div>
              <div class="text-end">
                <h3 class="mb-0" id="smsBalance">
                  <span class="spinner-border spinner-border-sm text-primary" role="status"></span>
                </h3>
                <small class="text-muted">credits remaining</small>
              </div>
              <button id="btnRefreshBalance" class="btn btn-outline-primary btn-sm">
                <i class="bi bi-arrow-clockwise"></i> Refresh
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Message Composer -->
      <div class="col-md-5">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <h5 class="card-title d-flex align-items-center gap-2">
              <i class="bi bi-chat-text"></i> Compose Message
            </h5>
            
            <form id="formSMS">
              <div class="mb-3">
                <label class="form-label">Message <span class="text-danger">*</span></label>
                <textarea 
                  id="smsMessage" 
                  class="form-control" 
                  rows="5" 
                  maxlength="160" 
                  placeholder="Type your message here (max 160 characters)..."
                  required
                ></textarea>
                <div class="d-flex justify-content-between mt-1">
                  <small class="text-muted">
                    <i class="bi bi-info-circle"></i> Do not start with "TEST"
                  </small>
                  <small id="charCount" class="text-muted">0 / 160</small>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Sender Name</label>
                <input 
                  id="smsSenderName" 
                  type="text" 
                  class="form-control" 
                  value="SEMAPHORE" 
                  maxlength="11"
                  placeholder="e.g., JEEPNI"
                >
                <small class="text-muted">Max 11 characters (optional)</small>
              </div>

              <div class="mb-3">
                <label class="form-label">Selected Recipients</label>
                <div class="border rounded p-2" style="min-height: 60px; max-height: 120px; overflow-y: auto;">
                  <div id="selectedRecipients" class="d-flex flex-wrap gap-1">
                    <small class="text-muted">No recipients selected</small>
                  </div>
                </div>
                <small class="text-muted">
                  <span id="recipientCount">0</span> recipient(s) selected
                </small>
              </div>

              <div class="alert alert-warning small" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Note:</strong> Each SMS costs 1 credit per 160 characters.
              </div>

              <div class="d-grid gap-2">
                <button type="submit" class="btn btn-success" id="btnSendSMS" disabled>
                  <i class="bi bi-send"></i> Send SMS
                </button>
                <button type="button" class="btn btn-outline-secondary" id="btnCopyFromPredictions">
                  <i class="bi bi-clipboard"></i> Copy from Peak Hours
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Recipients List -->
      <div class="col-md-7">
        <div class="card shadow-sm h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">
                <i class="bi bi-people"></i> Recipients
              </h5>
              <div class="d-flex gap-2">
                <div class="btn-group btn-group-sm" role="group">
                  <input type="radio" class="btn-check" name="roleFilter" id="filterAll" value="all" checked autocomplete="off">
                  <label class="btn btn-outline-primary" for="filterAll">All</label>
                  
                  <input type="radio" class="btn-check" name="roleFilter" id="filterDrivers" value="driver" autocomplete="off">
                  <label class="btn btn-outline-primary" for="filterDrivers">Drivers</label>
                  
                  <input type="radio" class="btn-check" name="roleFilter" id="filterPassengers" value="passenger" autocomplete="off">
                  <label class="btn btn-outline-primary" for="filterPassengers">Passengers</label>
                </div>
                <button id="btnRefreshRecipients" class="btn btn-outline-secondary btn-sm">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>

            <div class="mb-3">
              <div class="input-group input-group-sm">
                <span class="input-group-text bg-transparent">
                  <i class="bi bi-search"></i>
                </span>
                <input 
                  id="searchRecipients" 
                  type="text" 
                  class="form-control" 
                  placeholder="Search by name or phone..."
                >
              </div>
            </div>

            <div class="d-flex gap-2 mb-2">
              <button id="btnSelectAll" class="btn btn-sm btn-outline-primary">
                <i class="bi bi-check-square"></i> Select All
              </button>
              <button id="btnDeselectAll" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-square"></i> Deselect All
              </button>
            </div>

            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
              <table class="table table-hover table-sm align-middle">
                <thead class="sticky-top bg-white">
                  <tr>
                    <th>Name</th>
                    <th>Role</th>
                    <th>Phone</th>
                    <th>Email</th>
                  </tr>
                </thead>
                <tbody id="recipientsTableBody">
                  <tr>
                    <td colspan="4" class="text-center text-muted py-3">
                      <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                      Loading recipients...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div><!-- /tab-sms -->

  </div><!-- /tab-content (feature tabs) -->
  </div>
</main>

<!-- Add Admin Modal -->
<div class="modal" id="modalAddAdmin" tabindex="-1" role="dialog" aria-labelledby="modalAddAdminTitle">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalAddAdminTitle"><i class="bi bi-person-gear me-2"></i>Add Admin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info small">
          Only <strong>admin</strong> can promote users to admin.
        </div>
        <div class="mb-2">
          <label class="form-label" for="adminIdType">Identifier Type</label>
          <select id="adminIdType" class="form-select form-select-sm">
            <option value="email" selected>Email</option>
            <option value="uid">UID</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label" for="adminIdentifier">Email or UID</label>
          <input id="adminIdentifier" class="form-control" placeholder="user@example.com or Firebase UID">
        </div>
        <div class="form-text">User must already exist in <code>all_users</code>.</div>
        <div class="text-danger small mt-2 d-none" id="addAdminError"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="btnConfirmAddAdmin">Promote to Admin</button>
      </div>
    </div>
  </div>
</div>

<!-- Remove Admin Modal -->
<div class="modal" id="modalRemoveAdmin" tabindex="-1" role="dialog" aria-labelledby="modalRemoveAdminTitle">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalRemoveAdminTitle"><i class="bi bi-person-x me-2"></i>Remove Admin</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning small">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Only <strong>admin</strong> can remove admin privileges.
        </div>
        <div class="mb-2">
          <label class="form-label" for="removeAdminIdType">Identifier Type</label>
          <select id="removeAdminIdType" class="form-select form-select-sm">
            <option value="email" selected>Email</option>
            <option value="uid">UID</option>
          </select>
        </div>
        <div class="mb-2">
          <label class="form-label" for="removeAdminIdentifier">Email or UID</label>
          <input id="removeAdminIdentifier" class="form-control" placeholder="user@example.com or Firebase UID">
        </div>
        <div class="mb-3">
          <label class="form-label">New Role</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="newRole" id="roleUser" value="user" checked>
            <label class="form-check-label" for="roleUser">
              Regular User
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="newRole" id="roleDriver" value="driver">
            <label class="form-check-label" for="roleDriver">
              Driver
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="newRole" id="rolePassenger" value="passenger">
            <label class="form-check-label" for="rolePassenger">
              Passenger
            </label>
          </div>
        </div>
        <div class="form-text text-danger">This will remove admin privileges and set the selected role.</div>
        <div class="text-danger small mt-2 d-none" id="removeAdminError"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="btnConfirmRemoveAdmin">Remove Admin</button>
      </div>
    </div>
  </div>
</div>
<script type="module">
  import { 
    db, 
    ref, 
    get,
    onValue,
    signOutAndRedirect,
    query,
    orderByChild,
    equalTo,
    update,
    auth
  } from "./js/authentication.js";
  import { requireAdmin, attachAdminBadge } from "./js/admin_auth.js";
  import { createDispatch, listDispatches, adminSetStatus } from "./js/scheduling.js";
  import { 
      getAllRecipients,
      sendSMS,
      getSMSBalance,
      getSMSInfo,
      renderRecipientsTable,
      formatPredictionForSMS
    } from "./js/sms-integration.js";


  const $ = (sel) => document.querySelector(sel);
  // Sanitize any mojibake or bad bytes to ASCII
  function cleanText(s) {
    if (s == null) return "";
    return String(s)
      .replace(/â€”/g, ' - ')
      .replace(/[�\uFFFD]+/g, '')
      .replace(/\s{2,}/g, ' ')
      .trim();
  }
  function showAlert(html, type="warning") {
    $("#alerts").innerHTML =
      `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
        ${html}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>`;
  }

  attachAdminBadge("#adminInfo");
  $("#btnLogout").addEventListener("click", async ()=>{ await signOutAndRedirect("login.html"); });
  await requireAdmin("login.html");
  // Theme: apply saved preference
  try {
    const saved = localStorage.getItem('theme') || 'light';
    if (saved === 'dark') document.body.classList.add('theme-dark');
  } catch {}
  const btnTheme = document.getElementById('btnTheme');
  if (btnTheme) btnTheme.addEventListener('click', () => {
    const dark = document.body.classList.toggle('theme-dark');
    try { localStorage.setItem('theme', dark ? 'dark' : 'light'); } catch {}
    const ico = btnTheme.querySelector('i');
    if (ico) ico.className = dark ? 'bi bi-brightness-high' : 'bi bi-moon-stars';
  });
  // Enable tooltips
  try {
    const els = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    els.forEach(el => new bootstrap.Tooltip(el));
  } catch {}

  // ===== Add Admin (super_admin only) =====
  async function openAddAdminModal() {
    try {
      const modalEl = document.getElementById('modalAddAdmin');
      if (!modalEl) return;

      // Reset form state
      document.getElementById('addAdminError')?.classList.add('d-none');
      document.getElementById('adminIdentifier').value = '';
      document.getElementById('adminIdType').value = 'email';

      // Initialize modal with proper focus management
      const modal = new bootstrap.Modal(modalEl, {
        keyboard: true,
        focus: true,
        backdrop: true
      });

      // Show modal and focus first input
      modal.show();
      setTimeout(() => {
        document.getElementById('adminIdentifier')?.focus();
      }, 150);

    } catch (err) {
      console.error('Failed to open modal:', err);
    }
  }

  async function promoteToAdmin() {
    const errEl = document.getElementById('addAdminError');
    const idType = document.getElementById('adminIdType').value;
    const ident = (document.getElementById('adminIdentifier').value || '').trim();
    errEl?.classList.add('d-none');
    
    if (!ident) { 
      errEl.textContent = 'Please enter an email or UID.'; 
      errEl.classList.remove('d-none'); 
      return; 
    }

    try {
      // Check if current user is admin
      const { auth, getRole } = await import('./js/authentication.js');
      const me = auth.currentUser;
      if (!me) throw new Error('Not signed in');
      
      const roleSnap = await get(ref(db, `all_users/${me.uid}/role`));
      const myRole = roleSnap.exists() ? roleSnap.val() : 'norole';
      if (myRole !== 'admin') throw new Error('Only admin can promote users.');

      // Resolve target UID
      let targetUid = null;
      if (idType === 'uid') {
        targetUid = ident;
      } else {
        const allSnap = await get(ref(db, 'all_users'));
        if (!allSnap.exists()) throw new Error('all_users is empty.');
        const all = allSnap.val();
        const lower = ident.toLowerCase();
        for (const uid in all) {
          const email = (all[uid]?.email || '').toLowerCase();
          if (email === lower) { targetUid = uid; break; }
        }
        if (!targetUid) throw new Error('No user with that email found in all_users.');
      }

      // Update role to admin
      await update(ref(db, `all_users/${targetUid}`), { role: 'admin' });
      showAlert('User promoted to admin successfully.', 'success');
      bootstrap.Modal.getInstance(document.getElementById('modalAddAdmin'))?.hide();
      
    } catch (e) {
      console.error('promoteToAdmin failed:', e);
      if (errEl) { 
        errEl.textContent = e.message || 'Failed'; 
        errEl.classList.remove('d-none'); 
      }
    }
  }

  const btnAddAdmin = document.getElementById('btnAddAdmin');
  if (btnAddAdmin) btnAddAdmin.addEventListener('click', openAddAdminModal);
  const btnConfirmAddAdmin = document.getElementById('btnConfirmAddAdmin');
  if (btnConfirmAddAdmin) btnConfirmAddAdmin.addEventListener('click', promoteToAdmin);

  // Add this near the other admin-related functions in the script section
async function openRemoveAdminModal() {
  try {
    const modalEl = document.getElementById('modalRemoveAdmin');
    if (!modalEl) return;

    // Reset form state
    document.getElementById('removeAdminError')?.classList.add('d-none');
    document.getElementById('removeAdminIdentifier').value = '';
    document.getElementById('removeAdminIdType').value = 'email';

    // Initialize modal
    const modal = new bootstrap.Modal(modalEl, {
      keyboard: true,
      focus: true,
      backdrop: true
    });

    modal.show();
    setTimeout(() => {
      document.getElementById('removeAdminIdentifier')?.focus();
    }, 150);

  } catch (err) {
    console.error('Failed to open remove admin modal:', err);
  }
}

// Update the removeAdminPrivileges function in your script
async function removeAdminPrivileges() {
  const errEl = document.getElementById('removeAdminError');
  const idType = document.getElementById('removeAdminIdType').value;
  const ident = (document.getElementById('removeAdminIdentifier').value || '').trim();
  const newRole = document.querySelector('input[name="newRole"]:checked')?.value || 'user';
  errEl?.classList.add('d-none');
  
  if (!ident) { 
    errEl.textContent = 'Please enter an email or UID.'; 
    errEl.classList.remove('d-none'); 
    return; 
  }

  try {
    // Check if current user is admin
    const { auth, getRole } = await import('./js/authentication.js');
    const me = auth.currentUser;
    if (!me) throw new Error('Not signed in');
    
    const roleSnap = await get(ref(db, `all_users/${me.uid}/role`));
    const myRole = roleSnap.exists() ? roleSnap.val() : 'norole';
    if (myRole !== 'admin') throw new Error('Only admin can remove admin privileges.');

    // Prevent removing own admin access
    if (idType === 'uid' && ident === me.uid) throw new Error('Cannot remove your own admin privileges.');
    if (idType === 'email' && ident.toLowerCase() === me.email?.toLowerCase()) {
      throw new Error('Cannot remove your own admin privileges.');
    }

    // Resolve target UID
    let targetUid = null;
    if (idType === 'uid') {
      targetUid = ident;
    } else {
      const allSnap = await get(ref(db, 'all_users'));
      if (!allSnap.exists()) throw new Error('all_users is empty.');
      const all = allSnap.val();
      const lower = ident.toLowerCase();
      for (const uid in all) {
        const email = (all[uid]?.email || '').toLowerCase();
        if (email === lower) { targetUid = uid; break; }
      }
      if (!targetUid) throw new Error('No user with that email found in all_users.');
    }

    // Verify target is admin before removing+++
    const targetRoleSnap = await get(ref(db, `all_users/${targetUid}/role`));
    if (!targetRoleSnap.exists() || targetRoleSnap.val() !== 'admin') {
      throw new Error('User is not an admin.');
    }

    // Remove admin role and set new role
    await update(ref(db, `all_users/${targetUid}`), { role: newRole });
    showAlert(`Admin privileges removed successfully. New role: ${newRole}`, 'success');
    bootstrap.Modal.getInstance(document.getElementById('modalRemoveAdmin'))?.hide();
    
  } catch (e) {
    console.error('removeAdminPrivileges failed:', e);
    if (errEl) { 
      errEl.textContent = e.message || 'Failed'; 
      errEl.classList.remove('d-none'); 
    }
  }
}

// Add these event listeners with the other button handlers
const btnRemoveAdmin = document.getElementById('btnRemoveAdmin');
if (btnRemoveAdmin) btnRemoveAdmin.addEventListener('click', openRemoveAdminModal);
const btnConfirmRemoveAdmin = document.getElementById('btnConfirmRemoveAdmin');
if (btnConfirmRemoveAdmin) btnConfirmRemoveAdmin.addEventListener('click', removeAdminPrivileges);


  // Normalize any mojibake placeholders to plain ASCII right away
  const setLoading = (sel, cols) => {
    const el = document.querySelector(sel);
    if (el) el.innerHTML = `<tr><td colspan="${cols}" class="text-center text-muted py-3">
      <div class="d-flex align-items-center justify-content-center gap-2">
        <div class="spinner-border spinner-border-sm text-info" role="status"></div>
        Loading...
      </div>
    </td></tr>`;
  };
  setLoading('#schRows', 6);
  setLoading('#rowsDrivers', 4);
  setLoading('#rowsPassengers', 4);
  setLoading('#predictionRows', 6);

  // Define sanitizeDocument to avoid mojibake artifacts and errors
  function sanitizeDocument() {
    const nodes = document.querySelectorAll('option, td, th, span, button, label, h1, h2, h3, h4, h5, h6');
    nodes.forEach(el => {
      const t = el.textContent || '';
      if (t.indexOf('â€”') !== -1) el.textContent = t.replace(/â€”/g, ' - ');
    });
  }

  const ONLINE_WINDOW_MS = 150000; // 2.5 minutes recency window

  // Presence helpers
  function computeOnline(rec) {
    if (!rec) return false;
    const last = typeof rec.last_update === 'number' ? rec.last_update : (rec.last_update?._serverTimestamp || 0);
    return !!rec.online && (Date.now() - last) < ONLINE_WINDOW_MS;
  }

  function fmtTs(ts) {
    if (!ts) return "";
    const d = new Date(typeof ts === "number" ? ts : ts._serverTimestamp || 0);
    return d.toLocaleString();
  }

  // Load ONLY real drivers with proper name resolution
  async function loadDriversTable() {
    const tbody = $("#rowsDrivers");
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">
      <div class="spinner-border spinner-border-sm text-info"></div> Loading...
    </td></tr>`;

    try {
      // Get both drivers and their locations
      const [driversSnap, locSnap] = await Promise.all([
        get(ref(db, "drivers")),
        get(ref(db, "drivers_location"))
      ]);

      const drivers = driversSnap.exists() ? driversSnap.val() : {};
      const locs = locSnap.exists() ? locSnap.val() : {};
      
      const driversList = Object.entries(drivers).map(([uid, data]) => {
        const loc = locs[uid] || {};
        return {
          uid,
          name: data.name || data.email || `Driver ${uid.slice(0,8)}`,
          route: loc.route || data.route || "No route",
          status: loc.status || "offline",
          online: computeOnline(loc),
          lastUpdate: loc.last_update || null
        };
      });

      if (!driversList.length) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No drivers found</td></tr>`;
        return;
      }

      tbody.innerHTML = driversList
        .sort((a, b) => b.online - a.online || a.name.localeCompare(b.name))
        .map(d => `
          <tr>
            <td>
              <strong>${d.name}</strong>
              <br><small class="text-muted">UID: ${d.uid.slice(0,8)}...</small>
            </td>
            <td><span class="badge bg-info">${d.route}</span></td>
            <td>
              <span class="badge ${d.online ? "bg-success" : "bg-secondary"}">
                ${d.status || (d.online ? "Online" : "Offline")}
              </span>
            </td>
            <td>${d.lastUpdate ? new Date(d.lastUpdate).toLocaleString() : '-'}</td>
          </tr>
        `).join('');
    } catch (err) {
      console.error('Error loading drivers:', err);
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">
        Error loading drivers: ${err.message}
      </td></tr>`;
    }
  }

  // Load passengers table
  async function loadPassengersTable() {
    const tbody = $("#rowsPassengers");
  tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4"><div class="d-flex align-items-center justify-content-center gap-2"><div class="spinner-border spinner-border-sm text-info" role="status"></div> Loading passengers...</div></td></tr>`;

    try {
      const snap = await get(ref(db, "passengers"));
      
      if (!snap.exists()) {
        tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-4">No passengers found.</td></tr>`;
        return;
      }

      const passengers = snap.val();
      const passengerList = Object.keys(passengers).map(uid => ({
        uid: uid,
        ...passengers[uid]
      }));

      // Sort by name
      passengerList.sort((a, b) => (a.name || "").localeCompare(b.name || ""));

      tbody.innerHTML = passengerList.map(passenger => `
        <tr>
          <td>
            <strong>${passenger.name || 'No name'}</strong>
            <br><small class="text-muted">UID: ${passenger.uid.slice(0, 8)}...</small>
          </td>
          <td>${passenger.email || 'No email'}</td>
          <td>${passenger.phone || 'No phone'}</td>
          <td>${passenger.created_at ? new Date(passenger.created_at).toLocaleDateString() : 'Unknown'}</td>
        </tr>
      `).join("");

    } catch (error) {
      console.error("Error loading passengers:", error);
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-4">Error: ${error.message}</td></tr>`;
    }
  }

  // Export functions
  async function exportDrivers() {
    try {
      const snap = await get(ref(db, "drivers"));
      if (!snap.exists()) {
        showAlert("No drivers to export.", "info");
        return;
      }

      const drivers = snap.val();
      const headers = ["Name", "Email", "Route", "Plate", "Phone", "Created Date", "UID"];
      const csvRows = [headers.join(",")];

      Object.keys(drivers).forEach(uid => {
        const driver = drivers[uid];
        const row = [
          driver.name || "",
          driver.email || "",
          driver.route || "",
          driver.plate || "",
          driver.phone || "",
          driver.created_at || "",
          uid
        ].map(field => {
          const s = String(field ?? "");
          const guard = (/^[=+\-@]/.test(s)) ? "'" : "";
          return `"${(guard + s).replace(/"/g, '""')}"`;
        });
        csvRows.push(row.join(","));
      });

      downloadCSV(csvRows.join("\n"), "drivers_export.csv");
    } catch (error) {
      showAlert("Export failed: " + error.message, "danger");
    }
  }

  async function exportPassengers() {
    try {
      const snap = await get(ref(db, "passengers"));
      if (!snap.exists()) {
        showAlert("No passengers to export.", "info");
        return;
      }

      const passengers = snap.val();
      const headers = ["Name", "Email", "Phone", "Created Date", "UID"];
      const csvRows = [headers.join(",")];

      Object.keys(passengers).forEach(uid => {
        const passenger = passengers[uid];
        const row = [
          passenger.name || "",
          passenger.email || "",
          passenger.phone || "",
          passenger.created_at || "",
          uid
        ].map(field => {
          const s = String(field ?? "");
          const guard = (/^[=+\-@]/.test(s)) ? "'" : "";
          return `"${(guard + s).replace(/"/g, '""')}"`;
        });
        csvRows.push(row.join(","));
      });

      downloadCSV(csvRows.join("\n"), "passengers_export.csv");
    } catch (error) {
      showAlert("Export failed: " + error.message, "danger");
    }
  }

  function downloadCSV(csvContent, filename) {
    const blob = new Blob([csvContent], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ===== Trip Monitoring (Admin) =====
  async function loadTripDrivers() {
    const sel = document.querySelector('#tripDriver');
    if (!sel) return;
    sel.innerHTML = `<option value="">Select a driver...</option>`;
    try {
      const snap = await get(ref(db, 'drivers'));
      if (!snap.exists()) return;
      const drivers = snap.val() || {};
      Object.keys(drivers).forEach(uid => {
        const d = drivers[uid] || {};
        const opt = document.createElement('option');
        opt.value = uid;
        opt.textContent = `${d.name || d.email || uid.slice(0,8)} - ${d.route || 'No route'}`;
        sel.appendChild(opt);
      });
    } catch (e) { console.warn('loadTripDrivers failed', e); }
  }

  function tsToDate(ts) {
    if (!ts) return null;
    const ms = typeof ts === 'number' ? ts : (ts && ts._serverTimestamp ? ts._serverTimestamp : null);
    return ms ? new Date(ms) : null;
  }

  function fmt(dt) { try { return dt ? dt.toLocaleString() : ''; } catch { return ''; } }
  function dur(a,b) { return (a && b) ? `${Math.round((b-a)/60000)} min` : ''; }

  async function loadTrips() {
    const date = (document.querySelector('#tripDate')?.value) || new Date().toISOString().slice(0,10);
    const uid = document.querySelector('#tripDriver')?.value || '';
    const tbody = document.querySelector('#tripRows');
    const btnCSV = document.querySelector('#btnExportTripCSV');
    if (!uid) {
      if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Please select a driver.</td></tr>`;
      if (btnCSV) btnCSV.disabled = true;
      return;
    }
    if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>`;
    if (btnCSV) btnCSV.disabled = true;
    try {
      let rows = [];
      try {
        const daySnap = await get(ref(db, `user_trips/${uid}/${date}`));
        if (daySnap.exists()) {
          const trips = daySnap.val() || {};
          const ids = Object.keys(trips);
          rows = await Promise.all(ids.map(async id => {
            let v = trips[id];
            try {
              const snap = await get(ref(db, `trip_logs/${id}`));
              if (snap.exists()) v = snap.val();
            } catch {}
            const s = tsToDate(v?.start?.ts);
            const e = tsToDate(v?.end?.ts);
            const samples = v?.locations ? Object.keys(v.locations).length : (v?.samples || 0);
            return { id, start: s, end: e, duration: dur(s,e), samples };
          }));
        }
      } catch (inner) {
        console.warn('user_trips read failed, falling back to trip_logs query:', inner?.message);
      }

      if (!rows.length) {
        // Fallback: query by driver_uid. Some RTDB rules may forbid this for non-admins.
        try {
          const qref = query(ref(db, 'trip_logs'), orderByChild('driver_uid'), equalTo(uid));
          const allSnap = await get(qref);
          if (allSnap.exists()) {
            const all = allSnap.val() || {};
            rows = Object.keys(all).map(id => ({ id, ...all[id] }))
              .filter(v => {
                if (v.date) return v.date === date;
                const s = tsToDate(v?.start?.ts);
                if (!s) return false;
                const y = s.getFullYear();
                const m = String(s.getMonth()+1).padStart(2,'0');
                const d = String(s.getDate()).padStart(2,'0');
                return `${y}-${m}-${d}` === date;
              })
              .map(v => {
                const s = tsToDate(v?.start?.ts);
                const e = tsToDate(v?.end?.ts);
                const samples = v?.locations ? Object.keys(v.locations).length : (v?.samples || 0);
                return { id: v.id, start: s, end: e, duration: dur(s,e), samples };
              });
          }
        } catch (perm) {
          // Gracefully handle permission-denied by showing 'No trips' instead of crashing
          console.warn('trip_logs fallback denied or failed:', perm?.message || perm);
          rows = [];
        }
      }
      if (tbody) tbody.innerHTML = rows.length ? rows.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${fmt(r.start)}</td>
          <td>${fmt(r.end)}</td>
          <td>${r.duration}</td>
          <td>${r.samples}</td>
        </tr>
      `).join('') : `<tr><td colspan="5" class="text-center text-muted py-3">No trips loaded.</td></tr>`;
      if (btnCSV) {
        btnCSV.disabled = rows.length === 0;
        btnCSV.onclick = () => exportTripCSV(rows, date, uid);
      }
    } catch (err) {
      console.error('loadTrips failed', err);
      const msg = /Permission denied/i.test(err?.message||'') ? 'No permission to read trips for this date.' : ('Failed: ' + (err?.message||'Unknown error'));
      if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-3">${msg}</td></tr>`;
    }
  }

  function exportTripCSV(rows, date, uid) {
    const headers = ['Trip ID','Start','End','Duration','Samples','Driver UID','Date'];
    const csv = [headers.join(',')];
    rows.forEach(r => {
      const cells = [r.id, fmt(r.start), fmt(r.end), r.duration, r.samples, uid, date].map(v => {
        const s = String(v ?? '');
        const guard = (/^[=+\-@]/.test(s)) ? "'" : "";
        return `"${(guard + s).replace(/"/g,'""')}"`;
      });
      csv.push(cells.join(','));
    });
    downloadCSV(csv.join('\n'), `trips_${uid}_${date}.csv`);
  }

  async function exportAllTripsForDriver() {
    const uid = document.querySelector('#tripDriver')?.value || '';
    if (!uid) { showAlert('Please select a driver first.', 'warning'); return; }
    const btn = document.querySelector('#btnExportTripAll');
    if (btn) { btn.disabled = true; btn.textContent = 'Exporting...'; }
    try {
      const qref = query(ref(db, 'trip_logs'), orderByChild('driver_uid'), equalTo(uid));
      const snap = await get(qref);
      if (!snap.exists()) { showAlert('No trips found for this driver.', 'info'); return; }
      const all = snap.val() || {};
      const rows = Object.keys(all).map(id => ({ id, ...all[id] }))
        .map(v => {
          const s = tsToDate(v?.start?.ts);
          const e = tsToDate(v?.end?.ts);
          const date = v.date || (s ? `${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,'0')}-${String(s.getDate()).padStart(2,'0')}` : '');
          const samples = v?.locations ? Object.keys(v.locations).length : (v?.samples || 0);
          return { id: v.id, date, start: s, end: e, duration: dur(s,e), samples };
        });
      const headers = ['Trip ID','Date','Start','End','Duration','Samples','Driver UID'];
      const csv = [headers.join(',')];
      rows.forEach(r => {
        const cells = [r.id, r.date, fmt(r.start), fmt(r.end), r.duration, r.samples, uid].map(v => {
          const s = String(v ?? '');
          const guard = (/^[=+\-@]/.test(s)) ? "'" : "";
          return `"${(guard + s).replace(/"/g,'""')}"`;
        });
        csv.push(cells.join(','));
      });
      downloadCSV(csv.join('\n'), `trips_${uid}_ALL.csv`);
      showAlert(`Exported ${rows.length} trips for driver.`, 'success');
    } catch (e) {
      console.error('exportAllTripsForDriver failed:', e);
      showAlert('Export failed: ' + e.message, 'danger');
    } finally {
      if (btn) { btn.disabled = false; btn.textContent = 'Export All'; }
    }
  }

  // Event listeners
  $("#btnReloadDrivers").addEventListener("click", loadDriversTable);
  $("#btnReloadPassengers").addEventListener("click", loadPassengersTable);
  $("#btnExportDrivers").addEventListener("click", exportDrivers);
  $("#btnExportPassengers").addEventListener("click", exportPassengers);
  const btnLoadTripsEl = document.querySelector('#btnLoadTrips');
  if (btnLoadTripsEl) btnLoadTripsEl.addEventListener('click', loadTrips);
  const btnExportAll = document.querySelector('#btnExportTripAll');
  if (btnExportAll) btnExportAll.addEventListener('click', exportAllTripsForDriver);
  const tripDriverSel = document.querySelector('#tripDriver');
  if (tripDriverSel) tripDriverSel.addEventListener('change', () => {
    const btnAll = document.querySelector('#btnExportTripAll');
    if (btnAll) btnAll.disabled = !(tripDriverSel.value);
  });

  // Load drivers for dispatch select
  async function loadDriversForSelect() {
    const sel = $("#schDriver");
    sel.innerHTML = `<option value="">(Unassigned)</option>`;
    
    try {
      const snap = await get(ref(db, "drivers"));
      if (!snap.exists()) return;
      
      const drivers = snap.val();
      Object.keys(drivers).forEach(uid => {
        const d = drivers[uid] || {};
        const opt = document.createElement("option");
        opt.value = uid;
        opt.textContent = `${d.name || d.email || uid.slice(0, 8)} - ${d.route || "No route"}`;
        sel.appendChild(opt);
        // Override any mojibake with a clean ASCII label
        try {
          const name = d.name || d.email || uid.slice(0, 8);
          const route = d.route || "No route";
          opt.textContent = cleanText(`${name} - ${route}`);
        } catch (_) {}
      });
    } catch (error) {
      console.error("Error loading drivers for select:", error);
    }
  }

  // Initialize
  const todayISO = new Date().toISOString().slice(0, 10);
  const schDateEl = $("#schDate");
  const listDateEl = $("#listDate");
  if (schDateEl && !schDateEl.value) schDateEl.value = todayISO;
  if (listDateEl && !listDateEl.value) listDateEl.value = todayISO;

  // Kick off initial loads without blocking other listeners/UI
  // This prevents the module from stalling and speeds up perceived load
  loadDriversForSelect().catch(console.warn);
  loadTripDrivers().catch(console.warn);
  Promise.all([loadDriversTable(), loadPassengersTable()]).catch(console.warn);
  // Auto-load when trips tab becomes active
  const tripsTabBtn = document.querySelector('#trips-tab');
  if (tripsTabBtn) tripsTabBtn.addEventListener('shown.bs.tab', loadTrips);

  // Live updates: refresh drivers presence and counters when locations change
  let refreshTimer = null;
  onValue(ref(db, 'drivers_location'), () => {
    if (refreshTimer) return; // throttle rapid updates
    refreshTimer = setTimeout(async () => {
      refreshTimer = null;
      await loadDriversTable();
    }, 500);
  });
  sanitizeDocument();

  // Dispatch form handling
  $("#formDispatch").addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
    
    try {
      const dispatch = {
        date: $("#schDate").value,
        dep_time: $("#schTime").value,
        route: $("#schRoute").value,
        jeep_id: $("#schJeep").value.trim(),
        driver_uid: $("#schDriver").value,
        notes: $("#schNotes").value.trim()
      };

      await createDispatch(dispatch);
      showAlert("Dispatch created successfully", "success");
      
      // Reset form but keep the date
      const currentDate = $("#schDate").value;
      e.target.reset();
      $("#schDate").value = currentDate;
      
      // Refresh schedule
      await renderSchedule();
      
    } catch (err) {
      console.error('Create dispatch failed:', err);
      showAlert(`Failed to create dispatch: ${err.message}`, "danger");
    } finally {
      if (btn) btn.disabled = false;
    }
  });

  // Schedule rendering
  async function renderSchedule() {
    const tbody = $("#schRows");
    const date = $("#listDate").value || new Date().toISOString().split('T')[0];
    
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-3">
      <div class="spinner-border spinner-border-sm text-info" role="status"></div> Loading...
    </td></tr>`;

    try {
      // Load schedules and drivers in parallel
      const [schedules, driversSnap] = await Promise.all([
        listDispatches(date),
        get(ref(db, "drivers"))
      ]);
      
      const drivers = driversSnap.exists() ? driversSnap.val() : {};
      
      if (!schedules?.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">
          No dispatches found for ${date}
        </td></tr>`;
        return;
      }

      tbody.innerHTML = schedules
        .sort((a, b) => (a.dep_time || "").localeCompare(b.dep_time || ""))
        .map(sch => {
          const driver = drivers[sch.driver_uid] || {};
          const driverName = driver.name || driver.email || sch.driver_uid?.slice(0,8) || "Unassigned";
          
          return `
            <tr data-id="${sch.id}">
              <td>${sch.dep_time || "00:00"}</td>
              <td>${sch.route || ""}</td>
              <td>${sch.jeep_id || ""}</td>
              <td>${driverName}</td>
              <td>
                <select class="form-select form-select-sm sch-status" 
                        data-id="${sch.id}" 
                        data-date="${date}">
                  ${["assigned","accepted","enroute","completed","canceled"]
                    .map(s => `<option value="${s}" ${s === sch.status ? "selected" : ""}>${s}</option>`)
                    .join("")}
                </select>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-danger sch-cancel" 
                        data-id="${sch.id}" 
                        data-date="${date}">
                  Cancel
                </button>
              </td>
            </tr>
          `;
        }).join("");

    } catch (err) {
      console.error('Render schedule failed:', err);
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">
        Error loading schedule: ${err.message}
      </td></tr>`;
    }
  }

  // Prediction functions
async function loadPredictions() {
  const date = $('#predictionDate').value || new Date().toISOString().split('T')[0];
  const statusBadge = $('#predictionStatus');
  const cards = document.getElementById('predictionsCards');
  const dateBadge = document.getElementById('ph_date_badge');
  if (dateBadge) dateBadge.textContent = date;
  
  statusBadge.className = 'badge bg-warning';
  statusBadge.textContent = 'Loading...';
  
  try {
    const API_BASE = window.API_BASE ?? ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') && location.port !== '5000' ? 'http://localhost:5000' : '');
    const response = await fetch(`${API_BASE}/api/predictions/${date}`);    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const predictions = await response.json();
    // Update registered users count if container exists
    try {
      const usersSnap = await get(ref(db, 'passengers'));
      const phUsersEl = document.getElementById('ph_users');
      if (phUsersEl) phUsersEl.textContent = usersSnap.exists() ? Object.keys(usersSnap.val()).length : 0;
    } catch {}
    
    // Counters
    const sentCount = Array.isArray(predictions) ? predictions.filter(p => p.is_sent || p.sent).length : 0;
    const totalStops = Array.isArray(predictions) ? new Set(predictions.map(p => p.stop_name || p.stop?.name || '')).size : 0;
    const phCountEl = document.getElementById('ph_count'); if (phCountEl) phCountEl.textContent = Array.isArray(predictions) ? predictions.length : 0;
    const phSentEl = document.getElementById('ph_sent'); if (phSentEl) phSentEl.textContent = sentCount;
    const phStopsEl = document.getElementById('ph_stops'); if (phStopsEl) phStopsEl.textContent = totalStops || '-';

    if (!predictions || predictions.length === 0) {
      if (cards) cards.innerHTML = '<div class="text-center text-muted py-3">No predictions found for this date</div>';
      statusBadge.className = 'badge bg-secondary';
      statusBadge.textContent = 'No predictions';
      updatePredictionKPIs({});
      return;
    }
    
    // Render cards
    if (cards) {
      const html = predictions.map(p => {
        const stop = p.stop?.name || p.stop_name || 'Unknown stop';
        const message = p.message || '';
        const peak = p.peak_hour ?? p.peak ?? '-';
        const sent = !!(p.is_sent || p.sent);
        const border = sent ? 'sent border-success' : 'pending border-primary';
        const badge = sent ? '<span class="badge bg-success"><i class="bi bi-check-lg me-1"></i>Sent</span>' : '<span class="badge bg-primary"><i class="bi bi-clock me-1"></i>Pending</span>';
        return `
          <div class="col-md-6 col-lg-4">
            <div class="card h-100 prediction-card ${border}">
              <div class="card-body">
                <h6 class="card-title"><i class="bi bi-geo-alt me-1"></i>${stop}</h6>
                <p class="card-text">${message}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted"><i class="bi bi-clock me-1"></i>Peak: ${peak}:00</small>
                  ${badge}
                </div>
              </div>
            </div>
          </div>`;
      }).join('');
      cards.innerHTML = html;
    }
    
    // Update KPIs
    updatePredictionKPIs(predictions);
    
    statusBadge.className = 'badge bg-success';
    statusBadge.textContent = `Loaded ${predictions.length} predictions`;
    
  } catch (error) {
    console.error('Error loading predictions:', error);
    if (cards) {
      cards.innerHTML = `<div class="text-center text-danger py-3">Error: ${error.message}</div>`;
    }
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = 'Load failed';
  }
}

function updatePredictionKPIs(predictions) {
  const setText = (id, text) => { const el = document.getElementById(id); if (el) el.textContent = text; };
  if (!predictions || predictions.length === 0) {
    setText('kpiTotal', '0');
    setText('kpiBusiest', '-');
    setText('kpiPeak', '-');
    return;
  }
  
  // Calculate total predicted passengers
  const total = predictions.reduce((sum, pred) => sum + (predicted_passengers || 0), 0);
  setText('kpiTotal', total);
  
  // Find busiest stop
  const busiest = predictions.reduce((max, pred) => 
    pred.predicted_passengers > max.predicted_passengers ? pred : max, predictions[0]);
  setText('kpiBusiest', busiest.stop_name || busiest?.stop?.name || '-');
  
  // Find most common peak hour
  const hourCounts = {};
  predictions.forEach(pred => {
    hourCounts[pred.peak_hour] = (hourCounts[pred.peak_hour] || 0) + 1;
  });
  const peakHour = Object.keys(hourCounts).reduce((a, b) => 
    (hourCounts[a] > hourCounts[b] ? a : b));
  setText('kpiPeak', `${peakHour}:00`);
}

async function generatePredictions() {
  const date = $('#predictionDate').value || new Date().toISOString().split('T')[0];
  const statusBadge = $('#predictionStatus');
  
  statusBadge.className = 'badge bg-warning';
  statusBadge.textContent = 'Generating...';
  
  try {
    // Try multiple payload styles to match backend expectations
    const API_BASE = window.API_BASE ?? ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') && location.port !== '5000' ? 'http://localhost:5000' : '');
    const attempts = [
      { url: `${API_BASE}/api/predictions/generate`, opts: { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ date }) } },
      { url: `${API_BASE}/api/predictions/generate`, opts: { method: 'POST' } },
      { url: `${API_BASE}/api/predictions/generate?date=${encodeURIComponent(date)}`, opts: { method: 'POST' } }
    ];
    let lastErr = null;
    for (const a of attempts) {
      try {
        const resp = await fetch(a.url, a.opts);
        const text = await resp.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }
        if (!resp.ok) throw new Error(data.error || `HTTP ${resp.status}`);
        if (data && data.success === false) throw new Error(data.error || 'Generation failed');
        // Success
        const count = (data && (data.count ?? data.generated ?? 0)) || 0;
        showAlert(`Generated ${count} predictions successfully!`, 'success');
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Generated';
        await loadPredictions();
        return;
      } catch (e) {
        lastErr = e;
      }
    }
    if (lastErr) throw lastErr;
    
  } catch (error) {
    console.error('Error generating predictions:', error);
    showAlert('Failed to generate predictions: ' + error.message, 'danger');
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = 'Generation failed';
  }
}

async function sendPredictionsToDrivers() {
  const date = $('#predictionDate').value || new Date().toISOString().split('T')[0];
  const statusBadge = $('#predictionStatus');
  
  statusBadge.className = 'badge bg-warning';
  statusBadge.textContent = 'Sending...';
  
  try {
    const API_BASE = window.API_BASE ?? ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') && location.port !== '5000' ? 'http://localhost:5000' : '');
    const resp = await fetch(`${API_BASE}/api/predictions/send`, { method: 'POST' });
    const text = await resp.text();
    let result = {};
    try { result = text ? JSON.parse(text) : {}; } catch { result = { raw: text }; }
    if (!resp.ok || result.success === false) throw new Error(result.error || `HTTP ${resp.status}`);
    showAlert(`Predictions sent to drivers${result.sent ? `: ${result.sent}` : ''}.`, 'success');
    statusBadge.className = 'badge bg-success';
    statusBadge.textContent = 'Sent to drivers';
    
  } catch (error) {
    console.error('Error sending predictions:', error);
    showAlert('Failed to send predictions: ' + error.message, 'danger');
    statusBadge.className = 'badge bg-danger';
    statusBadge.textContent = 'Send failed';
  }
}
// Add these to your existing event listeners section
$('#btnReloadPredictions').addEventListener('click', loadPredictions);
$('#btnGeneratePredictions').addEventListener('click', generatePredictions);
$('#btnSendPredictions').addEventListener('click', sendPredictionsToDrivers);
$('#predictionDate').addEventListener('change', loadPredictions);
const btnSendAllPH = document.getElementById('btnSendAllPH');
if (btnSendAllPH) btnSendAllPH.addEventListener('click', sendPredictionsToDrivers);

// Initialize prediction date
$('#predictionDate').value = new Date().toISOString().split('T')[0];
// Helper function to get predictions
async function getPredictions(date) {
  try {
    const API_BASE = window.API_BASE ?? ((location.hostname === 'localhost' || location.hostname === '127.0.0.1') && location.port !== '5000' ? 'http://localhost:5000' : '');
    const response = await fetch(`${API_BASE}/api/predictions/${date}`);       if (!response.ok) return null;
    return await response.json();
  } catch (error) {
    return null;
  }
}

  function statusOptions(current) {
    const opts = ["assigned", "accepted", "enroute", "completed", "canceled"];
    return opts.map(s => `<option value="${s}" ${s === current ? "selected" : ""}>${s}</option>`).join("");
  }

  // Do not block: render schedule in background for faster ready state
  renderSchedule().catch(console.warn);
  $("#btnReloadSch").addEventListener("click", renderSchedule);
  $("#listDate").addEventListener("change", renderSchedule);

  // Event delegation for status changes
  $("#schRows").addEventListener("change", async (e) => {
    const sel = e.target.closest(".sch-status");
    if (!sel) return;
    const { id: dispatchId } = sel.dataset;
    const date = sel.dataset.date;
    try {
      await adminSetStatus({ date, dispatchId, status: sel.value });
      showAlert("Status updated.", "success");
    } catch (err) {
      showAlert("Failed to update: " + err.message, "danger");
      await renderSchedule();
    }
  });

  $("#schRows").addEventListener("click", async (e) => {
    const btn = e.target.closest(".sch-cancel");
    if (!btn) return;
    const dispatchId = btn.dataset.id;
    const date = btn.dataset.date;
    try {
      await adminSetStatus({ date, dispatchId, status: "canceled" });
      await renderSchedule();
      showAlert("Dispatch canceled.", "success");
    } catch (err) {
      showAlert("Cancel failed: " + err.message, "danger");
    }
  });

  // ===== Dispatch History =====
  let lastHistoryRows = [];
  // Local date helpers to avoid UTC drift and infinite loops
  function dateKeyLocal(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }
  function addDaysLocal(dateStr, days) {
    const [y,m,day] = dateStr.split('-').map(Number);
    const d = new Date(y, (m||1)-1, (day||1) + days);
    return dateKeyLocal(d);
  }
  function eachDateLocal(startStr, endStr) {
    const res = [];
    const [sy,sm,sd] = startStr.split('-').map(Number);
    const [ey,em,ed] = endStr.split('-').map(Number);
    const s = new Date(sy, (sm||1)-1, (sd||1));
    const e = new Date(ey, (em||1)-1, (ed||1));
    for (let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
      res.push(dateKeyLocal(d));
    }
    return res;
  }
  let isLoadingHistory = false;

  async function loadDispatchHistory() {
    if (isLoadingHistory) return;
    isLoadingHistory = true;
    const start = document.querySelector('#histStart').value;
    const end = document.querySelector('#histEnd').value;
    const sort = document.querySelector('#histSort').value || 'desc';
    const tbody = document.querySelector('#historyRows');

    if (!start || !end) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Please select start and end dates.</td></tr>';
      return;
    }

    if (start > end) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Start date must be before End date.</td></tr>';
      return;
    }

    // Limit range to avoid excessive reads (max 60 days)
    const allDates = eachDateLocal(start, end);
    if (allDates.length > 60) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Range too large. Please select up to 60 days.</td></tr>';
      isLoadingHistory = false;
      return;
    }

    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">Loading...</td></tr>';
    const exportBtn = document.querySelector('#btnExportHistory');
    const summary = document.querySelector('#histSummary');
    if (exportBtn) exportBtn.disabled = true;
    if (summary) summary.textContent = '';

    try {
      // Preload drivers for name resolution
      const driversSnap = await get(ref(db, 'drivers'));
      const drivers = driversSnap.exists() ? driversSnap.val() : {};

      const rows = [];
      for (const d of allDates) {
        const day = await listDispatches(d);
        day.forEach(rec => {
          const driverName = rec.driver_uid && drivers[rec.driver_uid]
            ? (drivers[rec.driver_uid].name || drivers[rec.driver_uid].email || rec.driver_uid.slice(0,8))
            : '(Unassigned)';
          rows.push({
            date: d,
            time: rec.dep_time || '00:00',
            route: rec.route || '',
            jeep: rec.jeep_id || '',
            driver: driverName,
            status: rec.status || 'assigned'
          });
        });
      }

      // Sort by date then time
      rows.sort((a,b) => {
        const ak = `${a.date} ${a.time}`;
        const bk = `${b.date} ${b.time}`;
        return sort === 'asc' ? ak.localeCompare(bk) : bk.localeCompare(ak);
      });

      if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No dispatches in this range.</td></tr>';
        return;
      }

      lastHistoryRows = rows;
      tbody.innerHTML = rows.map(r => `
        <tr>
          <td>${r.date}</td>
          <td>${r.time}</td>
          <td>${r.route}</td>
          <td>${r.jeep}</td>
          <td>${r.driver}</td>
          <td><span class="badge ${r.status === 'canceled' ? 'bg-secondary' : (r.status === 'completed' ? 'bg-success' : 'bg-info')}">${r.status}</span></td>
        </tr>
      `).join('');
      if (exportBtn) exportBtn.disabled = false;
      if (summary) summary.textContent = `${rows.length} dispatch(es) loaded.`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-3">Failed: ${err.message}</td></tr>`;
    } finally { isLoadingHistory = false; }
  }

  // Initialize history dates (default: last 7 days)
  const today = dateKeyLocal(new Date());
  const sevenAgo = (()=>{ const d=new Date(); d.setDate(d.getDate()-7); return dateKeyLocal(d); })();
  const histStartEl = document.querySelector('#histStart');
 
  const histEndEl = document.querySelector('#histEnd');
  if (histStartEl && !histStartEl.value) histStartEl.value = sevenAgo;
  if (histEndEl && !histEndEl.value) histEndEl.value = today;

  // History listeners
  const btnLoadHistory = document.querySelector('#btnLoadHistory');
  if (btnLoadHistory) btnLoadHistory.addEventListener('click', loadDispatchHistory);
  const histSort = document.querySelector('#histSort');
  if (histSort) histSort.addEventListener('change', loadDispatchHistory);
  if (histStartEl) histStartEl.addEventListener('change', () => { /* optional auto */ });
  if (histEndEl) histEndEl.addEventListener('change', () => { /* optional auto */ });

  // Export CSV for history
  function exportHistoryCSV() {
    if (!lastHistoryRows || !lastHistoryRows.length) { showAlert('Nothing to export.', 'info'); return; }
    const headers = ['Date','Time','Route','Jeep','Driver','Status'];
    const csv = [headers.join(',')];
    lastHistoryRows.forEach(r => {
      const row = [r.date, r.time, r.route, r.jeep, r.driver, r.status]
        .map(v => {
          const s = String(v ?? '');
          const guard = (/^[=+\-@]/.test(s)) ? "'" : "";
          return `"${(guard + s).replace(/"/g,'""')}"`;
        })
        .join(',');
      csv.push(row);
    });
    const start = document.querySelector('#histStart')?.value || '';
    const end = document.querySelector('#histEnd')?.value || '';
    downloadCSV(csv.join('\n'), `dispatch_history_${start}_to_${end}.csv`);
  }
  const btnExportHistory = document.querySelector('#btnExportHistory');
  if (btnExportHistory) btnExportHistory.addEventListener('click', exportHistoryCSV);

  // Auto-load when tab is shown
  const historyTabBtn = document.querySelector('#history-tab');
  if (historyTabBtn) {
    // Load when the tab is shown via Bootstrap
    historyTabBtn.addEventListener('shown.bs.tab', () => loadDispatchHistory());
    // Fallback: also trigger on click in case the event doesn't fire
    historyTabBtn.addEventListener('click', () => setTimeout(loadDispatchHistory, 0));
  }

  // Quick filter wiring for Drivers/Passengers tables
  function setupTableFilter(inputSel, tbodySel) {
    const input = document.querySelector(inputSel);
    const tbody = document.querySelector(tbodySel);
    if (!input || !tbody) return;
    const apply = () => {
      const q = (input.value || '').toLowerCase().trim();
      const rows = tbody.querySelectorAll('tr');
      rows.forEach(r => {
        const text = r.textContent.toLowerCase();
        r.style.display = q && !text.includes(q) ? 'none' : '';
      });
    };
    input.addEventListener('input', apply);
    return () => apply();
  }
  const refreshDriversFilter = setupTableFilter('#searchDrivers', '#rowsDrivers') || (()=>{});
  const refreshPassengersFilter = setupTableFilter('#searchPassengers', '#rowsPassengers') || (()=>{});
  // Re-apply filters after each load
  const _origLoadDriversTable = loadDriversTable;
  loadDriversTable = async function(){ await _origLoadDriversTable(); refreshDriversFilter(); };
  const _origLoadPassengersTable = loadPassengersTable;
  loadPassengersTable = async function(){ await _origLoadPassengersTable(); refreshPassengersFilter(); };

  // ===== SMS PANEL =====
  let allRecipients = [];
  let selectedPhones = new Set();

  // Load SMS balance
  async function loadSMSBalance() {
    const balanceEl = document.getElementById('smsBalance');
    if (!balanceEl) return;
    
    balanceEl.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
    
    try {
      const result = await getSMSBalance();
      balanceEl.textContent = result.balance || '0';
    } catch (error) {
      balanceEl.innerHTML = '<span class="text-danger">Error</span>';
      console.error('Failed to load SMS balance:', error);
    }
  }

  // Load recipients
  async function loadRecipients() {
    const tbody = document.getElementById('recipientsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted py-3">
      <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
      Loading recipients...
    </td></tr>`;
    
    try {
      allRecipients = await getAllRecipients();
      const roleFilter = document.querySelector('input[name="roleFilter"]:checked')?.value || 'all';
      renderRecipientsTable(allRecipients, 'recipientsTableBody', roleFilter);
      
      // Restore selected checkboxes
      selectedPhones.forEach(phone => {
        const checkbox = document.querySelector(`.recipient-checkbox[value="${phone}"]`);
        if (checkbox) checkbox.checked = true;
      });
      
      updateSelectedDisplay();
    } catch (error) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger py-3">
        Error: ${error.message}
      </td></tr>`;
    }
  }

  // Update selected recipients display
  function updateSelectedDisplay() {
    const container = document.getElementById('selectedRecipients');
    const countEl = document.getElementById('recipientCount');
    const btnSend = document.getElementById('btnSendSMS');
    
    if (!container || !countEl || !btnSend) return;
    
    countEl.textContent = selectedPhones.size;
    
    if (selectedPhones.size === 0) {
      container.innerHTML = '<small class="text-muted">No recipients selected</small>';
      btnSend.disabled = true;
      return;
    }
    
    const selectedRecipients = allRecipients.filter(r => selectedPhones.has(r.phone));
    container.innerHTML = selectedRecipients.map(r => `
      <span class="badge ${r.role === 'driver' ? 'bg-primary' : 'bg-info'}">
        ${r.name}
        <button type="button" class="btn-close btn-close-white" style="font-size: 0.6em;" 
                onclick="this.closest('.badge').remove(); document.querySelector('.recipient-checkbox[value=\\'${r.phone}\\']').checked = false; document.querySelector('.recipient-checkbox[value=\\'${r.phone}\\']').dispatchEvent(new Event('change'));">
        </button>
      </span>
    `).join('');
    
    const message = document.getElementById('smsMessage')?.value || '';
    btnSend.disabled = selectedPhones.size === 0 || message.trim().length === 0;
  }

  // Handle checkbox changes
  document.addEventListener('change', (e) => {
    if (e.target.classList.contains('recipient-checkbox')) {
      const phone = e.target.value;
      if (e.target.checked) {
        selectedPhones.add(phone);
      } else {
        selectedPhones.delete(phone);
      }
      updateSelectedDisplay();
    }
  });

  // Character counter
  const smsMessageEl = document.getElementById('smsMessage');
  if (smsMessageEl) {
    smsMessageEl.addEventListener('input', (e) => {
      const info = getSMSInfo(e.target.value);
      const charCountEl = document.getElementById('charCount');
      if (charCountEl) {
        charCountEl.textContent = `${info.characters} / ${info.maxLength}`;
        charCountEl.className = info.remaining < 20 ? 'text-danger fw-bold' : 'text-muted';
      }
      
      const btnSend = document.getElementById('btnSendSMS');
      if (btnSend) {
        btnSend.disabled = !info.isValid || selectedPhones.size === 0;
      }
    });
  }

  // Select/Deselect All
  const btnSelectAll = document.getElementById('btnSelectAll');
  if (btnSelectAll) {
    btnSelectAll.addEventListener('click', () => {
      document.querySelectorAll('.recipient-checkbox').forEach(cb => {
        cb.checked = true;
        selectedPhones.add(cb.value);
      });
      updateSelectedDisplay();
    });
  }

  const btnDeselectAll = document.getElementById('btnDeselectAll');
  if (btnDeselectAll) {
    btnDeselectAll.addEventListener('click', () => {
      document.querySelectorAll('.recipient-checkbox').forEach(cb => {
        cb.checked = false;
        selectedPhones.delete(cb.value);
      });
      updateSelectedDisplay();
    });
  }

  // Role filter
  document.querySelectorAll('input[name="roleFilter"]').forEach(radio => {
    radio.addEventListener('change', () => {
      const roleFilter = radio.value;
      renderRecipientsTable(allRecipients, 'recipientsTableBody', roleFilter);
      
      // Restore selected checkboxes
      selectedPhones.forEach(phone => {
        const checkbox = document.querySelector(`.recipient-checkbox[value="${phone}"]`);
        if (checkbox) checkbox.checked = true;
      });
    });
  });

  // Search filter
  const searchRecipientsEl = document.getElementById('searchRecipients');
  if (searchRecipientsEl) {
    searchRecipientsEl.addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#recipientsTableBody tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(query) ? '' : 'none';
      });
    });
  }

  // Refresh buttons
  const btnRefreshBalance = document.getElementById('btnRefreshBalance');
  if (btnRefreshBalance) {
    btnRefreshBalance.addEventListener('click', loadSMSBalance);
  }

  const btnRefreshRecipients = document.getElementById('btnRefreshRecipients');
  if (btnRefreshRecipients) {
    btnRefreshRecipients.addEventListener('click', loadRecipients);
  }

  // Copy from predictions
  const btnCopyFromPredictions = document.getElementById('btnCopyFromPredictions');
if (btnCopyFromPredictions) {
  btnCopyFromPredictions.addEventListener('click', async () => {
    try {
      const date = document.getElementById('predictionDate')?.value || new Date().toISOString().split('T')[0];
      
      // Fetch predictions
      const predictions = await getPredictions(date);
      
      if (!predictions || predictions.length === 0) {
        showAlert('No predictions found. Please generate predictions first in the Peak Hours tab.', 'warning');
        // Switch to predictions tab
        const predictionsTab = document.getElementById('predictions-tab');
        if (predictionsTab) predictionsTab.click();
        return;
      }
      
      // Format all predictions into SMS-friendly messages
      const messages = predictions.map((p, index) => {
        const stopName = p.stop_name || p.stop?.name || 'Unknown';
        const peakHour = p.peak_hour || p.peak || 0;
        const passengers = p.predicted_passengers || 0;
        
        // Format hour (12-hour format)
        const hour12 = peakHour === 0 ? 12 : (peakHour > 12 ? peakHour - 12 : peakHour);
        const ampm = peakHour < 12 ? 'AM' : 'PM';
        
        return `${stopName}: ${hour12}:00 ${ampm}, ${passengers} pax expected`;
      });
      
      // Take first 3-4 predictions to stay under 160 chars
      let compiledMessage = '';
      let count = 0;
      
      for (const msg of messages) {
        const testMessage = compiledMessage ? `${compiledMessage}. ${msg}` : msg;
        if (testMessage.length <= 160) {
          compiledMessage = testMessage;
          count++;
        } else {
          break;
        }
      }
      
      if (compiledMessage) {
        // Paste into SMS message field
        const smsMessageEl = document.getElementById('smsMessage');
        if (smsMessageEl) {
          smsMessageEl.value = compiledMessage;
          smsMessageEl.dispatchEvent(new Event('input')); // Trigger character counter
          
          showAlert(`Copied ${count} prediction(s) to message field (${compiledMessage.length}/160 chars)`, 'success');
          
          // Scroll to message field
          smsMessageEl.focus();
          smsMessageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      } else {
        showAlert('Could not format predictions within 160 character limit.', 'warning');
      }
      
    } catch (error) {
      console.error('Error copying predictions:', error);
      showAlert('Failed to copy predictions: ' + error.message, 'danger');
    }
  });
}

  // Send SMS form
  const formSMS = document.getElementById('formSMS');
  if (formSMS) {
    formSMS.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const message = document.getElementById('smsMessage').value.trim();
      const senderName = document.getElementById('smsSenderName').value.trim() || 'JEEPNI';
      const btnSend = document.getElementById('btnSendSMS');
      
      // Validation checks
      if (selectedPhones.size === 0) {
        showAlert('Please select at least one recipient.', 'warning');
        return;
      }
      
      if (message.length === 0) {
        showAlert('Please enter a message.', 'warning');
        return;
      }
      
      if (message.length > 160) {
        showAlert(`Message exceeds 160 characters (${message.length}/160). Please shorten your message.`, 'danger');
        return;
      }

      // Check if message starts with TEST (Semaphore silently ignores these)
      if (message.toUpperCase().startsWith('TEST')) {
        showAlert('Messages cannot start with "TEST" - Semaphore will ignore them. Please modify your message.', 'warning');
        return;
      }
      
      // Rate limiting check
      if (!smsRateLimiter.canMakeRequest()) {
        const remaining = Math.ceil(smsRateLimiter.getTimeUntilReset() / 1000);
        showAlert(`Rate limit exceeded. Please wait ${remaining} seconds before sending again.`, 'warning');
        return;
      }
      
      // Confirm before sending
      const phoneArray = Array.from(selectedPhones);
      const costEstimate = phoneArray.length;
      const confirmMsg = `Send SMS to ${phoneArray.length} recipient(s)?\n\nEstimated cost: ${costEstimate} credit(s)\nMessage: "${message.substring(0, 50)}${message.length > 50 ? '...' : ''}"`;
      
      if (!confirm(confirmMsg)) return;
      
      // Disable button and show loading
      btnSend.disabled = true;
      btnSend.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Sending...';
      
      try {
        // Record this request for rate limiting
        smsRateLimiter.recordRequest();
        
        const result = await sendSMS(phoneArray, message, senderName);
        
        if (result.success) {
          const successMsg = `SMS sent successfully!\n• Sent: ${result.successful || phoneArray.length}\n• Failed: ${result.failed || 0}\n• Total cost: ~${result.successful || phoneArray.length} credits`;
          showAlert(successMsg.replace(/\n/g, '<br>'), 'success');
          
          // Clear form
          document.getElementById('smsMessage').value = '';
          document.getElementById('charCount').textContent = '0 / 160';
          selectedPhones.clear();
          document.querySelectorAll('.recipient-checkbox').forEach(cb => cb.checked = false);
          updateSelectedDisplay();
          
          // Refresh balance
          await loadSMSBalance();
        } else {
          throw new Error(result.error || 'Failed to send SMS');
        }
        
      } catch (error) {
        console.error('SMS send error:', error);
        let errorMsg = 'Failed to send SMS: ' + error.message;
        
        // Provide helpful error messages
        if (error.message.includes('TEST')) {
          errorMsg = 'Message rejected: Cannot start with "TEST". Please modify your message.';
        } else if (error.message.includes('160')) {
          errorMsg = 'Message too long. Please limit to 160 characters.';
        } else if (error.message.includes('Invalid phone')) {
          errorMsg = 'Invalid phone number format detected. Please check recipients.';
        } else if (error.message.includes('API key')) {
          errorMsg = 'SMS service not configured. Please contact administrator.';
        }
        
        showAlert(errorMsg, 'danger');
        
      } finally {
        btnSend.disabled = false;
        btnSend.innerHTML = '<i class="bi bi-send"></i> Send SMS';
        
        // Show rate limit status
        const remaining = smsRateLimiter.getRemainingRequests();
        if (remaining < 5) {
          showAlert(`Rate limit: ${remaining} requests remaining in this minute`, 'info');
        }
      }
    });
  }

  // Auto-load when SMS tab is shown
  const smsTabBtn = document.querySelector('#tab-sms-tab');
  if (smsTabBtn) {
    smsTabBtn.addEventListener('shown.bs.tab', () => {
      loadSMSBalance();
      loadRecipients();
    });
  }
  // Quick range buttons for History
  document.querySelectorAll('[data-range]').forEach(btn => {
    btn.addEventListener('click', () => {
      const type = btn.getAttribute('data-range');
      const today = new Date();
      const fmt = (d)=> dateKeyLocal(d);
      let start, end;
      if (type === 'today') {
        start = end = fmt(today);
      } else if (type === '7') {
        const s = new Date(today); s.setDate(s.getDate()-6); start = fmt(s); end = fmt(today);
      } else if (type === '30') {
        const s = new Date(today); s.setDate(s.getDate()-29); start = fmt(s); end = fmt(today);
      } else if (type === 'month') {
        const s = new Date(today.getFullYear(), today.getMonth(), 1);
        start = fmt(s); end = fmt(today);
      }
      const a = document.getElementById('histStart');
      const b = document.getElementById('histEnd');
      if (a && b) { a.value = start; b.value = end; }
      loadDispatchHistory();
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
  // ADD THESE IMPORTS AT THE TOP
  import { db, ref, get, onValue } from "./js/authentication.js";
  import { smsRateLimiter } from './js/rate-limiter.js';

  document.title = 'JeepNi - Admin Dashboard';

  let mapLoaded = false;
  async function ensureMapLoaded() {
    if (mapLoaded) return;
    try {
      await import('./js/map-tracker.js');
      mapLoaded = true;
      setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
    } catch (error) {
      console.warn('Failed to load live map viewer', error);
      throw error;
    }
  }

  let markers = {
    drivers: new Map(),
    passengers: new Map()
  };

  const dashboardMapEl = document.getElementById('dashboardMap');
  if (dashboardMapEl) {
    ensureMapLoaded().then(() => {
      // Initialize map with Dagupan center coordinates
      const map = L.map('dashboardMap').setView([16.043, 120.333], 14);
      
      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      // Track drivers
      const driversRef = ref(db, 'drivers_location');
      onValue(driversRef, async (snap) => {
        const drivers = snap.val() || {};
        
        // Clear old markers
        markers.drivers.forEach(m => m.remove());
        markers.drivers.clear();
        
        // Add new markers
        for (const [uid, data] of Object.entries(drivers)) {
          if (!data.lat || !data.lng) continue;
          
          try {
            const driverSnap = await get(ref(db, `drivers/${uid}`));
            const driver = driverSnap.val() || {};
            
            const icon = L.divIcon({
              className: '',
              html: `<div style="font-size:24px;color:${getRouteColor(data.route)}">🚌</div>`
            });
            
            const marker = L.marker([data.lat, data.lng], {icon})
              .bindPopup(`
                <strong>${driver.name || 'Driver'}</strong><br>
                Route: ${data.route || 'Unknown'}<br>
                Status: ${data.status || 'Unknown'}
              `);
            
            marker.addTo(map);
            markers.drivers.set(uid, marker);
          } catch (err) {
            console.warn('Error loading driver details:', err);
          }
        }
      });

      // Track passengers
      const passengersRef = ref(db, 'passengers_location');
      onValue(passengersRef, (snap) => {
        const passengers = snap.val() || {};
        
        // Clear old markers
        markers.passengers.forEach(m => m.remove());
        markers.passengers.clear();
        
        // Add new markers
        Object.entries(passengers).forEach(([uid, data]) => {
          if (!data.lat || !data.lng || !data.online) return;
          
          const icon = L.divIcon({
            className: '',
            html: '<div style="font-size:24px;color:#2196F3">👤</div>'
          });
          
          const marker = L.marker([data.lat, data.lng], {icon})
            .bindPopup(`Passenger<br>Waiting: ${data.waiting || false}`);
            
          marker.addTo(map);
          markers.passengers.set(uid, marker);
        });
      });

    }).catch(console.error);
  }

  // Route color helper
  function getRouteColor(route) {
    const colors = {
      gueset: '#2196F3',    // Blue
      boquig: '#F44336',    // Red
      longos: '#4CAF50',    // Green
      binloc: '#FFC107',    // Yellow
      tondaligan: '#9C27B0' // Purple
    };
    return colors[route?.toLowerCase()] || '#757575';
  }
</script>
</body>
</html>
